;*
================================================================================

    extracted_0000.hsc, file 1 of 2

    generated by Invader 0.54.2.r4101

================================================================================
*;

(global boolean global_dialog_on 0)


(global boolean global_music_on 0)


(global long global_delay_music (* 30.000000 300.000000))


(global long global_delay_music_alt (* 30.000000 300.000000))


(global boolean x_dbg_enabled 0)


(global hud_message x_hlp_desired checkpoint_new)


(global boolean x_hlp_displaying 0)


(global real x_hfx_last_health_player0 0.000000)


(global real x_hfx_last_health_player1 0.000000)


(global string x_wpn_test_id_primary "")


(global string x_wpn_test_id_secondary "")


(global string x_wpn_id_primary_player0 "")


(global string x_wpn_id_secondary_player0 "")


(global string x_wpn_id_primary_player1 "")


(global string x_wpn_id_secondary_player1 "")


(global string x_bpk_id_player0 "")


(global object x_bpk_object_player0 none)


(global string x_bpk_id_player1 "")


(global object x_bpk_object_player1 none)


(global object x_cut_primary_player0 none)


(global object x_cut_secondary_player0 none)


(global object x_cut_primary_player1 none)


(global object x_cut_secondary_player1 none)


(global vehicle x_car_test_vehicle none)


(global string x_car_test_id "")


(global real x_car_test_max_sd 0.000000)


(global real x_car_test_max_hp 0.000000)


(global vehicle x_car_vehicle_player0 none)


(global string x_car_id_player0 "")


(global real x_car_max_sd_player0 0.000000)


(global real x_car_max_hp_player0 0.000000)


(global vehicle x_car_vehicle_player1 none)


(global string x_car_id_player1 "")


(global real x_car_max_sd_player1 0.000000)


(global real x_car_max_hp_player1 0.000000)


(global real x_vrg_last_hp_player0 0.000000)


(global real x_vrg_stun_timer_player0 0.000000)


(global real x_vrg_last_hp_player1 0.000000)


(global real x_vrg_stun_timer_player1 0.000000)


(global ai x_vmg_target none)


(global short phantom_bank_time 250)


(global object hack_find_object_return_player0 none)


(global object hack_find_object_return_player1 none)


(global real x_hog_max_health_player 80.000000)


(global real x_hog_max_shield_player 80.000000)


(global real x_hog_max_health_marine 100.000000)


(global real x_hog_max_shield_marine 50.000000)


(global long x_hog_state 0)


(global unit x_hog_rider none)


(global short bsp_index_empty 0)


(global short bsp_index_ext_lz 1)


(global short bsp_index_ext_capp 2)


(global short bsp_index_ext_cart 2)


(global short bsp_index_ext_sapp 3)


(global short bsp_index_ext_pool 4)


(global short bsp_index_ext_pit 4)


(global short bsp_index_ext_bridge 5)


(global short bsp_index_ext_ufo 4)


(global short bsp_index_ext_crash 5)


(global short bsp_index_ext_cave 6)


(global short bsp_index_ext_lid 3)


(global short bsp_index_int_sec_servers 7)


(global short bsp_index_int_shaft_a 8)


(global short bsp_index_int_shaft_b 9)


(global short bsp_index_int_shaft_c 10)


(global short bsp_index_debug_room 11)


(global short ai_vmig_bsp_index -1)


(global long b30r_lod_volumes_state 0)


(global short b30r_murder_witch_ai_idx 0)


(global vehicle insertion_pelican_1 none)


(global boolean b30r_rolled_credits 0)


(global short b30r_launch_lz 0)


(global short b30r_launch_ext 1)


(global short b30r_launch_override 2)


(global short b30r_launch_override_a 3)


(global short b30r_launch_return 4)


(global short b30r_launch_int 5)


(global short b30r_launch_exit 6)


(global short b30r_launch_free 7)


(global short mission_launch_index -1)


(global short mission_state 0)


(global boolean mission_lz_cleared 0)


(global boolean mission_security_unlocked 0)


(global short mission_init 0)


(global short mission_inserted 1)


(global short mission_cartographer_found 2)


(global short mission_cartographer_entered 3)


(global short mission_cartographer_activated 4)


(global short mission_extracted 5)


(global unit b30r_debug_room_hack_captain none)


(global real b30r_debug_room_hack_distance 0.000000)


(global boolean b30r_debug_room_captain_done 0)


(global real the_escape_fx_scale 0.000000)


(global boolean the_escape_fx_start 0)


(global boolean m_lz_sidepath 0)


(global boolean m_lz_highpath 0)


(global boolean m_lz_updater_start 0)


(global short m_lz_rescue_idx 0)


(global boolean m_lz_rescue_witch_start 0)


(global boolean m_lz_coreplaced 0)


(global short blz_init 0)


(global short blz_started 1)


(global short blz_recon_pushed 2)


(global short blz_recon_broken 3)


(global short blz_camp_tapped 4)


(global short blz_camp_pushed 5)


(global short blz_camp_broken 6)


(global short blz_core_tapped 7)


(global short blz_core_crossed 8)


(global short blz_cov_pushed 9)


(global short blz_cov_broken 10)


(global short blz_cov_dead 11)


(global short blz_finished 12)


(global short m_lz_state blz_init)


(global long m_lz_ctrl_state 0)


(global short b1_init 0)


(global short b1_triggered 1)


(global short b1_approached 2)


(global short b1_entered 3)


(global short b1_cship_flying 4)


(global short b1_cship_harassing 5)


(global short b1_leaving 6)


(global short b1_finishing 7)


(global short b1_finished 8)


(global short m_ext_beach_1_state b1_init)


(global short b1e_init 0)


(global short b1e_triggered 1)


(global short b1e_entered 2)


(global short b1e_finishing 3)


(global short b1e_finished 4)


(global short m_ext_beach_1_exit_state b1e_init)


(global real m_ext_beach_1_cship_time 0.000000)


(global boolean m_ext_beach_1_imposs_clear 0)


(global boolean m_ext_beach_1_cship_start 0)


(global boolean m_ext_beach_1_start 0)


(global boolean m_ext_beach_1_exit_start 0)


(global boolean m_ext_canyon_nook_awake 0)


(global boolean m_ext_canyon_start 0)


(global boolean m_ext_beach_2_cship_start 0)


(global boolean m_ext_cart_checkpoints_start 0)


(global boolean ext_cart_frontal_approach 0)


(global boolean ext_cart_secret_placed 0)


(global boolean m_ext_cart_updater_start 0)


(global boolean m_ext_cart_cship_idle 1)


(global boolean m_ext_cart_cship_start 0)


(global boolean m_ext_drop_hog_dropped 0)


(global vehicle m_ext_drop_pod_veh none)


(global string m_ext_drop_pod_marker none)


(global boolean m_ext_drop_secret_start 0)


(global short m_ext_hog_adventure_state 0)


(global long m_ext_ctrl_state 0)


(global short encounter_alert 0)


(global short hunters_active 1)


(global short hunters_1dead 2)


(global short hunters_2dead 3)


(global short hunters_initialized 4)


(global short player_in_hall 5)


(global short hunter_level_curr 6)


(global short hunter_level_dest 7)


(global short player_hall_prev 8)


(global long m_o_shaft_elev_statebits 0)


(global ai m_o_shaft_hunter_a none)


(global ai m_o_shaft_hunter_b none)


(global short m_o_shaft_elev_rescue_idx 0)


(global unit m_o_shaft_elev_rescue_unit none)


(global boolean m_o_shaft_elev_rescue_start 0)


(global boolean m_o_shaft_elev_automig_start 0)


(global short s_e_init 0)


(global short s_e_active 1)


(global short s_e_guards_alert 2)


(global short s_e_hunters_active 3)


(global short s_e_major_progress 4)


(global short s_e_one_hunter_dead 5)


(global short s_e_both_hunters_dead 6)


(global short s_e_finished 7)


(global short m_o_shaft_elev_state s_e_init)


(global boolean m_o_shaft_server_updater_start 0)


(global short s_init 0)


(global short s_active 1)


(global short s_sv_done 2)


(global short s_corridor 3)


(global short s_control_approached 4)


(global short s_control_reached 5)


(global short s_control_deactivated 6)


(global short s_finished 7)


(global short m_override_shaft_state s_init)


(global boolean m_override_cliffs_bowl_broken 0)


(global boolean m_override_cliffs_updater_start 0)


(global boolean m_override_pit_updater_start 0)


(global boolean m_override_bridge_updater_start 0)


(global short cl_init 0)


(global short cl_in_bsp 1)


(global short cl_at_window 2)


(global short cl_locking 3)


(global short cl_locked 4)


(global short cl_postlock 5)


(global short cl_finshed 10)


(global short m_override_cart_lock_state cl_init)


(global boolean m_override_known_locked 0)


(global long m_override_ctrl_state 0)


(global boolean return_downed_music_started 0)


(global boolean m_return_downed_music_start 0)


(global boolean return_cship_start 0)


(global boolean return_cship_leave 0)


(global boolean return_cliffs_music_started 0)


(global boolean m_return_cliffs_music_started 0)


(global boolean m_return_cliffs_canyon_start 0)


(global boolean m_return_cart_assaulting 0)


(global boolean m_return_cart_combat_begun 0)


(global boolean return_cart_hunters_start 0)


(global boolean return_cart_jackals_start 0)


(global boolean m_return_shaft_server_start 0)


(global long m_return_ctrl_state 0)


(global short cart_update_cycle_rate 7)


(global long player_pos_l 0)


(global long player_pos_r 1)


(global long player_pos_f 2)


(global long player_pos_c 3)


(global long player_pos_b 4)


(global long player_pos_u 5)


(global long player_pos_any 6)


(global long m_int_cart_pos_statebits 0)


(global real m_int_cart_checkpoint_limit 5.000000)


(global boolean m_int_cart_checkpoint_start 0)


(global short m_int_cart_gen_count 0)


(global long player_approached_bit 0)


(global long player_fled_bit 1)


(global long guards_tapped_bit 2)


(global long guards_pushed_bit 3)


(global long guards_destroyed_bit 4)


(global long catwalk_placed_bit 5)


(global long reins_l_place_bit 6)


(global long reins_l_placed_bit 7)


(global long reins_r_place_bit 8)


(global long reins_r_placed_bit 9)


(global long reins_other_triggered_bit 10)


(global long guards_broken_bit 11)


(global long ended_bit 12)


(global long gen_bit 13)


(global long m_int_cart_classic_statebits 0)


(global long m_int_cart_brute_statebits 0)


(global long m_int_cart_evolved_statebits 0)


(global long m_int_cart_classic_combat_ticks 0)


(global boolean m_int_cart_classic_start 0)


(global long m_int_cart_evolved_combat_ticks 0)


(global boolean m_int_cart_evolved_start 0)


(global long m_int_cart_brutes_combat_ticks 0)


(global boolean m_int_cart_brute_start 0)


(global long rein_l_placed_bit 0)


(global long rein_r_placed_bit 1)


(global long m_int_cart_sides_statebits 0)


(global boolean m_int_cart_sides_start 0)


(global unit m_int_cart_hunter_target none)


(global boolean m_int_cart_hunters_start 0)


(global boolean special_drop_grunts 0)


(global short special_grunt_drop_timer 45)


(global real special_intensity_scale 0.000000)


(global unit master_cheif_0 none)


(global unit master_cheif_1 none)


(global boolean m_int_cart_fuckery_start 0)


(global boolean m_int_cart_special_start 0)


(global boolean int_hallways_lroom_alerted 0)


(global boolean int_hallways_update_start 0)


(global long m_int_ctrl_state 0)


(global unit m_exit_secret_cutscene_unit none)


(global short m_exit_music_helper_timer 0)


(global boolean m_exit_music_helper_timer_on 0)


(global short exit_music_begin 0)


(global short exit_music_withperc 1)


(global short exit_music_perconly 2)


(global short exit_music_full 3)


(global short exit_music_end 4)


(global short m_exit_music_phase exit_music_begin)


(global boolean m_exit_music_helper_start 0)


(global boolean m_exit_zealot_start 0)


(global boolean m_exit_automig_start 0)


(global long m_exit_ctrl_state 0)


(script static unit player0
    (unit (list_get (players) 0))
)


(script static unit player1
    (unit (list_get (players) 1))
)


(script static short player_count
    (list_count (players))
)


(script static boolean cinematic_skip_start
    (cinematic_skip_start_internal)
    (game_save_totally_unsafe)
    (sleep_until (not (game_saving)) 1)
    (not (game_reverted))
)


(script static void cinematic_skip_stop (cinematic_skip_stop_internal))


(script static void script_dialog_start
    (sleep_until (not global_dialog_on))
    (set global_dialog_on 1)
    (ai_dialogue_triggers 0)
)


(script static void script_dialog_stop
    (ai_dialogue_triggers 1)
    (sleep 30)
    (set global_dialog_on 0)
)


(script static void player_effect_impact
    (player_effect_set_max_translation 0.050000 0.050000 0.075000)
    (player_effect_set_max_rotation 0.000000 0.000000 0.000000)
    (player_effect_set_max_vibrate 0.400000 1.000000)
    (player_effect_start (real_random_range 0.700000 0.900000) 0.100000)
)


(script static void player_effect_explosion
    (player_effect_set_max_translation 0.010000 0.010000 0.025000)
    (player_effect_set_max_rotation 0.500000 0.500000 1.000000)
    (player_effect_set_max_vibrate 0.500000 0.400000)
    (player_effect_start (real_random_range 0.700000 0.900000) 0.100000)
)


(script static void player_effect_rumble
    (player_effect_set_max_translation 0.010000 0.000000 0.020000)
    (player_effect_set_max_rotation 0.100000 0.100000 0.200000)
    (player_effect_set_max_vibrate 0.500000 0.300000)
    (player_effect_start (real_random_range 0.700000 0.900000) 0.500000)
)


(script static void player_effect_vibration
    (player_effect_set_max_translation 0.007500 0.007500 0.012500)
    (player_effect_set_max_rotation 0.010000 0.010000 0.050000)
    (player_effect_set_max_vibrate 0.200000 0.500000)
    (player_effect_start (real_random_range 0.700000 0.900000) 1.000000)
)


(script static boolean (volume_test_players_any (trigger_volume volume))
    (volume_test_objects volume (players))
)


(script static boolean (volume_test_players_all (trigger_volume volume))
    (volume_test_objects_all volume (players))
)


(script static void (teleport_players (cutscene_flag flag_player0) (cutscene_flag flag_player1))
    (object_teleport (player0) flag_player0)
    (object_teleport (player1) flag_player1)
)


(script static void (music_start (looping_sound music))
    (sound_looping_start music none 1.000000)
)


(script static void (music_alt (looping_sound music))
    (sound_looping_set_alternate music 1)
)


(script static void (music_stop (looping_sound music))
    (sound_looping_stop music)
)


(script static boolean random_chance_50
    (> 0.500000 (real_random_range 0.000000 1.000000))
)


(script static void skip_frame (sleep 1))


(script static void skip_second (sleep 30))


(script static void skip_half_second (sleep 15))


(script static void sleep_forever (sleep -1))


(script static void fade_to_white
    (fade_out 1.000000 1.000000 1.000000 30)
)


(script static void fade_from_white
    (fade_in 1.000000 1.000000 1.000000 30)
)


(script static void fade_to_black
    (fade_out 0.000000 0.000000 0.000000 30)
)


(script static void fade_from_black
    (fade_in 0.000000 0.000000 0.000000 30)
)


(script static void snap_to_black
    (fade_out 0.000000 0.000000 0.000000 0)
)


(script static unit (ai_actor (ai my_ai) (short index))
    (unit
        (list_get (ai_actors my_ai) index)
    )
)


(script static void (reduce_sound_class (string name))
    (sound_class_set_gain name 0.600000 1)
)


(script static void (increase_sound_class (string name))
    (sound_class_set_gain name 1.000000 1)
)


(script static void hack_sound_gain_hack_very_evil
    (reduce_sound_class projectile_impact)
    (reduce_sound_class projectile_detonation)
    (reduce_sound_class weapon_fire)
    (reduce_sound_class weapon_ready)
    (reduce_sound_class weapon_reload)
    (reduce_sound_class weapon_empty)
    (reduce_sound_class weapon_charge)
    (reduce_sound_class weapon_overheat)
    (reduce_sound_class weapon_idle)
    (reduce_sound_class object_impacts)
    (reduce_sound_class particle_impacts)
    (reduce_sound_class slow_particle_impacts)
    (reduce_sound_class unit_footsteps)
    (reduce_sound_class unit_dialog)
    (reduce_sound_class vehicle_collision)
    (reduce_sound_class vehicle_engine)
    (reduce_sound_class device_door)
    (reduce_sound_class device_force_field)
    (reduce_sound_class device_machinery)
    (reduce_sound_class device_nature)
    (reduce_sound_class device_computers)
    (reduce_sound_class first_person_damage)
    (reduce_sound_class scripted_effect)
    (reduce_sound_class game_event)
    (sound_class_set_gain music 0.700000 1)
    (increase_sound_class ambient_nature)
    (increase_sound_class ambient_machinery)
    (increase_sound_class ambient_computers)
    (increase_sound_class scripted_dialog_player)
    (increase_sound_class scripted_dialog_other)
    (increase_sound_class scripted_dialog_force_unspatialized)
)


(script static void (print_debug (string message))
    (if x_dbg_enabled (print message))
)


(script static void (print_debug_if (boolean condition) (string message))
    (print_if (and x_dbg_enabled condition) message)
)


(script startup x_dbg_set_devmode
    (sleep_until x_dbg_enabled)
    (set developer_mode 127)
)


(script continuous x_dbg_notify_safe_to_save
    (if
        (not x_dbg_enabled)
        (sleep -1)
    )
    (sleep_until (game_safe_to_save))
    (print_debug "x_dbg_notify_safe_to_save: game safe to save")
    (sleep_until (not (game_safe_to_save)))
    (print_debug "x_dbg_notify_safe_to_save: game not safe to save")
)


(script continuous x_dbg_notify_saving
    (sleep_until (game_saving))
    (print_debug "x_dbg_notify_saving: ...attempting to save game...")
    (sleep_until (not (game_saving)) 150)
    (print_debug_if (not (game_saving)) "x_dbg_notify_saving: game-save attempt done")
)


(script continuous x_hlp_blinker
    (print_debug "x_hlp_blinker: waiting for next cycle")
    (sleep_until (!= x_hlp_desired checkpoint_new) 1)
    (print_debug "x_hlp_blinker: new help text received")
    (show_hud_help_text 1)
    (hud_set_help_text x_hlp_desired)
    (set x_hlp_displaying 1)
    (set x_hlp_desired checkpoint_new)
    (print_debug "x_hlp_blinker: waiting for blink")
    (sleep 180)
    (enable_hud_help_flash 1)
    (sleep 120)
    (print_debug "x_hlp_blinker: done")
    (show_hud_help_text 0)
    (enable_hud_help_flash 0)
    (set x_hlp_displaying 0)
)


(script continuous x_hlp_checkpoint
    (print_debug "x_hlp_checkpoint: awaiting for clear help text & saving game")
    (sleep_until
        (and (game_saving) (not x_hlp_displaying))
        1
    )
    (print_debug "x_hlp_checkpoint: turning on checkpoint text")
    (show_hud_help_text 1)
    (hud_set_help_text checkpoint_new)
    (print_debug "x_hlp_checkpoint: awaiting first timeout")
    (sleep_until
        (not (game_saving))
        1
        30
    )
    (if
        (game_saving)
        (begin
            (print_debug "x_hlp_checkpoint: game still saving, flashing message")
            (set x_hlp_desired checkpoint_blocked)
            (sleep_until
                (not (game_saving))
                1
                300
            )
        )
    )
    (print_debug_if (not (game_saving)) "x_hlp_checkpoint: game saved, turning off message")
    (if
        (not (game_saving))
        (show_hud_help_text 0)
    )
    (print_debug "x_hlp_checkpoint: awaiting next cycle")
    (sleep_until
        (not (game_saving))
        1
        300
    )
)


(script static void (x_hfx_apply (unit my_unit) (real last_health))
    (if
        (> last_health (unit_get_health my_unit))
        (if
            (>
                (- last_health (unit_get_health my_unit))
                0.340000
            )
            (damage_object cmt\globals\_shared\damage_effects\health_damage_weak my_unit)
            (damage_object cmt\globals\_shared\damage_effects\health_damage_strong my_unit)
        )
    )
)


(script continuous x_hfx_update_player0
    (x_hfx_apply (player0) x_hfx_last_health_player0)
    (set x_hfx_last_health_player0 (unit_get_health (player0)))
)


(script continuous x_hfx_update_player1
    (x_hfx_apply (player1) x_hfx_last_health_player1)
    (set x_hfx_last_health_player1 (unit_get_health (player1)))
)


(script stub void x_wpn_test_list (print "unimplemented: x_wpn_test_list"))


(script stub string x_wpn_find_marker
    (print "unimplemented: x_wpn_find_marker")
    ""
)


(script stub void x_wpn_find_object_player0 (print "unimplemented: x_wpn_find_object_player0"))


(script stub void x_wpn_find_object_player1 (print "unimplemented: x_wpn_find_object_player1"))


(script static void x_wpn_test_reset
    (set x_wpn_test_id_primary "")
    (set x_wpn_test_id_secondary "")
)


(script static void (x_wpn_test (unit my_unit) (string weapon_id) (object_definition weapon_tag))
    (if
        (unit_has_weapon my_unit weapon_tag)
        (if
            (unit_has_weapon_readied my_unit weapon_tag)
            (set x_wpn_test_id_primary weapon_id)
            (set x_wpn_test_id_secondary weapon_id)
        )
    )
)


(script continuous x_wpn_update_player0
    (x_wpn_test_reset)
    (x_wpn_test_list (player0))
    (set x_wpn_id_primary_player0 x_wpn_test_id_primary)
    (set x_wpn_id_secondary_player0 x_wpn_test_id_secondary)
)


(script continuous x_wpn_update_player1
    (x_wpn_test_reset)
    (x_wpn_test_list (player1))
    (set x_wpn_id_primary_player1 x_wpn_test_id_primary)
    (set x_wpn_id_secondary_player1 x_wpn_test_id_secondary)
)


(script static void (x_bpk_attach (object attach_target) (object substitute) (string weapon_id))
    (if
        (!= "" weapon_id)
        (objects_attach attach_target (x_wpn_find_marker weapon_id) substitute "")
    )
)


(script static void (x_bpk_detach (object attach_target) (object substitute))
    (objects_detach attach_target substitute)
    (object_teleport substitute the_void)
)


(script continuous x_bpk_update_player0
    (if
        (!= x_wpn_id_secondary_player0 x_bpk_id_player0)
        (begin
            (x_bpk_detach (player0) x_bpk_object_player0)
            (set x_bpk_id_player0 x_wpn_id_secondary_player0)
            (set x_bpk_object_player0 (x_wpn_find_object_player0 x_bpk_id_player0))
            (x_bpk_attach (player0) x_bpk_object_player0 x_bpk_id_player0)
        )
    )
)


(script static void x_bpk_disable_player0
    (sleep -1 x_bpk_update_player0)
    (x_bpk_detach (player0) x_bpk_object_player0)
    (set x_bpk_id_player0 "")
    (set x_bpk_object_player0 none)
)


(script continuous x_bpk_update_player1
    (if
        (!= x_wpn_id_secondary_player1 x_bpk_id_player1)
        (begin
            (x_bpk_detach (player1) x_bpk_object_player1)
            (set x_bpk_id_player1 x_wpn_id_secondary_player1)
            (set x_bpk_object_player1 (x_wpn_find_object_player1 x_bpk_id_player1))
            (x_bpk_attach (player1) x_bpk_object_player1 x_bpk_id_player1)
        )
    )
)


(script static void x_bpk_disable_player1
    (sleep -1 x_bpk_update_player1)
    (x_bpk_detach (player1) x_bpk_object_player1)
    (set x_bpk_id_player1 "")
    (set x_bpk_object_player1 none)
)


(script static void (x_cut_setup (object_name cutscene_unit) (object primary) (object secondary) (string secondary_id))
    (object_create cutscene_unit)
    (objects_attach cutscene_unit "right hand" primary "")
    (objects_attach cutscene_unit (x_wpn_find_marker secondary_id) secondary "")
)


(script static void (x_cut_teardown (object_name cutscene_unit) (object primary) (object secondary))
    (objects_detach cutscene_unit primary)
    (objects_detach cutscene_unit secondary)
    (object_teleport primary the_void)
    (object_teleport secondary the_void)
    (object_destroy cutscene_unit)
)


(script static void (x_cut_setup_player0 (object_name cutscene_unit))
    (x_bpk_disable_player0)
    (set x_cut_primary_player0 (x_wpn_find_object_player0 x_wpn_id_primary_player0))
    (set x_cut_secondary_player0 (x_wpn_find_object_player0 x_wpn_id_secondary_player0))
    (x_cut_setup cutscene_unit x_cut_primary_player0 x_cut_secondary_player0 x_wpn_id_secondary_player0)
)


(script static void (x_cut_teardown_player0 (object_name cutscene_unit))
    (x_cut_teardown cutscene_unit x_cut_primary_player0 x_cut_secondary_player0)
    (set x_cut_primary_player0 none)
    (set x_cut_secondary_player0 none)
    (wake x_bpk_update_player0)
)


(script static void (x_cut_setup_player1 (object_name cutscene_unit))
    (x_bpk_disable_player1)
    (set x_cut_primary_player1 (x_wpn_find_object_player1 x_wpn_id_primary_player1))
    (set x_cut_secondary_player1 (x_wpn_find_object_player1 x_wpn_id_secondary_player1))
    (x_cut_setup cutscene_unit x_cut_primary_player1 x_cut_secondary_player1 x_wpn_id_secondary_player1)
)


(script static void (x_cut_teardown_player1 (object_name cutscene_unit))
    (x_cut_teardown cutscene_unit x_cut_primary_player1 x_cut_secondary_player1)
    (set x_cut_primary_player1 none)
    (set x_cut_secondary_player1 none)
    (wake x_bpk_update_player1)
)


(script stub void x_car_test_list (print "unimplemented: x_car_test_list"))


(script static void x_car_test_reset
    (set x_car_test_vehicle none)
    (set x_car_test_id "")
    (set x_car_test_max_sd 0.000000)
    (set x_car_test_max_hp 0.000000)
)


(script static void (x_car_test (vehicle my_vehicle) (unit my_unit) (string id) (string seat_label) (real max_shield) (real max_health))
    (if
        (vehicle_test_seat my_vehicle seat_label my_unit)
        (begin
            (set x_car_test_vehicle my_vehicle)
            (set x_car_test_id id)
            (set x_car_test_max_sd max_shield)
            (set x_car_test_max_hp max_health)
        )
    )
)


(script continuous x_car_update_player0
    (x_car_test_reset)
    (x_car_test_list (player0))
    (set x_car_vehicle_player0 x_car_test_vehicle)
    (set x_car_id_player0 x_car_test_id)
    (set x_car_max_sd_player0 x_car_test_max_sd)
    (set x_car_max_hp_player0 x_car_test_max_hp)
)


(script continuous x_car_update_player1
    (x_car_test_reset)
    (x_car_test_list (player1))
    (set x_car_vehicle_player1 x_car_test_vehicle)
    (set x_car_id_player1 x_car_test_id)
    (set x_car_max_sd_player1 x_car_test_max_sd)
    (set x_car_max_hp_player1 x_car_test_max_hp)
)


(script static real (x_vrg_tick (vehicle my_vehicle) (real max_shield) (real max_health) (real previous_health) (real current_stun_timer))
    (if
        (< 0.110000 (unit_get_health my_vehicle))
        0.000000
        (if
            (> previous_health (unit_get_health my_vehicle))
            60.000000
            (if
                (> current_stun_timer 0.000000)
                (max 0.000000 (- current_stun_timer 1.000000))
                (if
                    1
                    (begin
                        (unit_set_current_vitality
                            my_vehicle
                            (*
                                (+ (unit_get_health my_vehicle) 0.011000)
                                max_health
                            )
                            (* (unit_get_shield my_vehicle) max_shield)
                        )
                        0.000000
                    )
                    0.000000
                )
            )
        )
    )
)


(script continuous x_vrg_player0
    (if
        (!= none x_car_vehicle_player0)
        (begin
            (set
                x_vrg_stun_timer_player0
                (x_vrg_tick x_car_vehicle_player0 x_car_max_sd_player0 x_car_max_hp_player0 x_vrg_last_hp_player0 x_vrg_stun_timer_player0)
            )
            (set x_vrg_last_hp_player0 (unit_get_health x_car_vehicle_player0))
        )
    )
)


(script continuous x_vrg_player1
    (if
        (and
            (!= none x_car_vehicle_player1)
            (!= x_car_vehicle_player0 x_car_vehicle_player1)
        )
        (begin
            (set
                x_vrg_stun_timer_player1
                (x_vrg_tick x_car_vehicle_player1 x_car_max_sd_player1 x_car_max_hp_player1 x_vrg_last_hp_player1 x_vrg_stun_timer_player1)
            )
            (set x_vrg_last_hp_player1 (unit_get_health x_car_vehicle_player1))
        )
    )
)


(script stub void x_vmg_on_entry (print "unimplemented: x_vmg_on_entry"))


(script stub void x_vmg_on_exit (print "unimplemented: x_vmg_on_exit"))


(script continuous x_vmg_player0
    (if
        (and
            (!= none x_car_vehicle_player0)
            (!= none x_vmg_target)
        )
        (ai_migrate_by_unit (vehicle_riders x_car_vehicle_player0) x_vmg_target)
    )
)


(script continuous x_vmg_events_player0
    (sleep_until (!= none x_car_vehicle_player0) 1)
    (x_vmg_on_entry x_car_vehicle_player0 x_car_id_player0)
    (sleep_until (= none x_car_vehicle_player0) 1)
    (x_vmg_on_exit x_car_vehicle_player0 x_car_id_player0)
)


(script continuous x_vmg_player1
    (if
        (and
            (!= none x_car_vehicle_player1)
            (!= none x_vmg_target)
        )
        (ai_migrate_by_unit (vehicle_riders x_car_vehicle_player1) x_vmg_target)
    )
)


(script continuous x_vmg_events_player1
    (sleep_until (!= none x_car_vehicle_player1) 1)
    (x_vmg_on_entry x_car_vehicle_player1 x_car_id_player1)
    (sleep_until (= none x_car_vehicle_player1) 1)
    (x_vmg_on_exit x_car_vehicle_player1 x_car_id_player1)
)


(script static boolean game_is_easy
    (= easy (game_difficulty_get_real))
)


(script static boolean game_is_impossible
    (= impossible (game_difficulty_get_real))
)


(script static void (phantom_create_anew (object_name name) (object_name grav_name) (object_name gun_l_name) (object_name gun_r_name) (object_name troop_l_name) (object_name troop_r_name))
    (object_create_anew name)
    (object_create_anew grav_name)
    (object_create_anew gun_l_name)
    (object_create_anew gun_r_name)
    (object_create_anew troop_l_name)
    (object_create_anew troop_r_name)
    (objects_attach name gravlift grav_name "")
    (objects_attach name turret_door_left gun_l_name "")
    (objects_attach name turret_door_right gun_r_name "")
    (objects_attach name troop_door_left troop_l_name "")
    (objects_attach name troop_door_right troop_r_name "")
    (unit_set_desired_flashlight_state (unit grav_name) 0)
    (unit_close (unit grav_name))
    (unit_close (unit gun_l_name))
    (unit_close (unit gun_r_name))
    (unit_close (unit troop_l_name))
    (unit_close (unit troop_r_name))
)


(script static void (phantom_hover_and_bank (vehicle phantom))
    (vehicle_hover phantom 1)
    (custom_animation phantom cmt\vehicles\_shared\phantom\phantom cinematic-hover-bank 1)
    (sleep phantom_bank_time)
)


(script static void (evolved_test_hog (vehicle my_vehicle) (unit my_unit))
    (x_car_test my_vehicle my_unit hog_driver w-driver 0.000000 450.000000)
    (x_car_test my_vehicle my_unit hog_passenger w-passenger 0.000000 450.000000)
    (x_car_test my_vehicle my_unit hog_gunner w-gunner 0.000000 450.000000)
)


(script static void (evolved_test_rhog (vehicle my_vehicle) (unit my_unit))
    (x_car_test my_vehicle my_unit hog_driver w-driver 0.000000 450.000000)
    (x_car_test my_vehicle my_unit hog_passenger w-passenger 0.000000 450.000000)
    (x_car_test my_vehicle my_unit hog_gunner_rocket w-gunner 0.000000 450.000000)
)


(script static void (evolved_test_ghost (vehicle my_vehicle) (unit my_unit))
    (x_car_test my_vehicle my_unit ghost_driver g-driver 1.000000 200.000000)
)


(script static void (evolved_test_shade (vehicle my_vehicle) (unit my_unit))
    (x_car_test my_vehicle my_unit shade_gunner ball-gunner 1.000000 100.000000)
)


(script static void (evolved_test_wraith (vehicle my_vehicle) (unit my_unit))
    (x_car_test my_vehicle my_unit wraith_driver wraith-driver 1.000000 600.000000)
)


(script static void (x_vmg_on_entry (vehicle my_vehicle) (string id))
    (if
        (= wraith_driver id)
        (begin
            (print_debug "x_vmg_on_entry: player entered wraith, kicking out riders and resetting ai enterability")
            (vehicle_unload my_vehicle scorpion)
            (ai_vehicle_enterable_disable my_vehicle)
            (print_debug "x_vmg_on_entry: enabling friendly ai entrance")
            (ai_vehicle_enterable_team my_vehicle human)
            (ai_vehicle_enterable_distance my_vehicle 10.000000)
        )
    )
)


(script static void (x_vmg_on_exit (vehicle my_vehicle) (string id))
    (if
        (= wraith_driver id)
        (begin
            (print_debug "x_vmg_on_exit: player exited wraith, kicking out riders and resetting ai enterability")
            (vehicle_unload my_vehicle scorpion)
            (ai_vehicle_enterable_disable my_vehicle)
            (print_debug "x_vmg_on_exit: enabling hostile ai entrance")
            (ai_vehicle_enterable_team my_vehicle covenant)
            (ai_vehicle_enterable_distance my_vehicle 10.000000)
            (print_debug "x_vmg_on_exit: waiting for vehicle to be empty")
            (sleep_until
                (=
                    0
                    (list_count (vehicle_riders my_vehicle))
                )
                1
                90
            )
            (print_debug "x_vmg_on_exit: migrating riders to bsp target")
            (if
                x_dbg_enabled
                (inspect (list_count (vehicle_riders my_vehicle)))
            )
            (if
                (!= none x_vmg_target)
                (ai_migrate_by_unit (vehicle_riders my_vehicle) x_vmg_target)
            )
        )
    )
)


(script static void (x_wpn_test_list (unit my_unit))
    (x_wpn_test my_unit ar cmt\weapons\evolved\assault_rifle\assault_rifle)
    (x_wpn_test my_unit argl cmt\weapons\evolved\assault_rifle\_assault_rifle_grenade\assault_rifle_grenade)
    (x_wpn_test my_unit br cmt\weapons\evolved\battle_rifle\battle_rifle)
    (x_wpn_test my_unit bs cmt\weapons\evolved\brute_shot\brute_shot)
    (x_wpn_test my_unit cbn cmt\weapons\evolved\carbine\carbine)
    (x_wpn_test my_unit dmr cmt\weapons\evolved\dmr\dmr)
    (x_wpn_test my_unit ne cmt\weapons\evolved\needler\needler)
    (x_wpn_test my_unit hp cmt\weapons\evolved\pistol\pistol)
    (x_wpn_test my_unit shp cmt\weapons\evolved\pistol\spistol)
    (x_wpn_test my_unit pp cmt\weapons\evolved\plasma_pistol\plasma_pistol)
    (x_wpn_test my_unit pr cmt\weapons\evolved\plasma_rifle\plasma_rifle)
    (x_wpn_test my_unit rl cmt\weapons\evolved\rocket_launcher\rocket_launcher)
    (x_wpn_test my_unit sg cmt\weapons\evolved\shotgun\shotgun)
    (x_wpn_test my_unit shrd cmt\weapons\evolved\shredder\shredder)
    (x_wpn_test my_unit sr cmt\weapons\evolved\sniper_rifle\sniper_rifle)
    (x_wpn_test my_unit spkr cmt\weapons\evolved\spiker\spiker)
)


(script static string (x_wpn_find_marker (string weapon_id))
    (if
        (or
            (= ar weapon_id)
            (= argl weapon_id)
            (= br weapon_id)
            (= cbn weapon_id)
            (= dmr weapon_id)
            (= sg weapon_id)
        )
        backpack
        (if
            (or
                (= ne weapon_id)
                (= hp weapon_id)
                (= shp weapon_id)
                (= pp weapon_id)
                (= pr weapon_id)
                (= shrd weapon_id)
                (= spkr weapon_id)
            )
            holster
            (if
                (= bs weapon_id)
                backpack-bs
                (if
                    (= rl weapon_id)
                    backpack-rl
                    (if (= sr weapon_id) backpack-sr (cond)
                )
            )
        )
    )
)


(script static object (x_wpn_find_object_player0 (string weapon_id))
    (set hack_find_object_return_player0 none)
    (if
        (= ar weapon_id)
        (set hack_find_object_return_player0 backpack_0_ar)
    )
    (if
        (= argl weapon_id)
        (set hack_find_object_return_player0 backpack_0_argl)
    )
    (if
        (= br weapon_id)
        (set hack_find_object_return_player0 backpack_0_br)
    )
    (if
        (= bs weapon_id)
        (set hack_find_object_return_player0 backpack_0_bs)
    )
    (if
        (= cbn weapon_id)
        (set hack_find_object_return_player0 backpack_0_cbn)
    )
    (if
        (= dmr weapon_id)
        (set hack_find_object_return_player0 backpack_0_dmr)
    )
    (if
        (= ne weapon_id)
        (set hack_find_object_return_player0 backpack_0_ne)
    )
    (if
        (= hp weapon_id)
        (set hack_find_object_return_player0 backpack_0_hp)
    )
    (if
        (= shp weapon_id)
        (set hack_find_object_return_player0 backpack_0_shp)
    )
    (if
        (= pp weapon_id)
        (set hack_find_object_return_player0 backpack_0_pp)
    )
    (if
        (= pr weapon_id)
        (set hack_find_object_return_player0 backpack_0_pr)
    )
    (if
        (= rl weapon_id)
        (set hack_find_object_return_player0 backpack_0_rl)
    )
    (if
        (= sg weapon_id)
        (set hack_find_object_return_player0 backpack_0_sg)
    )
    (if
        (= shrd weapon_id)
        (set hack_find_object_return_player0 backpack_0_shrd)
    )
    (if
        (= sr weapon_id)
        (set hack_find_object_return_player0 backpack_0_sr)
    )
    (if
        (= spkr weapon_id)
        (set hack_find_object_return_player0 backpack_0_spkr)
    )
    hack_find_object_return_player0
)


(script static object (x_wpn_find_object_player1 (string weapon_id))
    (set hack_find_object_return_player1 none)
    (if
        (= ar weapon_id)
        (set hack_find_object_return_player1 backpack_1_ar)
    )
    (if
        (= argl weapon_id)
        (set hack_find_object_return_player1 backpack_1_argl)
    )
    (if
        (= br weapon_id)
        (set hack_find_object_return_player1 backpack_1_br)
    )
    (if
        (= bs weapon_id)
        (set hack_find_object_return_player1 backpack_1_bs)
    )
    (if
        (= cbn weapon_id)
        (set hack_find_object_return_player1 backpack_1_cbn)
    )
    (if
        (= dmr weapon_id)
        (set hack_find_object_return_player1 backpack_1_dmr)
    )
    (if
        (= ne weapon_id)
        (set hack_find_object_return_player1 backpack_1_ne)
    )
    (if
        (= hp weapon_id)
        (set hack_find_object_return_player1 backpack_1_hp)
    )
    (if
        (= shp weapon_id)
        (set hack_find_object_return_player1 backpack_1_shp)
    )
    (if
        (= pp weapon_id)
        (set hack_find_object_return_player1 backpack_1_pp)
    )
    (if
        (= pr weapon_id)
        (set hack_find_object_return_player1 backpack_1_pr)
    )
    (if
        (= rl weapon_id)
        (set hack_find_object_return_player1 backpack_1_rl)
    )
    (if
        (= sg weapon_id)
        (set hack_find_object_return_player1 backpack_1_sg)
    )
    (if
        (= shrd weapon_id)
        (set hack_find_object_return_player1 backpack_1_shrd)
    )
    (if
        (= sr weapon_id)
        (set hack_find_object_return_player1 backpack_1_sr)
    )
    (if
        (= spkr weapon_id)
        (set hack_find_object_return_player1 backpack_1_spkr)
    )
    hack_find_object_return_player1
)


(script static real x_hog_get_marine_health
    (if
        (= (game_difficulty_get_real) normal)
        x_hog_max_health_marine
        (if
            (= (game_difficulty_get_real) hard)
            (* x_hog_max_health_marine 1.200000)
            (if
                (= (game_difficulty_get_real) impossible)
                (* x_hog_max_health_marine 1.400000)
                (if
                    (= (game_difficulty_get_real) easy)
                    (* x_hog_max_health_marine 1.400000)
                    0.000000
                )
            )
        )
    )
)


(script static real x_hog_get_marine_shield
    (if
        (= (game_difficulty_get_real) normal)
        x_hog_max_shield_marine
        (if
            (= (game_difficulty_get_real) hard)
            (* x_hog_max_shield_marine 1.200000)
            (if
                (= (game_difficulty_get_real) impossible)
                (* x_hog_max_shield_marine 1.400000)
                (if
                    (= (game_difficulty_get_real) easy)
                    (* x_hog_max_shield_marine 1.400000)
                    0.000000
                )
            )
        )
    )
)


(script static long (x_hog_get_bits (long healthpack_index))
    (bitwise_and
        (bitwise_right_shift x_hog_state (* healthpack_index 2.000000))
        3
    )
)


(script static long (x_hog_get_consumed (long healthpack_index))
    (if
        (= (x_hog_get_bits healthpack_index) 3)
        2
        (if
            (= (x_hog_get_bits healthpack_index) 1)
            1
            (if 1 0 0)
        )
    )
)


(script static void (x_hog_consume (long healthpack_index))
    (if
        (= (x_hog_get_bits healthpack_index) 0)
        (set
            x_hog_state
            (bitwise_or
                x_hog_state
                (bitwise_left_shift 1 (* healthpack_index 2.000000))
            )
        )
        (if
            (= (x_hog_get_bits healthpack_index) 1)
            (set
                x_hog_state
                (bitwise_or
                    x_hog_state
                    (bitwise_left_shift 3 (* healthpack_index 2.000000))
                )
            )
        )
    )
)


(script static boolean (x_hog_rider_can_heal (vehicle hog) (short rider_index))
    (set
        x_hog_rider
        (unit
            (list_get (vehicle_riders hog) rider_index)
        )
    )
    (and
        (!= none x_hog_rider)
        (> 1.000000 (unit_get_health x_hog_rider))
    )
)


(script static void (x_hog_rider_heal (vehicle hog) (short rider_index))
    (set
        x_hog_rider
        (unit
            (list_get (vehicle_riders hog) rider_index)
        )
    )
    (if
        (or
            (= (player0) x_hog_rider)
            (= (player1) x_hog_rider)
        )
        (begin
            (unit_set_current_vitality
                x_hog_rider
                x_hog_max_health_player
                (* (unit_get_shield x_hog_rider) x_hog_max_shield_player)
            )
            (damage_object cmt\globals\_shared\damage_effects\fx_health_regen_flash x_hog_rider)
            (sound_impulse_start sound\sfx\ui\pickup_health x_hog_rider 1.000000)
        )
        (unit_set_current_vitality
            x_hog_rider
            (x_hog_get_marine_health)
            (* (unit_get_shield x_hog_rider) (x_hog_get_marine_shield))
        )
    )
)


(script static void (x_hog_test (vehicle hog) (long index))
    (if
        (!= 0 (unit_get_current_flashlight_state hog))
        (begin
            (unit_set_desired_flashlight_state hog 0)
            (if
                (and
                    (> 2 (x_hog_get_consumed index))
                    (or
                        (x_hog_rider_can_heal hog 0)
                        (x_hog_rider_can_heal hog 1)
                        (x_hog_rider_can_heal hog 2)
                    )
                )
                (begin
                    (x_hog_rider_heal hog 0)
                    (x_hog_rider_heal hog 1)
                    (x_hog_rider_heal hog 2)
                    (x_hog_consume index)
                    (if
                        (= 1 (x_hog_get_consumed index))
                        (object_set_permutation hog healthpacks healthpack_01)
                        (object_set_permutation hog healthpacks healthpack_02)
                    )
                )
                (sound_impulse_start
                    sound\sfx\ui\flag_failure
                    (list_get (vehicle_riders hog) 0)
                    1.000000
                )
            )
        )
    )
)


(script continuous x_wst_update
    (if
        (not x_dbg_enabled)
        (sleep -1)
    )
    (if
        (not (game_all_quiet))
        (begin
            (if
                (or
                    (= x_wpn_id_primary_player0 ar)
                    (= x_wpn_id_primary_player0 argl)
                )
                (set f0 (+ f0 1.000000))
            )
            (if
                (= x_wpn_id_primary_player0 br)
                (set f0 (+ f0 10000.000000))
            )
            (if
                (= x_wpn_id_primary_player0 cbn)
                (set f1 (+ f1 1.000000))
            )
            (if
                (= x_wpn_id_primary_player0 ne)
                (set f1 (+ f1 10000.000000))
            )
            (if
                (= x_wpn_id_primary_player0 hp)
                (set f2 (+ f2 1.000000))
            )
            (if
                (= x_wpn_id_primary_player0 pp)
                (set f2 (+ f2 10000.000000))
            )
            (if
                (= x_wpn_id_primary_player0 pr)
                (set f3 (+ f3 1.000000))
            )
            (if
                (= x_wpn_id_primary_player0 shrd)
                (set f3 (+ f3 10000.000000))
            )
            (if
                (= x_wpn_id_primary_player0 spkr)
                (set f4 (+ f4 1.000000))
            )
            (if
                (or
                    (= x_wpn_id_primary_player0 bs)
                    (= x_wpn_id_primary_player0 rl)
                    (= x_wpn_id_primary_player0 sg)
                    (= x_wpn_id_primary_player0 sr)
                )
                (set f4 (+ f4 10000.000000))
            )
        )
    )
)


(script static void x_wst_reset
    (set f0 0.000000)
    (set f1 0.000000)
    (set f2 0.000000)
    (set f3 0.000000)
    (set f4 0.000000)
)


(script static void (x_wst_print_low (string name) (real var))
    (print name)
    (inspect
        (-
            var
            (* (/ var 10000.000000) 10000.000000)
        )
    )
)


(script static void (x_wst_print_high (string name) (real var))
    (print name)
    (inspect (/ var 10000.000000))
)


(script static void x_wst_print
    (print --------------------)
    (print "weapon usage time (seconds):")
    (x_wst_print_low "assault rifle" f0)
    (x_wst_print_high "battle rifle" f0)
    (x_wst_print_low auto-carbine f1)
    (x_wst_print_high needler f1)
    (x_wst_print_low pistol f2)
    (x_wst_print_high "plasma pistol" f2)
    (x_wst_print_low "plasma rifle" f3)
    (x_wst_print_high shredder f3)
    (x_wst_print_low spiker f4)
    (x_wst_print_high "power weapons" f4)
)


(script static void (x_car_test_list (unit my_unit))
    (evolved_test_ghost ext_beach_1_ghost_1 my_unit)
    (evolved_test_ghost ext_beach_1_ghost_2 my_unit)
    (evolved_test_ghost ext_canyon_ghost my_unit)
    (evolved_test_ghost ext_canyon_bonus_ghost my_unit)
    (evolved_test_ghost ext_cart_bonus_ghost_1 my_unit)
    (evolved_test_ghost ext_cart_bonus_ghost_2 my_unit)
    (evolved_test_ghost ext_beach_2_ghost_1 my_unit)
    (evolved_test_ghost ext_beach_2_ghost_2 my_unit)
    (evolved_test_ghost ext_beach_2_bonus_ghost my_unit)
    (evolved_test_ghost ext_lid_bonus_ghost_1 my_unit)
    (evolved_test_ghost ext_cave_bonus_ghost_1 my_unit)
    (evolved_test_ghost ext_cave_bonus_ghost_2 my_unit)
    (evolved_test_hog ext_drop_hog my_unit)
    (evolved_test_hog override_cliffs_dump_hog my_unit)
    (evolved_test_hog return_downed_dump_hog my_unit)
    (evolved_test_rhog ext_drop_rhog my_unit)
    (evolved_test_shade lz_turret_high my_unit)
    (evolved_test_shade lz_turret_low my_unit)
    (evolved_test_shade ext_beach_1_turret_camp my_unit)
    (evolved_test_shade ext_beach_1_turret_far my_unit)
    (evolved_test_shade ext_beach_1_exit_turret_1 my_unit)
    (evolved_test_shade ext_beach_1_exit_turret_2 my_unit)
    (evolved_test_shade return_cart_turret_left my_unit)
    (evolved_test_shade return_cart_turret_right my_unit)
    (evolved_test_shade ext_cart_turret_front my_unit)
    (evolved_test_shade sec_turret_low my_unit)
    (evolved_test_shade sec_turret_high my_unit)
    (evolved_test_shade bridge_turret_1 my_unit)
    (evolved_test_shade return_downed_turret my_unit)
    (evolved_test_shade ext_cave_turret_1 my_unit)
    (evolved_test_shade return_cliffs_turret my_unit)
    (evolved_test_wraith coolmode_wraith my_unit)
    (evolved_test_wraith return_cart_wraith_1 my_unit)
    (evolved_test_wraith return_cart_wraith_2 my_unit)
    (evolved_test_wraith return_downed_wraith my_unit)
    (evolved_test_wraith return_beach_2_wraith my_unit)
)


(script continuous b30_revamp_hog_tests
    (x_hog_test ext_drop_hog 0)
    (x_hog_test override_cliffs_dump_hog 1)
    (x_hog_test return_downed_dump_hog 2)
    (x_hog_test ext_drop_rhog 3)
)


(script continuous ai_vmig_bsp
    (print_debug "ai_vmig_bsp: awaiting bsp change")
    (sleep_until
        (!= ai_vmig_bsp_index (structure_bsp_index))
        1
    )
    (print_debug "ai_vmig_bsp: bsp changed, initializing migration")
    (if
        x_dbg_enabled
        (begin
            (inspect (structure_bsp_index))
            (inspect ai_vmig_bsp_index)
        )
    )
    (print_debug "ai_vmig_bsp: (skipping frame to allow ai reconnection)")
    (skip_frame)
    (print_debug "ai_vmig_bsp: updating migration targets for new bsp")
    (set ai_vmig_bsp_index (structure_bsp_index))
    (if
        (= ai_vmig_bsp_index bsp_index_ext_lz)
        (begin
            (print_debug "ai_vmig_bsp: updating marine target for bsp_index_ext_lz")
            (set x_vmg_target marines_ext_lz-capp/a)
        )
        (if
            (= ai_vmig_bsp_index bsp_index_ext_cart)
            (begin
                (print_debug "ai_vmig_bsp: updating marine target for bsp_index_ext_cart")
                (set x_vmg_target marines_ext_capp-cart/a)
                (print_debug "ai_vmig_bsp: updating wraith encounters for bsp_index_ext_cart")
                (ai_vehicle_encounter return_downed_wraith r_downed_wrth_ext_capp-cart/a)
                (ai_vehicle_encounter return_beach_2_wraith r_beach_2_wrth_ext_capp-cart/a)
            )
            (if
                (= ai_vmig_bsp_index bsp_index_ext_sapp)
                (begin
                    (print_debug "ai_vmig_bsp: updating marine target for bsp_index_ext_sapp")
                    (set x_vmg_target marines_ext_cart-sapp/a)
                    (print_debug "ai_vmig_bsp: updating wraith encounters for bsp_index_ext_sapp")
                    (ai_vehicle_encounter return_downed_wraith r_downed_wrth_ext_cart-sapp/a)
                    (ai_vehicle_encounter return_beach_2_wraith r_beach_2_wrth_ext_cart-sapp/a)
                )
                (if
                    (= ai_vmig_bsp_index bsp_index_ext_pool)
                    (begin
                        (print_debug "ai_vmig_bsp: updating marine target for bsp_index_ext_sapp")
                        (set x_vmg_target marines_ext_sapp-sec/a)
                    )
                    (if
                        (= ai_vmig_bsp_index bsp_index_ext_bridge)
                        (begin
                            (print_debug "ai_vmig_bsp: updating marine target for bsp_index_ext_bridge")
                            (set x_vmg_target marines_ext_sec-cave/a)
                            (print_debug "ai_vmig_bsp: updating wraith encounters for bsp_index_ext_bridge")
                            (ai_vehicle_encounter return_downed_wraith r_downed_wrth_ext_sec-cave/a)
                            (ai_vehicle_encounter return_beach_2_wraith r_beach_2_wrth_ext_sec-cave/a)
                        )
                        (if
                            (= ai_vmig_bsp_index bsp_index_ext_cave)
                            (begin
                                (print_debug "ai_vmig_bsp: updating marine target for bsp_index_ext_cave")
                                (set x_vmg_target marines_ext_cave/a)
                                (print_debug "ai_vmig_bsp: updating wraith encounters for bsp_index_ext_cave")
                                (ai_vehicle_encounter return_downed_wraith r_downed_wrth_ext_cave/a)
                                (ai_vehicle_encounter return_beach_2_wraith r_beach_2_wrth_ext_cave/a)
                            )
                            (if
                                (= ai_vmig_bsp_index bsp_index_int_shaft_a)
                                (begin
                                    (print_debug "ai_vmig_bsp: updating marine target for bsp_index_int_shaft_a")
                                    (set x_vmg_target marines_int_shaft_a/a)
                                )
                            )
                        )
                    )
                )
            )
        )
    )
    (print_debug "ai_vmig_bsp: reconnecting ai")
    (skip_frame)
    (ai_reconnect)
)


(script static void (setup_ai_vmig_target (ai target))
    (ai_follow_target_players target)
    (ai_follow_distance target 3.000000)
    (ai_automatic_migration_target target 1)
)


(script startup b30r_mission_ai_vmig_startup
    (print_debug b30r_mission_ai_vmig_startup)
    (print_debug "b30r_mission_ai_vmig_startup: setting up marine migration targets")
    (setup_ai_vmig_target marines_ext_lz-capp)
    (setup_ai_vmig_target marines_ext_capp-cart)
    (setup_ai_vmig_target marines_ext_cart-sapp)
    (setup_ai_vmig_target marines_ext_sapp-sec)
    (setup_ai_vmig_target marines_ext_sec-cave)
    (setup_ai_vmig_target marines_ext_cave)
    (setup_ai_vmig_target marines_int_shaft_a)
)


(script continuous thumpers
    (device_set_position_immediate 3_lodvol_override_shaft_elev 0.000000)
    (device_set_position 3_lodvol_override_shaft_elev 1.000000)
    (sleep (random_range 180 600))
    (device_set_position_immediate 4_lodvol_override_shaft_elev 0.000000)
    (device_set_position 4_lodvol_override_shaft_elev 1.000000)
    (sleep (random_range 180 600))
    (device_set_position_immediate 5_lodvol_override_shaft_elev 0.000000)
    (device_set_position 5_lodvol_override_shaft_elev 1.000000)
    (sleep (random_range 180 600))
)


(script continuous set_pit_elev_sync
    (sleep_until (volume_test_players_any override_pit_elevator_top))
    (device_group_set position_ext_sec_pit_elevator 1.000000)
    (sleep_until (volume_test_players_any override_pit_left))
    (device_group_set position_ext_sec_pit_elevator 0.000000)
)


(script startup int_cart_unlock_classic
    (sleep_until
        (= 1.000000 (device_group_get power_int_shaft_c_gen_classc))
    )
    (device_one_sided_set int_shaft_c_classic_door_inner 0)
    (device_one_sided_set int_shaft_c_classic_door_outer 0)
    (device_group_change_only_once_more_set hack_int_shaft_c_doors_c_i 1)
    (device_group_change_only_once_more_set hack_int_shaft_c_doors_c_o 1)
    (device_group_set hack_int_shaft_c_doors_c_i 1.000000)
    (device_group_set hack_int_shaft_c_doors_c_o 1.000000)
)


(script startup int_cart_unlock_evolved
    (sleep_until
        (= 1.000000 (device_group_get power_int_shaft_c_gen_evolve))
    )
    (device_one_sided_set int_shaft_c_evolved_door_inner 0)
    (device_one_sided_set int_shaft_c_evolved_door_outer 0)
    (device_group_change_only_once_more_set hack_int_shaft_c_doors_e_i 1)
    (device_group_change_only_once_more_set hack_int_shaft_c_doors_e_o 1)
    (device_group_set hack_int_shaft_c_doors_e_i 1.000000)
    (device_group_set hack_int_shaft_c_doors_e_o 1.000000)
)


(script startup int_cart_unlock_brute
    (sleep_until
        (= 1.000000 (device_group_get power_int_shaft_c_gen_brute))
    )
    (device_one_sided_set int_shaft_c_brute_door_l_inner 0)
    (device_one_sided_set int_shaft_c_brute_door_l_outer 0)
    (device_one_sided_set int_shaft_c_brute_door_r_inner 0)
    (device_one_sided_set int_shaft_c_brute_door_r_outer 0)
    (device_group_change_only_once_more_set hack_int_shaft_c_doors_b_l_i 1)
    (device_group_change_only_once_more_set hack_int_shaft_c_doors_b_l_o 1)
    (device_group_change_only_once_more_set hack_int_shaft_c_doors_b_r_i 1)
    (device_group_change_only_once_more_set hack_int_shaft_c_doors_b_r_o 1)
    (device_group_set hack_int_shaft_c_doors_b_l_i 1.000000)
    (device_group_set hack_int_shaft_c_doors_b_l_o 1.000000)
    (device_group_set hack_int_shaft_c_doors_b_r_i 1.000000)
    (device_group_set hack_int_shaft_c_doors_b_r_o 1.000000)
)


(script continuous int_cart_holo_ring
    (device_group_set
        power_cartographer
        (/
            (+
                (device_group_get power_int_shaft_c_gen_brute)
                (device_group_get power_int_shaft_c_gen_evolve)
                (device_group_get power_int_shaft_c_gen_classc)
            )
            3.000000
        )
    )
    (if
        (and
            (= 1.000000 (device_group_get power_cartographer))
            (= 0.000000 (device_group_get hack_int_shaft_c_holo_ring))
        )
        (begin
            (device_group_set hack_int_shaft_c_holo_ring 1.000000)
            (device_set_position int_shaft_c_holo_glows 1.000000)
        )
    )
    (object_set_shield int_shaft_c_holo_ring (device_group_get position_ext_sec_security_holo))
)


(script startup fish
    (sleep_until (= bsp_index_int_shaft_b (structure_bsp_index)))
    (ai_place fish)
    (ai_disregard (ai_actors fish) 1)
)


(script continuous fish2
    (sleep_until (= bsp_index_int_shaft_c (structure_bsp_index)))
    (ai_place fish2)
    (ai_disregard (ai_actors fish2) 1)
    (sleep_until (!= bsp_index_int_shaft_c (structure_bsp_index)))
    (ai_erase fish2)
)


(script startup shaft_a_elev
    (sleep_until
        (= 1.000000 (device_group_get power_cartographer))
        1
    )
    (object_destroy int_shaft_a_elevator)
    (object_create int_shaft_a_elevator_fast)
    (device_group_set_immediate position_int_shaft_a_elevator 0.000000)
    (device_group_set_immediate position_int_shaft_a_elevator 1.000000)
)


(script static void (b30r_lod_volumes_check (trigger_volume volume) (string name_containing) (long state_index))
    (if
        (volume_test_players_any volume)
        (if
            (!= (bit_test b30r_lod_volumes_state state_index) 1)
            (begin
                (object_create_containing name_containing)
                (set b30r_lod_volumes_state (bit_toggle b30r_lod_volumes_state state_index 1))
            )
        )
        (if
            (= (bit_test b30r_lod_volumes_state state_index) 1)
            (begin
                (object_destroy_containing name_containing)
                (set b30r_lod_volumes_state (bit_toggle b30r_lod_volumes_state state_index 0))
            )
        )
    )
)


(script continuous b30r_lod_volumes
    (if
        (= bsp_index_ext_crash (structure_bsp_index))
        (if
            (!= (bit_test b30r_lod_volumes_state 1) 1)
            (begin
                (object_create_containing "holy shit")
                (set b30r_lod_volumes_state (bit_toggle b30r_lod_volumes_state 1 1))
            )
        )
        (if
            (= (bit_test b30r_lod_volumes_state 1) 1)
            (begin
                (object_destroy_containing "holy shit")
                (set b30r_lod_volumes_state (bit_toggle b30r_lod_volumes_state 1 0))
            )
        )
    )
    (b30r_lod_volumes_check lodvol_lz lodvol_lz 2)
    (b30r_lod_volumes_check lodvol_ext_beach_1 lodvol_ext_beach_1 3)
    (b30r_lod_volumes_check lodvol_ext_canyon lodvol_ext_canyon 4)
    (b30r_lod_volumes_check lodvol_ext_cart lodvol_ext_cart 5)
    (b30r_lod_volumes_check lodvol_override_cliffs_falls lodvol_override_cliffs_falls 6)
    (b30r_lod_volumes_check lodvol_override_cliffs_dmp lodvol_override_cliffs_dmp 7)
    (b30r_lod_volumes_check lodvol_override_pool lodvol_override_pool 8)
    (b30r_lod_volumes_check lodvol_return_falls lodvol_return_falls 9)
    (b30r_lod_volumes_check lodvol_override_shaft_elev lodvol_override_shaft_elev 10)
    (b30r_lod_volumes_check lodvol_int_hallways_water lodvol_int_hallways_water 11)
    (b30r_lod_volumes_check lodvol_int_hallways_cat lodvol_int_hallways_cat 12)
    (b30r_lod_volumes_check lodvol_int_hallways_lob lodvol_int_hallways_lob 13)
    (b30r_lod_volumes_check lodvol_int_hallways_mid lodvol_int_hallways_mid 14)
    (b30r_lod_volumes_check lodvol_cart lodvol_cart 15)
)


(script static void b30r_lod_volumes_disable
    (object_create_containing lodvol_lz)
    (object_create_containing lodvol_ext_beach_1)
    (object_create_containing lodvol_ext_canyon)
    (object_create_containing lodvol_override_cliffs_falls)
    (object_create_containing lodvol_override_cliffs_dmp)
    (object_create_containing lodvol_override_pool)
    (object_create_containing lodvol_return_falls)
    (object_create_containing lodvol_override_shaft_elev)
    (object_create_containing lodvol_int_hallways_water)
    (object_create_containing lodvol_int_hallways_cat)
    (object_create_containing lodvol_int_hallways_lob)
    (object_create_containing lodvol_int_hallways_mid)
    (object_create_containing lodvol_cart)
)


(script static void (b30r_murder_witch_unit_test (unit my_unit))
    (if
        (if
            (>= (structure_bsp_index) bsp_index_int_shaft_a)
            (or
                (volume_test_object int_shaft_a_death my_unit)
                (volume_test_object int_shaft_b_elev_death my_unit)
            )
            (or
                (volume_test_object ext_a_cart_elev_death my_unit)
                (volume_test_object ext_a_lz_elev_death my_unit)
                (volume_test_object ext_b_underwater_death my_unit)
                (volume_test_object ext_b_cliff_death my_unit)
                (volume_test_object ext_b_cliff_nub_death my_unit)
                (volume_test_object ext_c_cliff_death my_unit)
                (volume_test_object ext_c_pit_elev_death my_unit)
                (volume_test_object ext_c_ufo_elev_death my_unit)
                (volume_test_object ext_e_cave_death my_unit)
                (volume_test_object ext_e_cave_nub_death my_unit)
                (volume_test_object ext_c_cliff_side_death my_unit)
                (volume_test_object ext_e_cave_pool_death my_unit)
            )
        )
        (unit_kill my_unit)
    )
)


(script static void (b30r_murder_witch_check_ai (ai my_ai))
    (set b30r_murder_witch_ai_idx 0)
    (sleep_until
        (begin
            (b30r_murder_witch_unit_test (ai_actor my_ai b30r_murder_witch_ai_idx))
            (set b30r_murder_witch_ai_idx (+ 1.000000 b30r_murder_witch_ai_idx))
            (>= b30r_murder_witch_ai_idx (ai_living_count my_ai))
        )
        1
    )
)


(script continuous b30r_murder_witch
    (b30r_murder_witch_check_ai ext_beach_2)
    (b30r_murder_witch_check_ai return_beach_2)
    (b30r_murder_witch_check_ai marines_ext_cart-sapp)
    (b30r_murder_witch_check_ai r_downed_wrth_ext_cart-sapp)
    (b30r_murder_witch_check_ai r_beach_2_wrth_ext_cart-sapp)
    (b30r_murder_witch_unit_test (player0))
    (b30r_murder_witch_unit_test (player1))
    (sleep 5)
)


(script continuous phantom_of_the_map_helper
    (sleep -1)
    (fade_in 0.666000 0.000000 0.000000 75)
    (cinematic_screen_effect_start 1)
    (cinematic_screen_effect_set_convolution 1 2 15.000000 0.000000 2.500000)
    (sound_impulse_start cmt\sounds\sfx\scenarios\b30_revamp\ambience\sounds\detail_howls_low none 1.000000)
    (sleep 75)
    (cinematic_screen_effect_stop)
)


(script static void phantom_of_the_map (wake phantom_of_the_map_helper))


(script static boolean (b30r_secret_teleport (object_definition weapon_tag) (cutscene_flag destination))
    (if
        (or
            (unit_has_weapon (player0) weapon_tag)
            (unit_has_weapon (player1) weapon_tag)
        )
        (begin
            (teleport_players destination destination)
            (phantom_of_the_map)
            (skip_frame)
            (effect_new_on_object_marker cmt\scenarios\singleplayer\b30_revamp\effects\secret_teleport (player0) body)
            (effect_new_on_object_marker cmt\scenarios\singleplayer\b30_revamp\effects\secret_teleport (player1) body)
            1
        )
        0
    )
)


(script continuous b30r_secret_teleport_brute_shot
    (if
        (b30r_secret_teleport cmt\weapons\evolved\_egg\brute_shot_super\brute_shot_super secret_bruteshot_teleport)
        (sleep_forever)
        (sleep 30)
    )
)


(script continuous b30r_secret_teleport_dmr
    (if
        (b30r_secret_teleport cmt\weapons\evolved\_egg\dmr_super\dmr_super secret_dmr_teleport)
        (sleep_forever)
        (sleep 30)
    )
)


(script continuous b30r_fun_preserver
    (if
        (not (game_is_easy))
        (sleep -1)
    )
    (if
        (or debug_ice_cream_flavor_status_bandanna cheat_infinite_ammo)
        (begin
            (set debug_ice_cream_flavor_status_bandanna 0)
            (set cheat_infinite_ammo 0)
            (sound_impulse_start cmt\sounds\sfx\ui\misc\cheater none 1.000000)
        )
    )
)


(script continuous safety_first
    (if
        (not (game_is_easy))
        (sleep -1)
    )
    (sleep_until
        (or
            (= x_car_id_player0 hog_gunner_rocket)
            (= x_car_id_player1 hog_gunner_rocket)
        )
    )
    (if
        (= x_car_id_player0 hog_gunner_rocket)
        (unit_exit_vehicle (player0))
    )
    (if
        (= x_car_id_player1 hog_gunner_rocket)
        (unit_exit_vehicle (player1))
    )
)


(script startup m_int_hallways_shh
    (sleep_until (volume_test_players_any lroom_secret_smartass))
    (object_create secret_shredder)
)


(script startup ho_ho_ho
    (sleep_until (volume_test_players_any ho_ho_ho))
    (if
        (game_is_impossible)
        (begin
            (object_create secret_jingle_music)
            (object_create secret_jingle_grunt_1)
            (object_create secret_jingle_grunt_2)
            (ai_attach secret_jingle_grunt_1 jingle)
            (ai_attach secret_jingle_grunt_2 jingle)
            (ai_braindead jingle 1)
            (ai_command_list jingle jingle_jump)
        )
    )
)


(script continuous beware_of_rift
    (sleep_until
        (and (game_saving) (volume_test_players_any rift))
        1
    )
    (game_save_cancel)
    (sleep_until
        (not (volume_test_players_any rift))
        1
    )
    (game_save_no_timeout)
)


(script startup b30r_main
    (snap_to_black)
    (player_enable_input 0)
    (skip_frame)
    (b30r_mission_startup)
    (hack_sound_gain_hack_very_evil)
)


(script static void (objective_set (hud_message menu_message) (hud_message help_message))
    (hud_set_objective_text menu_message)
    (set x_hlp_desired help_message)
)


(script dormant hog_help_text
    (sleep_until
        (or
            (= x_car_id_player0 hog_driver)
            (= x_car_id_player1 hog_driver)
        )
    )
    (set x_hlp_desired help_hog)
)


(script static void create_insertion_pelican_1
    (set
        insertion_pelican_1
        (if
            (game_is_easy)
            (begin (object_create_anew insertion_pelican_comedy_1) insertion_pelican_comedy_1)
            (if
                mission_lz_cleared
                (begin (object_create_anew insertion_pelican_dust_1) insertion_pelican_dust_1)
                (begin (object_create_anew insertion_pelican_nodust_1) insertion_pelican_nodust_1)
            )
        )
    )
)


(script static void create_ext_beach_1_cship
    (phantom_create_anew ext_beach_1_cship ext_beach_1_cship_grav ext_beach_1_cship_gun_l ext_beach_1_cship_gun_r ext_beach_1_cship_troop_l ext_beach_1_cship_troop_r)
)


(script static void create_ext_cart_cship
    (phantom_create_anew ext_cart_cship ext_cart_cship_grav ext_cart_cship_gun_l ext_cart_cship_gun_r ext_cart_cship_troop_l ext_cart_cship_troop_r)
)


(script static void create_override_cliffs_cship
    (phantom_create_anew override_cliffs_cship override_cliffs_cship_grav override_cliffs_cship_gun_l override_cliffs_cship_gun_r override_cliffs_cship_troop_l override_cliffs_cship_troop_r)
)


(script dormant magic
    (sleep_until
        (and
            (= bsp_index_ext_lid (structure_bsp_index))
            (volume_test_players_any ext_beach_2_dumb)
            (< (ai_living_count ext_beach_2) 1)
        )
    )
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_02_warthog_adventure)
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_03_cart_found)
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_04_lockout)
    (object_create_anew magic_pelican)
    (object_create_anew magic_drop_pod)
    (object_create_anew secret_pistol)
    (objects_attach magic_drop_pod gun secret_pistol "")
    (objects_attach magic_pelican droppodl01 magic_drop_pod attach)
    (object_teleport magic_pelican magic_start)
    (recording_play_and_delete magic_pelican magic_pelican_rise)
    (skip_second)
    (effect_new cmt\scenarios\singleplayer\b30_revamp\effects\magic magic_water)
    (sound_looping_start cmt\sounds\music\scenarios\b30_revamp\egg\magic\magic none 1.000000)
    (sleep_until
        (< (recording_time magic_pelican) 530)
    )
    (effect_new_on_object_marker cmt\scenery\_shared\h_drop_pod\effects\h_drop_pod_detach magic_pelican droppodl01)
    (objects_detach magic_pelican magic_drop_pod)
    (sleep 90)
    (objects_detach magic_drop_pod secret_pistol)
    (sleep 90)
    (player_effect_explosion)
    (sound_impulse_start cmt\sounds\sfx\vehicles\human\_shared\fx\human_explosion_large none 1.000000)
    (effect_new_on_object_marker cmt\scenarios\singleplayer\b30_revamp\effects\magic_2 magic_pelican "crouch rider")
    (object_destroy magic_pelican)
    (player_effect_stop 2.000000)
    (sound_looping_stop cmt\sounds\music\scenarios\b30_revamp\egg\magic\magic)
    (sleep -1 trial_of_the_pistol_conditions)
    (sleep -1 trial_of_the_pistol)
    (game_save_no_timeout)
)


(script dormant trial_of_the_pistol_conditions
    (sound_impulse_start cmt\sounds\dialog\scenarios\b30_revamp\cheif\mc_started none 1.000000)
    (object_create_containing secret_h1)
    (sleep_until
        (and
            (<= (unit_get_health secret_h1_1) 0.000000)
            (<= (unit_get_health secret_h1_2) 0.000000)
            (<= (unit_get_health secret_h1_3) 0.000000)
        )
    )
    (wake magic)
)


(script static boolean trial_of_the_pistol_is_ready
    (and
        (unit_has_weapon_readied (player0) cmt\weapons\evolved\pistol\pistol)
        (or
            (not (game_is_cooperative))
            (unit_has_weapon_readied (player1) cmt\weapons\evolved\pistol\pistol)
        )
    )
)


(script dormant trial_of_the_pistol
    (sleep_until
        (and
            (game_is_impossible)
            (>= mission_state mission_inserted)
        )
    )
    (sleep 100)
    (if
        (trial_of_the_pistol_is_ready)
        (wake trial_of_the_pistol_conditions)
        (sleep_forever)
    )
    (sleep_until
        (or
            (!= none x_car_vehicle_player0)
            (!= none x_car_vehicle_player1)
            (not (trial_of_the_pistol_is_ready))
        )
    )
    (if
        (or
            (< 0.000000 (unit_get_health (player0)))
            (< 0.000000 (unit_get_health (player1)))
        )
        (sound_impulse_start cmt\sounds\dialog\scenarios\b30_revamp\cheif\mc_bad none 1.000000)
    )
    (object_destroy_containing secret_h1)
    (sleep -1 trial_of_the_pistol_conditions)
    (sleep -1 magic)
)


(script dormant b30r_life_help_text
    (sleep 30000)
    (objective_set dia_life help_life)
)


(script continuous _
    (sleep_until (game_is_easy) 1)
    (sleep_until (game_saving) 1)
    (sleep_until (not (game_saving)) 1)
    (sound_impulse_start sound\sfx\ui\countdown_timer_end none 1.000000)
)


(script static void b30r_mission_easy_setup
    (objects_delete_by_definition cmt\weapons\evolved\assault_rifle\assault_rifle)
    (objects_delete_by_definition cmt\weapons\evolved\pistol\pistol)
    (objects_delete_by_definition cmt\weapons\evolved\shotgun\shotgun)
    (objects_delete_by_definition cmt\weapons\evolved\brute_shot\brute_shot)
    (objects_delete_by_definition cmt\weapons\evolved\needler\needler)
    (objects_delete_by_definition cmt\weapons\evolved\plasma_rifle\plasma_rifle)
    (objects_delete_by_definition cmt\weapons\evolved\plasma_pistol\plasma_pistol)
    (objects_delete_by_definition cmt\weapons\evolved\shredder\shredder)
    (objects_delete_by_definition cmt\weapons\evolved\spiker\spiker)
    (object_destroy_containing secret)
    (object_create_anew_containing easy)
    (sleep -1 x_hlp_checkpoint)
    (wake _)
    (object_create grimdome)
    (wake b30r_life_help_text)
)


(script dormant b30r_credits_titles
    (cinematic_set_title credits_tsce_title)
    (sleep 30)
    (cinematic_set_title credits_tsce_core_title)
    (sleep 30)
    (cinematic_set_title credits_tsce_core_lag)
    (sleep 180)
    (cinematic_set_title credits_tsce_core_dafi)
    (sleep 180)
    (cinematic_set_title credits_tsce_core_silicon)
    (sleep 30)
    (cinematic_set_title credits_tsce_core_bob_llama)
    (sleep 180)
    (cinematic_set_title credits_tsce_additional_title)
    (sleep 30)
    (cinematic_set_title credits_tsce_additional_1)
    (cinematic_set_title credits_tsce_additional_2)
    (sleep 210)
    (cinematic_set_title credits_tsce_additional_3)
    (cinematic_set_title credits_tsce_additional_4)
    (sleep 210)
    (cinematic_set_title credits_1_4_title)
    (sleep 60)
    (cinematic_set_title credits_1_4_core_team)
    (sleep 30)
    (cinematic_set_title credits_1_4_thanks)
    (sleep 30)
    (cinematic_set_title credits_1_4_testing)
    (sleep 180)
    (cinematic_set_title credits_mcc_title)
    (sleep 60)
    (cinematic_set_title credits_mcc_core_team)
    (sleep 30)
    (cinematic_set_title credits_mcc_thanks)
    (sleep 30)
    (cinematic_set_title credits_mcc_testing)
    (sleep 180)
    (cinematic_set_title credits_cmt_title)
    (sleep 30)
    (cinematic_set_title credits_cmt_1)
    (cinematic_set_title credits_cmt_2)
    (sleep 210)
    (cinematic_set_title credits_cmt_3)
    (cinematic_set_title credits_cmt_4)
    (cinematic_set_title credits_cmt_5)
    (sleep 210)
    (cinematic_set_title credits_developers)
    (sleep 300)
    (cinematic_set_title credits_spv2_title)
    (sleep 90)
    (cinematic_set_title credits_spv2_1)
    (cinematic_set_title credits_spv2_2)
    (sleep 210)
)


(script dormant b30r_credits_cutscene
    (show_hud 1)
    (player_enable_input 1)
    (snap_to_black)
    (sleep 150)
    (camera_control 1)
    (cinematic_start)
    (cinematic_show_letterbox 0)
    (switch_bsp bsp_index_ext_lz)
    (camera_set credits_lz_a 0)
    (camera_set credits_lz_b 30)
    (skip_second)
    (camera_set credits_lz_a 0)
    (object_pvs_set_camera credits_lz_b)
    (b30r_lod_volumes_disable)
    (object_destroy_containing hog)
    (object_destroy_containing ghost)
    (object_destroy_containing wraith)
    (object_destroy_containing secret)
    (music_start cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_21_credits)
    (sleep 300)
    (fade_in 0.000000 0.000000 0.000000 150)
    (sleep 120)
    (wake b30r_credits_titles)
    (sleep 30)
    (camera_set credits_lz_b 480)
    (sleep 350)
    (camera_set credits_lz_c 300)
    (sleep 240)
    (fade_to_white)
    (skip_second)
    (switch_bsp bsp_index_ext_pool)
    (camera_set credits_pool_a 0)
    (object_pvs_set_camera credits_pool_b)
    (camera_set credits_pool_b 330)
    (skip_second)
    (fade_from_white)
    (sleep 185)
    (camera_set credits_pool_c 300)
    (sleep 240)
    (fade_to_black)
    (skip_second)
    (switch_bsp bsp_index_ext_cave)
    (camera_set credits_cave_a 0)
    (object_pvs_set_camera credits_cave_a)
    (camera_set credits_cave_b 370)
    (skip_second)
    (fade_from_black)
    (sleep 240)
    (fade_to_white)
    (skip_second)
    (camera_set credits_hunter_a 0)
    (skip_second)
    (fade_from_white)
    (camera_set credits_hunter_b 400)
    (sleep 185)
    (fade_out 0.180000 0.260000 0.240000 30)
    (skip_second)
    (switch_bsp bsp_index_int_shaft_b)
    (camera_set credits_waterhall_a 0)
    (object_pvs_set_camera credits_waterhall_a)
    (camera_set credits_waterhall_b 240)
    (skip_second)
    (fade_in 0.180000 0.260000 0.240000 30)
    (sleep 210)
    (fade_to_black)
    (skip_second)
    (switch_bsp bsp_index_int_shaft_c)
    (camera_set credits_maproom_a 0)
    (object_pvs_set_object int_shaft_c_holo_ring)
    (camera_set credits_maproom_b 300)
    (skip_second)
    (fade_from_black)
    (sleep 170)
    (camera_set credits_maproom_c 300)
    (sleep 170)
    (fade_to_white)
    (skip_second)
    (switch_bsp bsp_index_ext_cart)
    (camera_set credits_field_a 0)
    (camera_set credits_field_b 300)
    (object_pvs_clear)
    (skip_second)
    (fade_from_white)
    (sleep 360)
    (fade_out 0.000000 0.000000 0.000000 150)
    (sleep 150)
    (if
        (game_is_impossible)
        (begin
            (music_start cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_22_teaser)
            (skip_second)
            (switch_bsp bsp_index_int_shaft_c)
            (object_create_anew the_silent_battle_rifle)
            (object_teleport the_silent_battle_rifle tease_item)
            (camera_set cutscene_tease_1a 0)
            (camera_set cutscene_tease_1b 345)
            (sleep 120)
            (fade_from_black)
            (sleep 210)
            (snap_to_black)
            (object_destroy the_silent_battle_rifle)
            (sleep 150)
        )
    )
    (sound_class_set_gain ambient_nature 0.000000 0)
    (sound_class_set_gain ambient_machinery 0.000000 0)
    (cinematic_stop)
    (set b30r_rolled_credits 1)
)


(script static void b30r_roll_credits (wake b30r_credits_cutscene))


(script static void (checkpoint_launch (short bsp_index) (cutscene_flag spawn_player0) (cutscene_flag spawn_player1))
    (switch_bsp bsp_index)
    (teleport_players spawn_player0 spawn_player1)
    (cinematic_show_letterbox 1)
    (skip_second)
    (game_save_no_timeout)
    (player_enable_input 1)
    (if
        (= easy (game_difficulty_get_real))
        (begin
            (player_add_equipment (player0) checkpoint_easy 1)
            (player_add_equipment (player1) checkpoint_easy 1)
        )
        (begin
            (player_add_equipment (player0) checkpoint 1)
            (player_add_equipment (player1) checkpoint 1)
        )
    )
    (cinematic_show_letterbox 0)
    (fade_from_white)
)


(script static boolean test_secret_command
    (player_enable_input 1)
    (sleep_until (volume_test_players_any debug_room_entry_test) 1 15)
    (player_enable_input 0)
    (volume_test_players_any debug_room_entry_test)
)


(script dormant b30r_mission_detour_control
    (if
        (or
            (<= mission_launch_index b30r_launch_override)
            (<= mission_launch_index b30r_launch_override_a)
        )
        (m_override_startup)
        (m_override_mark_skip)
    )
    (sleep_until mission_security_unlocked 1)
    (if
        (<= mission_launch_index b30r_launch_return)
        (m_return_startup)
        (m_return_mark_skip)
    )
    (m_ext_mark_return)
    (m_override_mark_return)
)


(script dormant b30r_mission_control
    (if
        (or
            (!= 0 developer_mode)
            (test_secret_command)
        )
        (b30r_debug_room)
        (set mission_launch_index b30r_launch_lz)
    )
    (if
        (<= mission_launch_index b30r_launch_lz)
        (m_lz_startup)
        (m_lz_mark_skip)
    )
    (sleep_until (>= mission_state mission_inserted) 1)
    (if
        (<= mission_launch_index b30r_launch_ext)
        (m_ext_startup)
        (m_ext_mark_skip)
    )
    (sleep_until (>= mission_state mission_cartographer_found) 1)
    (m_lz_cleanup)
    (wake b30r_mission_detour_control)
    (skip_frame)
    (if
        (<= mission_launch_index b30r_launch_int)
        (m_int_startup)
        (m_int_mark_skip)
    )
    (sleep_until (>= mission_state mission_cartographer_entered) 1)
    (if mission_security_unlocked (m_override_cleanup))
    (sleep_until (>= mission_state mission_cartographer_activated) 1)
    (if
        (<= mission_launch_index b30r_launch_exit)
        (m_exit_startup)
        (m_exit_mark_skip)
    )
    (m_ext_cleanup)
    (m_int_cleanup)
    (sleep -1 b30r_mission_detour_control)
    (m_override_cleanup)
    (m_return_cleanup)
    (sleep_until (>= mission_state mission_extracted) 1)
    (m_exit_cleanup)
    (if
        (>= mission_launch_index b30r_launch_free)
        (begin
            (object_create_anew ext_drop_hog)
            (object_teleport ext_drop_hog m_free_hogspawn)
            (checkpoint_launch bsp_index_ext_lz m_free_spawn_0 m_free_spawn_1)
            (ai_erase_all)
            (object_destroy_containing cart_return_block)
            (object_destroy_containing return_cliffs_barrier)
            (object_create_containing coolmode)
            (sleep_forever)
        )
        (begin
            (b30r_roll_credits)
            (sleep_until b30r_rolled_credits 1)
        )
    )
    (switch_bsp 0)
    (teleport_players the_void the_void)
    (sleep 30)
    (sound_enable 0)
    (camera_control 0)
    (cinematic_set_title debug_room_hint)
    (sleep_until
        (begin
            (if
                (test_secret_command)
                (begin (sound_enable 1) (map_reset))
            )
            0
        )
        1
        540
    )
    (sound_enable 1)
    (game_won)
)


(script static void b30r_mission_startup
    (ai_allegiance player human)
    (ai_allegiance sentinel human)
    (ai_allegiance player unused6)
    (ai_allegiance human unused6)
    (ai_allegiance covenant unused6)
    (ai_allegiance covenant flood)
    (ai_allegiance human flood)
    (wake b30r_mission_control)
    (wake hog_help_text)
    (wake trial_of_the_pistol)
    (if (game_is_easy) (b30r_mission_easy_setup))
)


(script continuous b30r_debug_room_launch_select
    (if
        (<= 1.000000 (device_get_position launch_switch_lz))
        (set mission_launch_index b30r_launch_lz)
        (if
            (<= 1.000000 (device_get_position launch_switch_ext))
            (set mission_launch_index b30r_launch_ext)
            (if
                (<= 1.000000 (device_get_position launch_switch_override))
                (set mission_launch_index b30r_launch_override)
                (if
                    (<= 1.000000 (device_get_position launch_switch_override_a))
                    (set mission_launch_index b30r_launch_override_a)
                    (if
                        (<= 1.000000 (device_get_position launch_switch_return))
                        (set mission_launch_index b30r_launch_return)
                        (if
                            (<= 1.000000 (device_get_position launch_switch_int))
                            (set mission_launch_index b30r_launch_int)
                            (if
                                (<= 1.000000 (device_get_position launch_switch_exit))
                                (set mission_launch_index b30r_launch_exit)
                                (if
                                    (<= 1.000000 (device_get_position launch_switch_free))
                                    (set mission_launch_index b30r_launch_free)
                                )
                            )
                        )
                    )
                )
            )
        )
    )
)


(script dormant b30r_debug_room_turret_control
    (sleep_until
        (= 1.000000 (device_get_position debug_turret))
        1
    )
    (object_set_permutation debug_turret "" ~damaged)
)


(script static void (b30r_debug_room_captain_line (sound line))
    (sleep_until
        (begin
            (set
                b30r_debug_room_hack_distance
                (objects_distance_to_object (players) b30r_debug_room_hack_captain)
            )
            (and
                (!= none b30r_debug_room_hack_captain)
                (> 0.850000 b30r_debug_room_hack_distance)
                (< 0.000000 b30r_debug_room_hack_distance)
            )
        )
    )
    (sound_impulse_start line b30r_debug_room_hack_captain 1.000000)
    (sleep 180)
)


(script dormant b30r_debug_room_captain
    (set
        b30r_debug_room_hack_captain
        (unit
            (list_get (ai_actors debug_room/captain) 0)
        )
    )
    (objects_attach b30r_debug_room_hack_captain pipe_in_hand the_captain_pipe "")
    (b30r_debug_room_captain_line sound\dialog\x20\keyes01)
    (begin_random
        (b30r_debug_room_captain_line sound\dialog\x10\keyes04)
        (b30r_debug_room_captain_line sound\dialog\x20\keyes02)
        (b30r_debug_room_captain_line sound\dialog\x20\keyes02b)
        (b30r_debug_room_captain_line sound\dialog\x20\keyes12b)
        (b30r_debug_room_captain_line sound\dialog\x20\keyes14)
    )
    (set b30r_debug_room_captain_done 1)
    (sleep_until
        (begin (b30r_debug_room_captain_line cmt\sounds\dialog\characters\human\captain\death_quiet) 0)
    )
)


(script continuous the_escape_fx
    (sleep_until the_escape_fx_start 1)
    (set
        the_escape_fx_scale
        (max
            the_escape_fx_scale
            (-
                1.000000
                (/
                    (objects_distance_to_flag (players) debug_room_bonus_flash)
                    115.000000
                )
            )
        )
    )
    (sound_looping_set_scale cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_15b_cart_arena_easymode the_escape_fx_scale)
    (sound_looping_set_scale
        cmt\sounds\music\scenarios\b30_revamp\egg\escape\escape_begin
        (max 0.000000 (- the_escape_fx_scale 0.200000))
    )
    (cinematic_screen_effect_set_convolution
        1
        2
        0.000000
        (*
            (max 0.000000 (- the_escape_fx_scale 0.300000))
            15.000000
        )
        0.000000
    )
)


(script dormant the_escape
    (sound_looping_start cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_15b_cart_arena_easymode none 0.000000)
    (ai_place escape_h1)
    (set the_escape_fx_start 1)
    (sleep_until (< 0.300000 the_escape_fx_scale))
    (cinematic_screen_effect_start 1)
    (sound_looping_start cmt\sounds\music\scenarios\b30_revamp\egg\escape\escape_begin none 0.000000)
    (sleep_until (< 0.900000 the_escape_fx_scale))
    (effect_new cmt\scenarios\singleplayer\b30_revamp\effects\debug_room_bonus_flash debug_room_bonus_flash)
    (sound_impulse_start cmt\sounds\sfx\scenery\covenant\c_holo_projector\fx\c_holo_projector_out none 1.000000)
    (sleep 5)
    (fade_out 1.000000 1.000000 1.000000 10)
    (sleep 10)
    (player_enable_input 0)
    (sleep -1 the_escape_fx)
    (sleep 1)
    (object_teleport (player0) debug_room_bonus_teleport)
    (object_destroy grimdome)
    (object_create threshold)
    (physics_set_gravity 0.000000)
    (cinematic_screen_effect_stop)
    (sound_looping_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_15b_cart_arena_easymode)
    (sound_looping_set_scale cmt\sounds\music\scenarios\b30_revamp\egg\escape\escape_begin 1.000000)
    (sleep 1)
    (fade_in 1.000000 1.000000 1.000000 0)
    (player_effect_explosion)
    (player_effect_stop 12.000000)
    (device_set_position escape 1.000000)
    (object_set_scale halo 0.010000 3300)
    (sleep 300)
    (sound_looping_stop cmt\sounds\music\scenarios\b30_revamp\egg\escape\escape_begin)
    (sleep 90)
    (sound_impulse_start cmt\sounds\music\h1\ambience\escape_throb none 1.000000)
    (sleep 150)
    (sound_looping_start cmt\sounds\music\scenarios\b30_revamp\egg\escape\escape_end none 1.000000)
    (sleep 1460)
    (object_create oblivion)
    (device_set_position oblivion 1.000000)
    (sleep 2100)
    (fade_out 1.000000 1.000000 1.000000 300)
    (sound_looping_stop cmt\sounds\music\scenarios\b30_revamp\egg\escape\escape_end)
)


(script dormant the_escape_entry
    (if
        (or
            (not (game_is_easy))
            (game_is_cooperative)
        )
        (sleep -1)
    )
    (sleep_until b30r_debug_room_captain_done)
    (object_destroy debug_room_door)
    (object_create debug_room_door_unlocked)
    (ai_attach debug_cheif debug_room/debug_watchers)
    (ai_attach debug_elite debug_room/debug_watchers)
    (ai_command_list_by_unit debug_cheif escape_debug_cheif_exit)
    (ai_command_list_by_unit debug_elite escape_debug_elite_exit)
    (sleep 240)
    (ai_erase debug_room/debug_watchers)
    (sleep_until (volume_test_objects debug_room_bonus_threshold (players)))
    (wake the_escape)
    (object_destroy debug_room_door_unlocked)
    (object_create debug_room_door)
)


(script dormant the_escape_debug
    (object_teleport (player0) debug_room_bonus_debug)
    (wake the_escape)
)


(script static void b30r_debug_room
    (switch_bsp bsp_index_debug_room)
    (teleport_players debug_room_spawn_0 debug_room_spawn_1)
    (sleep 1)
    (ai_set_blind debug_room 1)
    (ai_set_deaf debug_room 1)
    (wake b30r_debug_room_turret_control)
    (wake b30r_debug_room_captain)
    (wake the_escape_entry)
    (skip_second)
    (player_enable_input 1)
    (fade_from_black)
    (sleep_until (< -1 mission_launch_index) 1)
    (fade_to_black)
    (sleep -1 the_escape_entry)
    (sleep -1 b30r_debug_room_captain)
    (sleep -1 b30r_debug_room_turret_control)
    (sleep -1 b30r_debug_room_launch_select)
    (sleep 30)
    (player_enable_input 0)
)


(script dormant m_lz_cutscene_insertion_rocket
    (sound_impulse_start cmt\sounds\sfx\weapons\human\rocket_launcher\fx\rocket_launcher_rocket_fire none 1.000000)
    (sleep 25)
    (recording_kill lz_wraith)
    (object_destroy lz_wraith)
    (object_create_containing lz_wraith_d)
    (object_create lz_wraith_cover)
    (effect_new_on_object_marker cmt\vehicles\evolved\wraith\effects\wraith_body_depleted lz_wraith_cover "")
    (ai_erase lz_marines/rocket_marine)
    (set m_lz_rescue_witch_start 1)
    (damage_object "cmt\effects\shared effects\damage_effects\large explosion shockwave" (player0))
    (damage_object "cmt\effects\shared effects\damage_effects\large explosion shockwave" (player1))
    (sound_impulse_start cmt\sounds\sfx\vehicles\covenant\_shared\fx\covenant_explosion_large insertion_pelican_nodust_2 1.000000)
)


(script dormant m_lz_cutscene_insertion
    (cinematic_show_letterbox 1)
    (skip_second)
    (teleport_players insertion_cutscene_player insertion_cutscene_player)
    (if
        (game_is_easy)
        (begin
            (player_add_equipment (player0) lz_easy_player0 1)
            (player_add_equipment (player1) lz_easy_player1 1)
        )
        (begin
            (player_add_equipment (player0) lz 1)
            (player_add_equipment (player1) lz 1)
        )
    )
    (skip_frame)
    (skip_frame)
    (if
        (game_is_easy)
        (begin
            (ai_place lz_marines/left_marines_easy)
            (ai_place lz_marines/right_marines_easy)
            (ai_migrate lz_marines/left_marines_easy lz_marines/left_marines)
            (ai_migrate lz_marines/right_marines_easy lz_marines/right_marines)
        )
        (begin
            (ai_place lz_marines/left_marines)
            (ai_place lz_marines/right_marines)
        )
    )
    (ai_place lz_marines/rocket_marine)
    (ai_braindead lz_marines 1)
    (skip_frame)
    (create_insertion_pelican_1)
    (object_create_anew insertion_pelican_nodust_2)
    (object_create_anew insertion_pelican_nodust_3)
    (unit_enter_vehicle (player0) insertion_pelican_1 p-riderlf)
    (unit_enter_vehicle (player1) insertion_pelican_1 p-riderrf)
    (vehicle_load_magic insertion_pelican_1 rider (ai_actors lz_marines/left_marines))
    (vehicle_load_magic insertion_pelican_nodust_2 rider (ai_actors lz_marines/right_marines))
    (vehicle_load_magic insertion_pelican_nodust_2 p-ridercrouch (ai_actors lz_marines/rocket_marine))
    (skip_frame)
    (objects_attach insertion_pelican_nodust_3 cargo override_cliffs_dump_hog "")
    (ai_place lz/recon_brutes)
    (ai_place lz/recon_grunts)
    (skip_frame)
    (ai_place lz/lower_camp_elites)
    (ai_place lz/lower_camp_jackals)
    (ai_place lz/lower_camp_grunts)
    (skip_frame)
    (ai_place lz/mid_camp_elites)
    (ai_place lz/mid_camp_grunts)
    (ai_place lz/mid_camp_jackals)
    (skip_frame)
    (ai_place lz/high_camp_grunts)
    (ai_place lz/turret_gunner_high)
    (skip_frame)
    (if
        (game_is_easy)
        (begin
            (ai_erase lz/recon_brutes)
            (ai_place lz/easy)
            (ai_migrate lz/lower_camp_grunts_easy lz/lower_camp_grunts)
            (ai_migrate lz/mid_camp_grunts_easy lz/mid_camp_grunts)
            (ai_migrate lz/high_camp_grunts_easy lz/high_camp_grunts)
            (object_create lz_wraith_easy)
            (vehicle_load_magic lz_wraith_easy wraith-driver (ai_actors lz/wraith_pilot_easy))
        )
    )
    (if (game_is_impossible) (ai_place lz/core_zealot))
    (if
        (not (game_is_easy))
        (ai_place lz/turret_gunner_low)
    )
    (object_cannot_take_damage (ai_actors lz/turret_gunner_high))
    (object_cannot_take_damage (ai_actors lz/turret_gunner_low))
    (sound_looping_start cmt\sounds\sfx\scenarios\b30_revamp\foley\b30r_insertion_foley none 1.000000)
    (sleep 85)
    (player_effect_rumble)
    (sleep 5)
    (object_teleport insertion_pelican_1 insertion_cutscene_p1)
    (object_teleport insertion_pelican_nodust_2 insertion_cutscene_p2)
    (object_teleport insertion_pelican_nodust_3 insertion_cutscene_p3)
    (recording_play_and_hover insertion_pelican_1 insertion_pelican_1_in)
    (recording_play_and_hover insertion_pelican_nodust_2 insertion_pelican_2_in)
    (recording_play_and_delete insertion_pelican_nodust_3 insertion_pelican_3_in)
    (sleep 60)
    (music_start cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_01_insertion)
    (player_effect_stop 2.000000)
    (camera_set cutscene_insertion_1b 30)
    (sleep 3)
    (camera_set cutscene_insertion_1c 30)
    (sleep 15)
    (camera_set cutscene_insertion_1a 90)
    (sleep 140)
    (camera_set_relative cutscene_insertion_r1 0 insertion_pelican_1)
    (sleep 140)
    (object_teleport insertion_pelican_nodust_3 insertion_cutscene_p3_tp)
    (camera_set cutscene_insertion_2a 0)
    (if
        (game_is_easy)
        (cinematic_set_title insertion_special)
        (cinematic_set_title insertion)
    )
    (sleep 35)
    (object_create lz_wraith)
    (ai_place lz/wraith_pilot)
    (vehicle_load_magic lz_wraith wraith-driver (ai_actors lz/wraith_pilot))
    (if
        (game_is_easy)
        (ai_conversation lz_intro_special)
        (ai_conversation lz_intro)
    )
    (skip_half_second)
    (camera_set cutscene_insertion_2b 130)
    (sleep 150)
    (camera_set_relative cutscene_insertion_r2 0 insertion_pelican_1)
    (ai_command_list lz_marines/left_marines lz_peli_looking)
    (sleep 90)
    (camera_set_relative cutscene_insertion_r3 0 insertion_pelican_nodust_2)
    (ai_command_list lz_marines/right_marines lz_peli_looking)
    (ai_command_list lz_marines/rocket_marine lz_peli_looking_2)
    (sleep 40)
    (ai_vehicle_encounter lz_turret_high lz/turret_gunner_high)
    (ai_vehicle_encounter lz_turret_high lz/turret_gunner_low)
    (ai_go_to_vehicle lz/turret_gunner_high lz_turret_high gunner)
    (ai_go_to_vehicle lz/turret_gunner_low lz_turret_low gunner)
    (recording_play lz_wraith lz_wraith_fire)
    (sleep 50)
    (ai_try_to_fight lz_marines lz/recon_brutes)
    (camera_set cutscene_insertion_3a 0)
    (sleep 20)
    (camera_set cutscene_insertion_3b 140)
    (sleep 40)
    (camera_set cutscene_insertion_3c 140)
    (sleep 20)
    (fade_to_white)
    (skip_second)
    (camera_control 0)
    (fade_from_white)
    (cinematic_stop)
    (cinematic_show_letterbox 1)
    (player_enable_input 0)
    (ai_conversation lz_approaching)
    (sleep 40)
    (if
        (game_is_cooperative)
        (begin
            (wake m_lz_cutscene_insertion_rocket)
            (object_teleport insertion_pelican_nodust_2 insertion_cutscene_p2_end)
            (vehicle_hover insertion_pelican_nodust_2 1)
        )
    )
    (sleep 105)
    (ai_command_list lz/recon_brutes lz_cov_recon_leader)
    (ai_command_list lz/recon_grunts lz_cov_recon)
    (ai_migrate lz/recon_grunts lz/recon_combat)
    (ai_migrate lz/recon_brutes lz/recon_combat)
    (ai_attack lz/recon)
    (if
        (not (game_is_cooperative))
        (begin
            (wake m_lz_cutscene_insertion_rocket)
            (object_teleport insertion_pelican_nodust_2 insertion_cutscene_p2_end)
            (vehicle_hover insertion_pelican_nodust_2 1)
        )
    )
    (sleep 45)
    (object_create_containing spray)
    (ai_conversation lz_touchdown)
    (sleep 55)
    (vehicle_unload insertion_pelican_1 rider)
    (vehicle_unload insertion_pelican_nodust_2 rider)
    (unit_set_enterable_by_player insertion_pelican_1 0)
    (unit_set_enterable_by_player insertion_pelican_nodust_2 0)
    (ai_braindead lz_marines 0)
    (ai_command_list_advance lz_marines)
    (skip_frame)
    (ai_command_list lz_marines move_forwards)
    (if
        (not (game_is_easy))
        (object_create_containing lz_dump)
    )
    (object_create_containing lz_elev_dump)
    (object_create_anew override_cliffs_dump_hog)
    (object_can_take_damage (ai_actors lz))
    (skip_half_second)
    (set mission_state mission_inserted)
    (player_enable_input 1)
    (player_add_equipment (player0) grenades 0)
    (player_add_equipment (player1) grenades 0)
    (sleep 60)
    (cinematic_show_letterbox 0)
    (show_hud 1)
    (game_save_totally_unsafe)
    (skip_frame)
    (ai_try_to_fight_nothing lz_marines)
    (sleep 45)
    (vehicle_hover insertion_pelican_1 0)
    (recording_play_and_delete insertion_pelican_1 insertion_pelican_1_out)
    (skip_second)
    (vehicle_hover insertion_pelican_nodust_2 0)
    (recording_play_and_delete insertion_pelican_nodust_2 insertion_pelican_2_out)
)


(script continuous m_lz_updater
    (sleep_until m_lz_updater_start 1)
    (if
        (or
            (volume_test_players_any lz_beach_side)
            (volume_test_players_any lz_beach_side_main)
        )
        (begin
            (set m_lz_sidepath 1)
            (set m_lz_highpath 0)
        )
        (if
            (or
                (volume_test_players_all lz_beach_high)
                (volume_test_players_all lz_beach_high_main)
            )
            (begin
                (set m_lz_highpath 1)
                (set m_lz_sidepath 0)
            )
        )
    )
    (sleep 15)
)


(script continuous m_lz_rescue_witch
    (sleep_until m_lz_rescue_witch_start 1)
    (if
        (>= m_lz_rescue_idx (ai_living_count lz))
        (sleep -1)
    )
    (if
        (volume_test_object lz_wraith_danger (ai_actor lz m_lz_rescue_idx))
        (object_teleport (ai_actor lz m_lz_rescue_idx) lz_wraith_yoink)
    )
    (set m_lz_rescue_idx (+ 1.000000 m_lz_rescue_idx))
)


(script dormant m_lz_combat
    (set m_lz_state blz_started)
    (objective_set dia_lz obj_lz)
    (ai_vehicle_enterable_team lz_turret_low covenant)
    (ai_vehicle_enterable_distance lz_turret_low 2.000000)
    (ai_grenades 0)
    (sleep_until
        (or
            (volume_test_players_any lz_beach_initcombat)
            (< (ai_living_fraction lz/recon) 0.500000)
        )
        5
    )
    (set m_lz_state blz_recon_pushed)
    (ai_defend lz/recon)
    (set m_lz_updater_start 1)
    (sleep_until
        (or
            m_lz_sidepath
            m_lz_highpath
            (< (ai_living_count lz/recon) 2)
        )
        5
    )
    (set m_lz_state blz_recon_broken)
    (ai_grenades 1)
    (ai_retreat lz/recon)
    (ai_attack lz/camp_low)
    (ai_migrate_and_speak lz_marines/left lz_marines/left_marines_rocks advance)
    (ai_migrate_and_speak lz_marines/right lz_marines/right_marines_rocks advance)
    (ai_renew lz_marines)
    (sleep_until
        (or
            (volume_test_players_any lz_beach_main)
            (< (ai_living_count lz/camp_low) 4)
            (< (ai_living_count lz/camp) 5)
        )
        5
    )
    (set m_lz_state blz_camp_tapped)
    (game_save_no_timeout)
    (if
        m_lz_sidepath
        (ai_migrate lz/camp lz/camp_low_again)
        (ai_migrate lz/camp_low lz/high_camp_grunts)
    )
    (if
        (random_chance_50)
        (begin
            (ai_place lz/snipers_high)
            (ai_command_list lz/snipers_high lz_sniper_high)
        )
        (begin
            (ai_place lz/snipers_low)
            (ai_command_list lz/snipers_low lz_sniper_low)
        )
    )
    (ai_vehicle_enterable_team lz_turret_high covenant)
    (ai_vehicle_enterable_distance lz_turret_high 1.000000)
    (ai_renew lz_marines)
    (sleep_until
        (or
            (volume_test_players_any lz_beach_main)
            (and
                (< (ai_living_count lz/camp) 4)
                (< (ai_living_count lz/camp_low) 4)
                (< (ai_living_count lz/core) 4)
            )
        )
        5
    )
    (set m_lz_state blz_camp_pushed)
    (ai_migrate lz_marines/left lz_marines/left_marines_assault)
    (ai_renew lz_marines)
    (ai_command_list lz_marines/right right_marines_charge)
    (if
        (and
            m_lz_sidepath
            (< (ai_living_count lz/camp_low) 5)
            (< (ai_living_count lz/core) 5)
        )
        (begin
            (set m_lz_coreplaced 1)
            (ai_place lz/core_elites)
            (ai_place lz/core_grunts)
            (ai_migrate lz/core_elites lz/camp_low_again)
            (ai_migrate lz/core_grunts lz/camp_low_again)
            (ai_attack lz/core)
            (ai_attack lz/camp_low_again)
        )
        (begin
            (ai_migrate lz/camp_low_again lz/core_cleanup)
            (ai_migrate lz/camp_low lz/high_camp_grunts)
        )
    )
    (ai_defend lz/camp)
    (ai_renew lz_marines)
    (sleep_until
        (or
            (volume_test_players_any lz_beach_main)
            (volume_test_players_any lz_beach_threshold)
            (and
                (< (ai_living_count lz/camp) 4)
                (< (ai_living_count lz/camp_low) 3)
                (< (ai_living_count lz/core) 3)
            )
        )
        5
    )
    (set m_lz_state blz_camp_broken)
    (ai_migrate lz_marines/left lz_marines/left_marines_advance)
    (ai_migrate lz_marines/right lz_marines/right_marines_assault)
    (ai_renew lz_marines)
    (ai_retreat lz/camp)
    (ai_migrate lz/mid_camp_jackals lz/core_cleanup)
    (if
        (not m_lz_sidepath)
        (ai_migrate lz/camp_low_again lz/core_cleanup)
    )
    (if
        (not m_lz_coreplaced)
        (begin
            (ai_place lz/core_elites)
            (ai_place lz/core_grunts)
            (ai_attack lz/core)
            (if
                m_lz_sidepath
                (begin
                    (ai_migrate lz/core_elites lz/camp_low_again)
                    (ai_migrate lz/core_grunts lz/camp_low_again)
                    (ai_attack lz/core)
                    (ai_attack lz/camp_low_again)
                )
            )
        )
    )
    (game_save_no_timeout)
    (sleep_until
        (or
            (volume_test_players_any lz_beach_threshold)
            (< (ai_living_count lz/core) 3)
        )
        5
    )
    (set m_lz_state blz_core_tapped)
    (if
        (not
            (volume_test_objects lz_beach_main (ai_actors lz_marines))
        )
        (ai_command_list lz_marines move_forwards)
    )
    (ai_migrate lz_marines/right lz_marines/right_marines_advance)
    (ai_renew lz_marines)
    (ai_defend lz/core)
    (ai_migrate lz/camp_low_again lz/core_cleanup)
    (game_save_no_timeout)
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_01_insertion)
    (music_start cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_01a_insertion_end)
    (sleep_until
        (or
            (and
                (<= (ai_living_count lz/core) 2)
                (<= (ai_living_count lz/camp_high) 2)
            )
            (volume_test_players_any lz_beach_threshold)
        )
        5
    )
    (set m_lz_state blz_core_crossed)
    (ai_migrate lz_marines lz_marines/marines_core)
    (ai_renew lz_marines)
    (ai_migrate lz/core lz/core_cleanup)
    (if
        (game_is_easy)
        (ai_place lz/final_grunts_easy)
        (ai_place lz/final_brutes)
    )
    (ai_place lz/final_jackals)
    (ai_place lz/final_grunts)
    (ai_migrate lz/final_grunts_easy lz/final_grunts)
    (ai_maneuver lz/snipers)
    (game_save_no_timeout)
    (sleep_until
        (or
            (volume_test_players_any lz_beach_final)
            (< (ai_living_count lz) 7)
        )
        5
    )
    (set m_lz_state blz_cov_pushed)
    (ai_migrate lz_marines lz_marines/marines_arch)
    (ai_renew lz_marines)
    (ai_attack lz/final)
    (game_save_no_timeout)
    (vehicle_unload lz_turret_high gunner)
    (vehicle_unload lz_turret_low gunner)
    (ai_migrate lz/recon lz/stragglers_cleanup)
    (ai_migrate lz/camp lz/stragglers_cleanup)
    (ai_migrate lz/camp_low lz/stragglers_cleanup)
    (ai_migrate lz/core lz/stragglers_cleanup)
    (ai_migrate lz/snipers lz/stragglers_cleanup)
    (ai_migrate lz/turret_gunner_high lz/stragglers_cleanup)
    (ai_migrate lz/turret_gunner_low lz/stragglers_cleanup)
    (sleep_until
        (or
            (volume_test_players_any lz_beach_final)
            (< (ai_living_count lz) 4)
        )
        5
    )
    (set m_lz_state blz_cov_broken)
    (ai_migrate lz lz/stragglers_cleanup)
    (ai_migrate lz_marines lz_marines/marines_final)
    (game_save_no_timeout)
    (sleep_until
        (or
            (< (ai_living_count lz) 1)
            (and
                (<= (ai_living_count lz) 1)
                (not
                    (volume_test_objects lz_beach_final (ai_actors lz))
                )
                (not
                    (volume_test_objects lz_beach_threshold (ai_actors lz))
                )
            )
        )
        5
    )
    (set m_lz_state blz_cov_dead)
    (ai_migrate lz_marines lz_marines/end_marines)
    (ai_renew lz_marines)
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_01a_insertion_end)
    (sleep -1 m_lz_updater)
    (game_save_no_timeout)
    (set m_lz_state blz_finished)
)


(script dormant m_lz_progression
    (wake m_lz_cutscene_insertion)
    (sleep_until (>= mission_state mission_inserted))
    (wake m_lz_combat)
    (sleep_until
        (or
            (= m_lz_state blz_finished)
            (= bsp_index_ext_lid (structure_bsp_index))
            (= bsp_index_ext_cart (structure_bsp_index))
        )
    )
    (set mission_lz_cleared 1)
)


(script static void m_lz_launch
    (switch_bsp bsp_index_ext_lz)
    (teleport_players m_lz_spawn m_lz_spawn)
    (object_destroy_containing spray)
    (object_type_predict cmt\scenery\_shared\c_storage\scenery\c_storage)
    (object_type_predict cmt\characters\evolved\grunt\bipeds\grunt_minor)
    (object_type_predict cmt\characters\evolved\jackal\bipeds\jackal_minor)
    (object_type_predict cmt\characters\evolved\elite\bipeds\elite_combat_minor)
    (object_type_predict cmt\characters\evolved\brute\bipeds\brute_follower_minor)
    (show_hud 0)
    (player_enable_input 0)
    (cinematic_start)
    (cinematic_show_letterbox 0)
    (camera_control 1)
    (camera_set cutscene_insertion_2b 0)
    (skip_frame)
    (camera_set cutscene_insertion_3a 0)
    (skip_frame)
    (camera_set cutscene_insertion_1a 0)
    (fade_from_black)
)


(script static void m_lz_start
    (print_debug m_lz_start)
    (if
        (= b30r_launch_lz mission_launch_index)
        (m_lz_launch)
    )
    (wake m_lz_progression)
)


(script static void m_lz_clean
    (if
        (> blz_finished m_lz_state)
        (ai_kill lz)
    )
    (ai_grenades 1)
    (sleep -1 m_lz_combat)
    (sleep -1 m_lz_updater)
    (sleep -1 m_lz_progression)
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_01_insertion)
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_01a_insertion_end)
    (ai_erase lz)
    (set mission_lz_cleared 1)
)


(script static void m_lz_skip
    (set mission_state mission_inserted)
    (set mission_lz_cleared 1)
    (object_create_containing lz_wraith_d)
    (object_create lz_wraith_cover)
    (object_create_containing lz_dump)
    (object_create_containing lz_elev_dump)
    (ai_place lz_marines/left_marines)
    (ai_migrate lz_marines lz_marines/end_marines)
)


(script dormant m_lz_control
    (if
        (!= m_lz_ctrl_state 1)
        (m_lz_skip)
        (m_lz_start)
    )
    (sleep_until (>= m_lz_ctrl_state 3))
    (m_lz_clean)
)


(script static void m_lz_startup
    (if
        (= 0 m_lz_ctrl_state)
        (begin
            (set m_lz_ctrl_state 1)
            (wake m_lz_control)
        )
    )
)


(script static void m_lz_cleanup
    (set m_lz_ctrl_state 3)
)


(script static void m_lz_mark_skip
    (m_lz_startup)
    (set m_lz_ctrl_state 2)
)


(script continuous m_ext_beach_1_automig
    (sleep_until
        (= bsp_index_ext_lz (structure_bsp_index))
        1
    )
    (ai_migrate ext_beach_1_exit_cc/left ext_beach_1_exit/left_a)
    (ai_migrate ext_beach_1_exit_cc/right ext_beach_1_exit/right_c)
    (ai_migrate ext_beach_1_exit_cc/camp ext_beach_1_exit/camp_ef)
    (ai_migrate ext_beach_1_ghost_1_cc ext_beach_1_ghost_1/f)
    (ai_migrate ext_beach_1_ghost_2_cc ext_beach_1_ghost_1/f)
    (ai_vehicle_encounter ext_beach_1_ghost_1 ext_beach_1_ghost_1/f)
    (ai_vehicle_encounter ext_beach_1_ghost_2 ext_beach_1_ghost_2/f)
    (sleep_until
        (= bsp_index_ext_capp (structure_bsp_index))
        1
    )
    (ai_migrate ext_beach_1_exit/left ext_beach_1_exit_cc/left_a)
    (ai_migrate ext_beach_1_exit/right ext_beach_1_exit_cc/right_c)
    (ai_migrate ext_beach_1_exit/camp ext_beach_1_exit_cc/camp_ef)
    (ai_migrate ext_beach_1_ghost_1 ext_beach_1_ghost_1_cc/f)
    (ai_migrate ext_beach_1_ghost_2 ext_beach_1_ghost_1_cc/f)
    (ai_vehicle_encounter ext_beach_1_ghost_1 ext_beach_1_ghost_1_cc/f)
    (ai_vehicle_encounter ext_beach_1_ghost_2 ext_beach_1_ghost_2_cc/f)
)


(script continuous m_ext_beach_1_cship_harass
    (sleep_until m_ext_beach_1_cship_start 1)
    (if
        (and
            (< m_ext_beach_1_cship_time 2700.000000)
            (!= none (vehicle_gunner ext_beach_1_cship))
        )
        (begin
            (print_debug "m_ext_beach_1_cship_harass: loop")
            (if
                x_dbg_enabled
                (begin
                    (inspect m_ext_beach_1_cship_time)
                    (inspect m_ext_beach_1_imposs_clear)
                )
            )
            (phantom_hover_and_bank ext_beach_1_cship)
            (set m_ext_beach_1_cship_time (+ phantom_bank_time m_ext_beach_1_cship_time))
        )
        (begin
            (print_debug "m_ext_beach_1_cship_harass: leaving")
            (vehicle_hover ext_beach_1_cship 0)
            (if
                (and (game_is_impossible) (not m_ext_beach_1_imposs_clear))
                (begin
                    (print_debug "m_ext_beach_1_cship_harass: reposition for legendary")
                    (set m_ext_beach_1_cship_time 0.000000)
                    (recording_play_and_hover ext_beach_1_cship ext_beach_1_cship_imposs)
                    (sleep (recording_time ext_beach_1_cship))
                )
            )
            (if
                (not (game_is_impossible))
                (begin
                    (recording_play_and_delete ext_beach_1_cship ext_beach_1_cship_harass_out)
                    (sleep_forever)
                )
            )
            (if
                m_ext_beach_1_imposs_clear
                (begin
                    (recording_play_and_delete ext_beach_1_cship ext_beach_1_cship_imposs_out)
                    (sleep_forever)
                )
            )
            (set m_ext_beach_1_imposs_clear 1)
        )
    )
)


(script continuous m_ext_beach_1_updater
    (sleep_until m_ext_beach_1_start 1)
    (if
        (volume_test_players_all ext_beach_1_1)
        (begin
            (ai_migrate ext_beach_1/rock ext_beach_1/rock_jk)
            (ai_migrate ext_beach_1/rock_crushed ext_beach_1/rock_j)
            (ai_migrate ext_beach_1/mini ext_beach_1/mini_b)
        )
        (if
            (volume_test_players_all ext_beach_1_2)
            (begin
                (ai_migrate ext_beach_1/rock ext_beach_1/rock_hi)
                (ai_migrate ext_beach_1/rock_crushed ext_beach_1/rock_h)
                (ai_migrate ext_beach_1/mini ext_beach_1/mini_c)
            )
            (if
                (volume_test_players_all ext_beach_1_3)
                (begin
                    (ai_migrate ext_beach_1/rock ext_beach_1/rock_mo)
                    (ai_migrate ext_beach_1/rock_crushed ext_beach_1/rock_l)
                    (ai_migrate ext_beach_1/mini ext_beach_1/mini_b)
                )
                (if
                    (volume_test_players_all ext_beach_1_4)
                    (begin
                        (ai_migrate ext_beach_1/rock ext_beach_1/rock_mp)
                        (ai_migrate ext_beach_1/rock_crushed ext_beach_1/rock_l)
                        (ai_migrate ext_beach_1/mini ext_beach_1/mini_c)
                    )
                    (if
                        (game_is_cooperative)
                        (begin
                            (ai_migrate ext_beach_1/rock ext_beach_1/rock_all)
                            (ai_migrate ext_beach_1/rock_crushed ext_beach_1/rock_crushed_all)
                            (ai_migrate ext_beach_1/mini ext_beach_1/mini_all)
                        )
                    )
                )
            )
        )
    )
)


(script dormant b30r_m_ext_beach_1
    (sleep_until
        (or
            (volume_test_players_any ext_beach_1_approach)
            (volume_test_players_any ext_canyon_approach)
            (volume_test_players_any ext_cave_falls)
        )
    )
    (set m_ext_beach_1_state b1_triggered)
    (if
        (<= b1e_triggered m_ext_beach_1_exit_state)
        (m_ext_hog_adventure_end_music)
        (m_ext_hog_adventure_start_music)
    )
    (ai_place ext_beach_1)
    (if
        (game_is_easy)
        (ai_migrate ext_beach_1/mini_grunts_easy ext_beach_1/mini_grunts)
        (ai_erase ext_beach_1/mini_grunts_easy)
    )
    (if
        (volume_test_players_any ext_beach_1_approach)
        (begin
            (ai_migrate ext_beach_1/mini ext_beach_1/mini_advance)
            (if
                (game_is_easy)
                (ai_set_current_state ext_beach_1/mini flee)
            )
        )
    )
    (create_ext_beach_1_cship)
    (unit_set_desired_flashlight_state ext_beach_1_cship_grav 1)
    (unit_open ext_beach_1_cship_grav)
    (object_create_anew ext_beach_1_ghost_1)
    (ai_vehicle_encounter ext_beach_1_ghost_1 ext_beach_1_ghost_1/b)
    (ai_place ext_beach_1_ghost_1/pilot)
    (unit_enter_vehicle ext_beach_1_ghost_1 ext_beach_1_cship small_cargo01)
    (vehicle_load_magic ext_beach_1_ghost_1 driver (ai_actors ext_beach_1_ghost_1/pilot))
    (object_create_anew ext_beach_1_ghost_2)
    (ai_vehicle_encounter ext_beach_1_ghost_2 ext_beach_1_ghost_2/c)
    (ai_place ext_beach_1_ghost_2/pilot)
    (unit_enter_vehicle ext_beach_1_ghost_2 ext_beach_1_cship small_cargo02)
    (vehicle_load_magic ext_beach_1_ghost_2 driver (ai_actors ext_beach_1_ghost_2/pilot))
    (object_teleport ext_beach_1_cship ext_beach_1_cship_flag)
    (vehicle_hover ext_beach_1_cship 1)
    (sleep_until
        (or
            (volume_test_players_any ext_beach_1_mini)
            (volume_test_players_any ext_beach_1_exit)
            (volume_test_players_any ext_beach_1_main)
        )
    )
    (set m_ext_beach_1_state b1_approached)
    (unit_exit_vehicle ext_beach_1_ghost_1)
    (unit_exit_vehicle ext_beach_1_ghost_2)
    (unit_set_desired_flashlight_state ext_beach_1_cship_grav 0)
    (unit_close ext_beach_1_cship_grav)
    (sleep_until
        (or
            (volume_test_players_any ext_beach_1_exit)
            (volume_test_players_any ext_beach_1_main)
        )
    )
    (set m_ext_beach_1_state b1_entered)
    (ai_conversation ext_beach_1_ghost)
    (set m_ext_beach_1_start 1)
    (ai_migrate ext_beach_1/camp ext_beach_1/camp_ep)
    (ai_migrate ext_beach_1/far ext_beach_1/far_g)
    (ai_follow_target_players ext_beach_1_ghost_1)
    (ai_follow_target_players ext_beach_1_ghost_2)
    (ai_follow_distance ext_beach_1_ghost_1 5.000000)
    (ai_follow_distance ext_beach_1_ghost_2 5.000000)
    (ai_automatic_migration_target ext_beach_1_ghost_1 1)
    (ai_automatic_migration_target ext_beach_1_ghost_2 1)
    (ai_follow_target_players ext_beach_1_ghost_1_cc)
    (ai_follow_target_players ext_beach_1_ghost_2_cc)
    (ai_follow_distance ext_beach_1_ghost_1_cc 5.000000)
    (ai_follow_distance ext_beach_1_ghost_2_cc 5.000000)
    (ai_automatic_migration_target ext_beach_1_ghost_1_cc 1)
    (ai_automatic_migration_target ext_beach_1_ghost_2_cc 1)
    (game_save_no_timeout)
    (sleep 120)
    (set m_ext_beach_1_state b1_cship_flying)
    (vehicle_hover ext_beach_1_cship 0)
    (if
        (< normal (game_difficulty_get_real))
        (begin
            (recording_play_and_hover ext_beach_1_cship ext_beach_1_cship_harass)
            (sleep (recording_time ext_beach_1_cship))
            (set m_ext_beach_1_cship_start 1)
            (set m_ext_beach_1_state b1_cship_harassing)
        )
        (recording_play_and_delete ext_beach_1_cship ext_beach_1_cship_out)
    )
    (sleep_until
        (or
            (and
                (volume_test_players_any ext_beach_1_main)
                (< (ai_living_count ext_beach_1) 7)
            )
            (not (volume_test_players_any ext_beach_1_main))
        )
    )
    (set m_ext_beach_1_state b1_leaving)
    (set m_ext_beach_1_cship_time 2700.000000)
    (game_save_no_timeout)
    (sleep_until
        (or
            (not (volume_test_players_any ext_beach_1_main))
            (< (ai_living_count ext_beach_1) 4)
        )
    )
    (set m_ext_beach_1_state b1_finishing)
    (game_save_no_timeout)
    (sleep -1 m_ext_beach_1_updater)
    (sleep 3000)
    (set m_ext_beach_1_state b1_finished)
    (if
        (= b1e_finished m_ext_beach_1_exit_state)
        (m_ext_beach_1_cleanup)
    )
)


(script continuous m_ext_beach_1_exit_updater
    (sleep_until m_ext_beach_1_exit_start 1)
    (if
        (volume_test_players_all ext_beach_1_exit_left)
        (begin
            (ai_migrate ext_beach_1_exit/left ext_beach_1_exit/left_a)
            (ai_migrate ext_beach_1_exit/right ext_beach_1_exit/right_c)
        )
        (if
            (volume_test_players_all ext_beach_1_exit_right)
            (begin
                (ai_migrate ext_beach_1_exit/left ext_beach_1_exit/left_b)
                (ai_migrate ext_beach_1_exit/right ext_beach_1_exit/right_d)
            )
            (if
                (volume_test_players_all ext_beach_1_exit_center)
                (begin
                    (ai_migrate ext_beach_1_exit/left ext_beach_1_exit/left_b)
                    (ai_migrate ext_beach_1_exit/right ext_beach_1_exit/right_c)
                )
                (if
                    (or
                        (volume_test_players_all ext_canyon_intro)
                        (volume_test_players_all ext_canyon_approach)
                    )
                    (begin
                        (ai_migrate ext_beach_1_exit/left ext_beach_1_exit/left_f)
                        (ai_migrate ext_beach_1_exit/right ext_beach_1_exit/right_h)
                        (ai_migrate ext_beach_1_exit/camp ext_beach_1_exit/camp_ef)
                    )
                    (if
                        (game_is_cooperative)
                        (begin
                            (ai_migrate ext_beach_1_exit/left ext_beach_1_exit/left_ab)
                            (ai_migrate ext_beach_1_exit/right ext_beach_1_exit/right_cd)
                        )
                    )
                )
            )
        )
    )
)


(script dormant b30r_m_ext_beach_1_exit
    (sleep_until
        (or
            (volume_test_players_any ext_beach_1_4)
            (volume_test_players_any ext_beach_1_exit)
            (volume_test_players_any ext_canyon_intro)
        )
    )
    (set m_ext_beach_1_exit_state b1e_triggered)
    (ai_place ext_beach_1_exit)
    (ai_migrate ext_beach_1_exit/left ext_beach_1_exit/left_b)
    (ai_migrate ext_beach_1_exit/right ext_beach_1_exit/right_c)
    (if
        (= impossible (game_difficulty_get_real))
        (object_create ext_beach_1_exit_turret_1)
    )
    (ai_vehicle_encounter ext_beach_1_exit_turret_1 ext_beach_1_exit)
    (ai_vehicle_encounter ext_beach_1_exit_turret_2 ext_beach_1_exit)
    (ai_go_to_vehicle ext_beach_1_exit/camp_grunts ext_beach_1_exit_turret_1 gunner)
    (ai_go_to_vehicle ext_beach_1_exit/shade_pilot_imposs ext_beach_1_exit_turret_2 gunner)
    (set m_ext_beach_1_exit_start 1)
    (sleep_until
        (or
            (volume_test_players_any ext_canyon_approach)
            (volume_test_players_any ext_beach_1_mini)
            (< (ai_living_count ext_beach_1_exit) 10)
        )
    )
    (set m_ext_beach_1_exit_state b1e_entered)
    (if
        (>= b1_triggered m_ext_beach_1_state)
        (m_ext_hog_adventure_start_music)
        (m_ext_hog_adventure_end_music)
    )
    (ai_go_to_vehicle ext_beach_1_exit ext_beach_1_exit_turret_1 gunner)
    (game_save_no_timeout)
    (sleep_until
        (or
            (volume_test_players_any ext_canyon_main_1)
            (volume_test_players_any ext_canyon_main_2)
            (volume_test_players_any ext_cart_approach)
            (volume_test_players_any ext_beach_1_approach)
            (= 1 (ai_living_count ext_beach_1_exit))
        )
    )
    (set m_ext_beach_1_exit_state b1e_finishing)
    (set m_ext_beach_1_cship_time 2700.000000)
    (sleep -1 m_ext_beach_1_exit_updater)
    (game_save_no_timeout)
    (sleep 3000)
    (set m_ext_beach_1_exit_state b1e_finished)
    (if
        (= b1_finished m_ext_beach_1_state)
        (m_ext_beach_1_cleanup)
    )
)


(script static void m_ext_beach_1_startup
    (wake b30r_m_ext_beach_1)
    (wake b30r_m_ext_beach_1_exit)
)


(script static void m_ext_beach_1_cleanup
    (sleep -1 b30r_m_ext_beach_1)
    (sleep -1 b30r_m_ext_beach_1_exit)
    (ai_erase ext_beach_1)
    (ai_erase ext_beach_1_exit)
    (ai_erase ext_beach_1_exit_cc)
    (object_destroy ext_beach_1_cship)
    (sleep -1 m_ext_beach_1_cship_harass)
    (sleep -1 m_ext_beach_1_automig)
)


(script static void m_ext_canyon_wake_nook
    (if
        (not m_ext_canyon_nook_awake)
        (begin
            (ai_set_current_state ext_canyon/nook guard)
            (ai_magically_see_players ext_canyon/nook)
            (set m_ext_canyon_nook_awake 1)
        )
    )
)


(script continuous m_ext_canyon_update
    (sleep_until m_ext_canyon_start 1)
    (if
        (volume_test_players_any ext_cart_main)
        (begin
            (if
                (not m_ext_canyon_nook_awake)
                (begin
                    (ai_set_current_state ext_canyon/nook guard)
                    (ai_magically_see_players ext_canyon/nook)
                    (set m_ext_canyon_nook_awake 1)
                )
            )
            (ai_migrate ext_canyon/shaft ext_canyon/shaft_pq)
        )
        (if
            (volume_test_players_any ext_cart_visible)
            (begin
                (m_ext_canyon_wake_nook)
                (ai_migrate ext_canyon/tree_command ext_canyon/tree_command_kj)
                (ai_migrate ext_canyon/shaft ext_canyon/shaft_no)
            )
            (if
                (volume_test_players_any ext_canyon_main_3)
                (begin
                    (m_ext_canyon_wake_nook)
                    (ai_migrate ext_canyon/tree_command ext_canyon/tree_command_kj)
                )
                (if
                    (volume_test_players_any ext_canyon_main_2)
                    (begin
                        (if m_ext_canyon_nook_awake (ai_migrate ext_canyon/nook ext_canyon/nook_h))
                        (ai_set_current_state ext_canyon/watch guard)
                        (ai_migrate ext_canyon/watch ext_canyon/watch_ih)
                        (ai_set_current_state ext_canyon/tree guard)
                        (ai_set_current_state ext_canyon/tree_command guard)
                        (ai_migrate ext_canyon/tree_command ext_canyon/tree_command_lm)
                    )
                    (if
                        (volume_test_players_any ext_canyon_main_1)
                        (begin
                            (if m_ext_canyon_nook_awake (ai_migrate ext_canyon/nook ext_canyon/nook_ed))
                            (ai_set_current_state ext_canyon/watch guard)
                            (ai_magically_see_players ext_canyon/watch)
                            (ai_migrate ext_canyon/watch ext_canyon/watch_gf)
                        )
                        (if
                            (volume_test_players_any ext_canyon_intro)
                            (begin
                                (m_ext_canyon_wake_nook)
                                (skip_frame)
                                (ai_migrate ext_canyon/nook ext_canyon/nook_bc)
                            )
                        )
                    )
                )
            )
        )
    )
    (if
        (= bsp_index_ext_capp (structure_bsp_index))
        (begin
            (ai_migrate ext_canyon_lz/nook ext_canyon/nook_bc)
            (ai_migrate ext_canyon_lz/watch ext_canyon/watch_gf)
            (ai_migrate ext_canyon_lz/tree ext_canyon/tree_grunts_2)
            (ai_migrate ext_canyon_lz/tree_command ext_canyon/tree_command_kj)
            (ai_migrate ext_canyon_lz/shaft ext_canyon/shaft_pq)
            (ai_migrate ext_canyon_ghost_lz ext_canyon_ghost/squad_a)
            (ai_vehicle_encounter ext_canyon_ghost ext_canyon_ghost/squad_a)
            (ai_follow_target_players ext_canyon_ghost_lz/squad_a)
            (ai_follow_distance ext_canyon_ghost_lz 5.000000)
        )
        (begin
            (ai_migrate ext_canyon/nook ext_canyon_lz/nook_bc)
            (ai_migrate ext_canyon/watch ext_canyon_lz/watch_gf)
            (ai_migrate ext_canyon/tree ext_canyon_lz/tree_grunts_2)
            (ai_migrate ext_canyon/tree_command ext_canyon_lz/tree_command_kj)
            (ai_migrate ext_canyon/shaft ext_canyon_lz/shaft_pq)
            (ai_migrate ext_canyon_ghost ext_canyon_ghost_lz/squad_a)
            (ai_vehicle_encounter ext_canyon_ghost ext_canyon_ghost_lz/squad_a)
            (ai_follow_target_players ext_canyon_ghost/squad_a)
            (ai_follow_distance ext_canyon_ghost 5.000000)
        )
    )
)


(script dormant m_ext_canyon
    (sleep_until
        (or
            (volume_test_players_any ext_canyon_approach)
            (volume_test_players_any ext_cart_visible)
        )
    )
    (ai_place ext_canyon_lz)
    (set m_ext_canyon_start 1)
    (if
        (>= hard (game_difficulty_get_real))
        (begin
            (object_create ext_canyon_ghost)
            (ai_place ext_canyon_ghost_lz/pilot)
            (ai_go_to_vehicle ext_canyon_ghost_lz/pilot ext_canyon_ghost driver)
            (ai_vehicle_encounter ext_canyon_ghost ext_canyon_ghost_lz/squad_a)
            (ai_follow_target_players ext_canyon_ghost_lz/squad_a)
            (ai_follow_distance ext_canyon_ghost_lz 5.000000)
        )
    )
    (sleep_until
        (and
            (= bsp_index_ext_capp (structure_bsp_index))
            (< (ai_living_count ext_canyon) 3)
            (< (ai_living_count ext_canyon_lz) 3)
        )
    )
    (game_save_no_timeout)
)


(script static void m_ext_canyon_startup (wake m_ext_canyon))


(script static void m_ext_canyon_cleanup
    (sleep -1 m_ext_canyon_update)
    (sleep -1 m_ext_canyon)
    (ai_erase ext_canyon)
    (ai_erase ext_canyon_lz)
    (object_destroy ext_canyon_ghost)
)


(script dormant ultimate_checkpoint_man
    (sleep_until (volume_test_players_any ext_cart_return_approaching) 1)
    (game_save_totally_unsafe)
    (sleep_until
        (and mission_security_unlocked (volume_test_players_any ext_cart_return_approaching))
        1
    )
    (game_save_totally_unsafe)
)


(script dormant m_ext_cave
    (sleep_until
        (or
            (volume_test_players_any ext_cave_lz)
            (volume_test_players_any ext_cave_falls)
        )
    )
    (game_save_no_timeout)
    (ai_place ext_cave)
    (m_ext_hog_adventure_start_music)
    (sleep_until (= bsp_index_ext_cave (structure_bsp_index)))
    (ai_go_to_vehicle ext_cave ext_cave_turret_1 ball-gunner)
    (sleep_until
        (< (ai_living_fraction ext_cave) 0.500000)
    )
    (ai_go_to_vehicle ext_cave ext_cave_turret_1 ball-gunner)
    (game_save_no_timeout)
    (sleep_until
        (< (ai_living_fraction ext_cave) 0.250000)
    )
    (game_save_no_timeout)
)


(script continuous m_ext_beach_2_cship
    (sleep_until m_ext_beach_2_cship_start 1)
    (recording_kill ext_beach_1_cship)
    (object_teleport ext_beach_1_cship beach_2_easy_cship_flag)
    (recording_play ext_beach_1_cship ext_cart_cship_out)
    (sleep 80)
)


(script dormant m_ext_beach_2
    (sleep_until
        (or
            (volume_test_players_any ext_cave_exit)
            (volume_test_players_any ext_cart_returning)
        )
        1
    )
    (sleep_until
        (= bsp_index_ext_lid (structure_bsp_index))
        1
    )
    (game_save_totally_unsafe)
    (ai_place ext_beach_2)
    (object_create ext_beach_2_ghost_1)
    (object_create ext_beach_2_ghost_2)
    (skip_frame)
    (sleep_until
        (= bsp_index_ext_lid (structure_bsp_index))
        1
    )
    (ai_magically_see_players ext_beach_2)
    (ai_go_to_vehicle ext_beach_2/pilot_1 ext_beach_2_ghost_1 driver)
    (ai_go_to_vehicle ext_beach_2/pilot_2 ext_beach_2_ghost_2 driver)
    (ai_vehicle_enterable_distance ext_beach_2_ghost_1 10.000000)
    (ai_vehicle_enterable_distance ext_beach_2_ghost_2 10.000000)
    (ai_vehicle_encounter ext_beach_2_ghost_1 ext_beach_2_ghost_1/a)
    (ai_vehicle_encounter ext_beach_2_ghost_2 ext_beach_2_ghost_2/a)
    (ai_follow_target_players ext_beach_2_ghost_1)
    (ai_follow_target_players ext_beach_2_ghost_2)
    (ai_follow_distance ext_beach_2_ghost_1 3.000000)
    (ai_follow_distance ext_beach_2_ghost_2 3.000000)
    (sleep_until (volume_test_players_any ext_beach_2_leaving) 1)
    (game_save_no_timeout)
    (ai_attack ext_beach_2/fodder_guys)
    (ai_magically_see_players ext_beach_2/fodder_guys)
    (m_ext_hog_adventure_end_music)
)


(script dormant m_ext_beach_2_returning
    (sleep_until (volume_test_players_any ext_cave_exit) 1)
    (sleep_until
        (= bsp_index_ext_lid (structure_bsp_index))
        1
    )
    (skip_second)
    (if
        (game_is_easy)
        (begin
            (create_ext_beach_1_cship)
            (set m_ext_beach_2_cship_start 1)
        )
    )
    (ai_place return_beach_2/second_line)
    (ai_place return_beach_2/wraith_pilot)
    (ai_set_current_state ext_beach_2 search)
    (object_create_anew return_beach_2_wraith)
    (ai_vehicle_enterable_distance return_beach_2_wraith 20.000000)
    (ai_vehicle_enterable_team return_beach_2_wraith covenant)
    (vehicle_load_magic return_beach_2_wraith driver (ai_actors return_beach_2/wraith_pilot))
    (ai_vehicle_encounter return_beach_2_wraith r_beach_2_wrth_ext_cart-sapp/f)
    (if
        (< 3 (ai_living_count ext_beach_2))
        (sleep_forever)
    )
    (ai_place return_beach_2/replacement_leader)
    (ai_place return_beach_2/replacement_followers)
    (ai_place return_beach_2/replacement_jackals)
    (ai_place return_beach_2/replacement_grunts)
    (sleep_until (volume_test_players_any ext_beach_2_leaving) 1)
    (game_save_no_timeout)
)


(script dormant m_ext_lid
    (sleep_until
        (or
            (volume_test_players_any ext_beach_2_leaving)
            (volume_test_players_any ext_cart_return_approaching)
        )
        1
    )
    (game_save_no_timeout)
    (ai_place ext_lid)
    (if (game_is_impossible) (ai_erase ext_lid/exit_grunts))
    (game_save_no_timeout)
    (sleep_until (volume_test_players_any ext_lid_entered))
    (object_destroy ext_beach_1_cship)
    (sleep -1 m_ext_beach_2_cship)
    (game_save_no_timeout)
    (ai_migrate ext_lid/entrance ext_lid/lid_jackals)
    (ai_attack ext_lid/exit)
    (sleep_until (volume_test_players_any ext_cart_returning))
    (game_save_no_timeout)
    (ai_migrate ext_lid/lid_elite ext_lid/exit_grunts)
)


(script dormant m_ext_lid_returning
    (sleep_until (volume_test_players_any ext_beach_2_leaving) 1)
    (skip_second)
    (ai_set_current_state ext_lid search)
    (if (game_is_easy) (ai_place return_lid/easy))
    (if
        (< 3 (ai_living_count ext_lid))
        (sleep_forever)
    )
    (ai_place return_lid/spawn)
    (ai_follow_target_players return_lid)
    (sleep_until (volume_test_players_any ext_cart_returning))
    (game_save_no_timeout)
)


(script static void m_ext_cave_startup
    (wake m_ext_cave)
    (wake m_ext_beach_2)
    (wake m_ext_lid)
    (wake ultimate_checkpoint_man)
)


(script static void m_ext_cave_cleanup
    (sleep -1 m_ext_beach_2)
    (ai_erase ext_beach_2)
    (sleep -1 m_ext_lid)
    (ai_erase ext_lid)
    (sleep -1 m_ext_lid_returning)
    (sleep -1 m_ext_beach_2_returning)
    (ai_erase return_lid)
    (ai_erase return_beach_2)
    (object_destroy return_beach_2_wraith)
)


(script static void m_ext_cave_mark_return
    (ai_erase ext_cave)
    (sleep -1 m_ext_cave)
    (wake m_ext_lid_returning)
    (wake m_ext_beach_2_returning)
)


(script continuous m_ext_cart_checkpoint_bastard
    (sleep_until m_ext_cart_checkpoints_start 1)
    (sleep_until
        (and
            (not (game_safe_to_save))
            (volume_test_players_any ext_cart_main)
        )
    )
    (sleep_until (game_safe_to_save))
    (game_save_no_timeout)
    (sleep 900)
)


(script static void send_ext_cart_entrance_left
    (ai_migrate ext_cart_entrance/ledge_left ext_cart_entrance/left_platform_far)
    (ai_migrate ext_cart_entrance/ledge_right ext_cart_entrance/right_platform_near)
    (ai_migrate ext_cart_entrance/ledge_center ext_cart_entrance/center_left)
)


(script static void send_ext_cart_entrance_right
    (ai_migrate ext_cart_entrance/ledge_right ext_cart_entrance/right_platform_far)
    (ai_migrate ext_cart_entrance/ledge_left ext_cart_entrance/left_platform_near)
    (ai_migrate ext_cart_entrance/ledge_center ext_cart_entrance/center_right)
)


(script continuous m_ext_cart_updater
    (sleep_until m_ext_cart_updater_start 1)
    (if
        (volume_test_players_any ext_cart_platform_left)
        (begin
            (if
                (> 4 (ai_living_count ext_cart_field/left))
                (ai_migrate ext_cart_field/left ext_cart_entrance/left_platform_far)
            )
            (if
                (> 4 (ai_living_count ext_cart_field/left_advance))
                (ai_migrate ext_cart_field/left ext_cart_field/left_defensive)
            )
            (ai_magically_see_players ext_cart_entrance/sniper)
        )
        (if
            (volume_test_players_any ext_cart_side_left)
            (begin
                (ai_migrate ext_cart_field/left ext_cart_field/treeline_retreat)
                (ai_migrate ext_cart_field/left_advance ext_cart_field/treeline_retreat_edge)
                (ai_migrate ext_cart_field/center ext_cart_field/center_right_defensive)
            )
            (if
                (volume_test_players_any ext_cart_terrain_front)
                (begin
                    (ai_migrate ext_cart_field/left ext_cart_field/treeline_elites)
                    (ai_migrate ext_cart_field/left_advance ext_cart_field/treeline_advance_elites)
                )
            )
        )
    )
    (if
        (volume_test_players_any ext_cart_platform_right)
        (begin
            (if
                (> 4 (ai_living_count ext_cart_field/center))
                (ai_migrate ext_cart_field/center ext_cart_entrance/right_platform_far)
            )
            (if
                (> 4 (ai_living_count ext_cart_field/center_advance))
                (ai_migrate ext_cart_field/center ext_cart_field/right_defensive)
            )
            (ai_magically_see_players ext_cart_entrance/sniper)
        )
        (if
            (volume_test_players_any ext_cart_side_right)
            (begin
                (ai_migrate ext_cart_field/center ext_cart_field/center_right_defensive)
                (ai_migrate ext_cart_field/center_advance ext_cart_field/center_advance_rear)
            )
            (if
                (volume_test_players_any ext_cart_terrain_front)
                (ai_migrate ext_cart_field/center_advance ext_cart_field/center_advance_front)
            )
        )
    )
    (if
        (or
            (volume_test_players_all ext_cart_platform_left)
            (volume_test_players_all ext_cart_side_left)
        )
        (send_ext_cart_entrance_left)
    )
    (if
        (or
            (volume_test_players_all ext_cart_platform_right)
            (volume_test_players_all ext_cart_side_right)
        )
        (send_ext_cart_entrance_right)
    )
    (if
        (volume_test_players_any ext_cart_under)
        (begin
            (ai_migrate ext_cart_field/left ext_cart_field/treeline_elites)
            (ai_migrate ext_cart_field/left_advance ext_cart_field/treeline_side)
            (ai_migrate ext_cart_field/center ext_cart_field/center_right)
            (if
                (not ext_cart_secret_placed)
                (begin
                    (set ext_cart_secret_placed 1)
                    (ai_place ext_cart_secret)
                    (ai_attack ext_cart_secret/secret)
                    (ai_set_current_state ext_cart_secret/secret guard)
                )
            )
        )
    )
)


(script continuous m_ext_cart_cship_flavor
    (sleep_until m_ext_cart_cship_start 1)
    (if
        m_ext_cart_cship_idle
        (phantom_hover_and_bank ext_cart_cship)
        (begin
            (vehicle_hover ext_cart_cship 0)
            (recording_play_and_delete ext_cart_cship ext_cart_cship_out)
            (sleep_forever)
        )
    )
)


(script dormant m_ext_cart
    (sleep_until
        (or
            (volume_test_players_any ext_cart_approach)
            (volume_test_players_any ext_cart_terrain_front)
            (volume_test_players_any ext_cart_smallgorge)
        )
    )
    (game_save_no_timeout)
    (m_ext_hog_adventure_end_music)
    (if
        (not (game_is_easy))
        (object_create magic_shotgun)
    )
    (ai_place ext_cart_field)
    (if
        (not (game_is_easy))
        (ai_erase ext_cart_field/grunt_tower_easy)
    )
    (create_ext_cart_cship)
    (object_teleport ext_cart_cship ext_cart_cship_flag)
    (vehicle_hover ext_cart_cship 1)
    (set m_ext_cart_cship_start 1)
    (sleep_until
        (or
            (volume_test_players_any ext_cart_visible)
            (volume_test_players_any ext_cart_crap1)
        )
        10
    )
    (music_start cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_03_cart_found)
    (if
        (game_is_easy)
        (begin
            (sound_looping_set_scale cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_03_cart_found 0.100000)
            (phantom_of_the_map)
        )
    )
    (sleep (random_range 30 90))
    (if
        (game_is_easy)
        (ai_conversation ext_cart_seen_special)
        (ai_conversation ext_cart_seen)
    )
    (set mission_state mission_cartographer_found)
    (game_save_no_timeout)
    (set m_ext_cart_checkpoints_start 1)
    (if
        (volume_test_players_any ext_cart_visible)
        (set ext_cart_frontal_approach 1)
        (begin
            (set ext_cart_frontal_approach 0)
            (ai_migrate ext_cart_field/left ext_cart_field/treeline_retreat)
            (ai_migrate ext_cart_field/left_advance ext_cart_field/treeline_retreat_edge)
            (ai_place ext_cart_entrance)
            (ai_set_current_state ext_cart_entrance search)
            (send_ext_cart_entrance_left)
            (if
                (game_is_easy)
                (begin
                    (ai_erase ext_cart_entrance/right_platform_elites)
                    (object_create_anew cart_wraith_easy)
                    (ai_go_to_vehicle ext_cart_entrance/wraith_pilot_easy cart_wraith_easy driver)
                )
                (ai_erase ext_cart_entrance/wraith_pilot_easy)
            )
        )
    )
    (ai_migrate ext_cart_field/center ext_cart_field/center_rear)
    (ai_migrate ext_cart_field/center_advance ext_cart_field/center_advance_front)
    (ai_set_current_state ext_cart_field/center guard)
    (ai_set_current_state ext_cart_field/center_advance guard)
    (ai_set_current_state ext_cart_field/left guard)
    (set m_ext_cart_updater_start 1)
    (game_save_no_timeout)
    (sleep_until (volume_test_players_any ext_cart_main) 10)
    (if
        (not (game_is_easy))
        (ai_conversation ext_cart_arrival)
    )
    (set m_ext_cart_cship_idle 0)
    (if
        ext_cart_frontal_approach
        (begin
            (ai_place ext_cart_entrance)
            (if
                (game_is_easy)
                (begin
                    (ai_erase ext_cart_entrance/right_platform_elites)
                    (object_create_anew cart_wraith_easy)
                    (skip_frame)
                    (ai_go_to_vehicle ext_cart_entrance/wraith_pilot_easy cart_wraith_easy driver)
                )
                (ai_erase ext_cart_entrance/wraith_pilot_easy)
            )
        )
    )
    (game_save_no_timeout)
    (ai_go_to_vehicle ext_cart_entrance/ledge_center ext_cart_turret_front gunner)
    (sleep_until
        (or
            (volume_test_players_any ext_cart_side_left)
            (volume_test_players_any ext_cart_side_right)
            (volume_test_players_any override_cliffs_entrance)
            (volume_test_players_any ext_cart_entrance_past)
            (volume_test_players_any ext_cart_secret_inside)
        )
        10
    )
    (ai_retreat ext_cart_field/left_advance)
    (ai_retreat ext_cart_field/center_advance)
    (game_save_no_timeout)
    (sleep_until
        (or
            (and
                (volume_test_players_any ext_cart_entrance)
                (> 4 (ai_status ext_cart_entrance/interior))
            )
            (= 0 (ai_living_count ext_cart_entrance/interior))
            (volume_test_players_any ext_cart_entrance_past)
            (volume_test_players_any override_cliffs_entrance)
            (volume_test_players_any ext_cart_returning)
        )
        15
        3600
    )
    (game_save_no_timeout)
    (ai_defend ext_cart_entrance/ledge_left)
    (ai_defend ext_cart_entrance/ledge_right)
    (ai_defend ext_cart_entrance/ledge_center)
    (sleep -1 m_ext_cart_updater)
    (sleep (random_range 90 150))
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_03_cart_found)
    (if
        (or
            (volume_test_players_any ext_cart_platform_left)
            (volume_test_players_any ext_cart_platform_right)
            (volume_test_players_any ext_cart_entrance)
            (volume_test_players_any ext_cart_entrance_past)
            (volume_test_players_any ext_cart_entrance_hall)
            (volume_test_players_any override_lock_window)
        )
        (begin
            (if
                (game_is_easy)
                (ai_conversation ext_cart_entered_special)
                (ai_conversation ext_cart_entered)
            )
            (sleep_until
                (< 4 (ai_conversation_status ext_cart_entered))
                1
            )
            (if
                (game_is_easy)
                (objective_set dia_found_ez obj_found_ez)
                (objective_set dia_found obj_found)
            )
            (ai_conversation ext_cart_deep)
        )
    )
    (game_save_no_timeout)
)


(script static void m_ext_cart_startup (wake m_ext_cart))


(script static void m_ext_cart_cleanup
    (sleep -1 m_ext_cart)
    (sleep -1 m_ext_cart_updater)
    (sleep -1 m_ext_cart_cship_flavor)
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_03_cart_found)
    (object_destroy ext_cart_cship)
)


(script static void m_ext_drop_pods_assemble
    (object_create ext_drop_pod_1)
    (object_create ext_drop_pod_2)
    (object_create ext_drop_pod_3)
    (object_create ext_drop_pod_4)
)


(script static void m_ext_drop_pods_detach
    (if
        (game_is_easy)
        (object_create ext_drop_pod_w1s)
        (object_create ext_drop_pod_w1)
    )
    (sleep 15)
    (if
        (game_is_easy)
        (object_create ext_drop_pod_w3s)
        (object_create ext_drop_pod_w3)
    )
    (sleep 15)
    (object_create ext_drop_pod_w4)
    (sleep 15)
    (object_create ext_drop_pod_w2)
)


(script static void m_ext_drop_pod_drop
    (effect_new_on_object_marker cmt\scenery\_shared\h_drop_pod\effects\h_drop_pod_detach insertion_pelican_2 m_ext_drop_pod_marker)
    (skip_half_second)
    (objects_detach insertion_pelican_2 m_ext_drop_pod_veh)
)


(script continuous m_ext_drop_secret
    (sleep_until m_ext_drop_secret_start 1)
    (if
        (and
            (not (unit_has_weapon (player0) cmt\weapons\evolved\dmr\dmr))
            (not (unit_has_weapon (player1) cmt\weapons\evolved\dmr\dmr))
        )
        (object_teleport ext_drop_pod_w1s ext_drop_secret)
    )
)


(script dormant m_ext_drop_pod
    (object_create_anew insertion_pelican_2)
    (unit_set_enterable_by_player insertion_pelican_2 0)
    (m_ext_drop_pods_assemble)
    (objects_attach insertion_pelican_2 droppodl01 ext_drop_pod_1 attach)
    (objects_attach insertion_pelican_2 droppodr03 ext_drop_pod_2 attach)
    (objects_attach insertion_pelican_2 droppodl03 ext_drop_pod_3 attach)
    (objects_attach insertion_pelican_2 droppodr01 ext_drop_pod_4 attach)
    (unit_close insertion_pelican_2)
    (object_teleport insertion_pelican_2 pod_peli_flag)
    (recording_play_and_hover insertion_pelican_2 pod_pelican_in)
    (sleep_until
        (or
            (not (volume_test_players_any ext_drop_pod_vol))
            (game_is_easy)
        )
    )
    (sleep_until
        (< (recording_time insertion_pelican_2) 50)
    )
    (set m_ext_drop_pod_marker droppodl03)
    (set m_ext_drop_pod_veh ext_drop_pod_3)
    (m_ext_drop_pod_drop)
    (set m_ext_drop_pod_marker droppodr03)
    (set m_ext_drop_pod_veh ext_drop_pod_2)
    (m_ext_drop_pod_drop)
    (set m_ext_drop_pod_marker droppodr01)
    (set m_ext_drop_pod_veh ext_drop_pod_4)
    (m_ext_drop_pod_drop)
    (set m_ext_drop_pod_marker droppodl01)
    (set m_ext_drop_pod_veh ext_drop_pod_1)
    (m_ext_drop_pod_drop)
    (sleep 100)
    (if
        (or
            (volume_test_players_any lz_beach_final)
            (volume_test_players_any lz_beach_threshold)
            (volume_test_players_any lz_beach_main)
        )
        (activate_team_nav_point_flag weapon_ord player drop_pod_lz 0.300000)
    )
    (m_ext_drop_pods_detach)
    (vehicle_hover insertion_pelican_2 0)
    (recording_play_and_delete insertion_pelican_2 pod_pelican_out)
)


(script dormant m_ext_drop_hog
    (create_insertion_pelican_1)
    (unit_set_enterable_by_player insertion_pelican_1 0)
    (if
        (game_is_easy)
        (begin
            (object_create_anew ext_drop_rhog)
            (objects_attach insertion_pelican_1 cargo ext_drop_rhog cargo)
        )
        (begin
            (object_create_anew ext_drop_hog)
            (objects_attach insertion_pelican_1 cargo ext_drop_hog cargo)
        )
    )
    (unit_close insertion_pelican_1)
    (ai_place lz_marines_holding/init)
    (ai_place lz_marines_holding/init_rider)
    (vehicle_load_magic insertion_pelican_1 rider (ai_actors lz_marines_holding/init))
    (vehicle_load_magic insertion_pelican_1 rider (ai_actors lz_marines_holding/init_rider))
    (object_teleport insertion_pelican_1 hog_peli_flag)
    (recording_play_and_hover insertion_pelican_1 hog_pelican_in)
    (sleep_until
        (and
            (< (recording_time insertion_pelican_1) 1)
            (or
                (not (volume_test_players_any ext_drop_hog_vol))
                (game_is_easy)
            )
        )
    )
    (objects_detach insertion_pelican_1 ext_drop_hog)
    (objects_detach insertion_pelican_1 ext_drop_rhog)
    (if
        (or
            (volume_test_players_any lz_beach_final)
            (volume_test_players_any lz_beach_threshold)
            (volume_test_players_any lz_beach_main)
        )
        (if
            (game_is_easy)
            (activate_team_nav_point_object vehicle_ord player ext_drop_rhog 0.500000)
            (activate_team_nav_point_object vehicle_ord player ext_drop_hog 0.500000)
        )
    )
    (skip_second)
    (unit_open insertion_pelican_1)
    (sleep 60)
    (custom_animation insertion_pelican_1 cmt\vehicles\_shared\pelican\pelican cinematic-dip 1)
    (sleep 60)
    (vehicle_unload insertion_pelican_1 rider)
    (sleep 45)
    (ai_command_list lz_marines_holding/init move_forwards)
    (ai_command_list lz_marines_holding/init_rider move_forwards)
    (set m_ext_drop_hog_dropped 1)
    (if
        (not (game_is_easy))
        (begin
            (object_create_anew ext_drop_pod_w1s)
            (set m_ext_drop_secret_start 1)
        )
    )
    (skip_second)
    (ai_set_current_state lz_marines_holding/init move_random)
    (ai_set_current_state lz_marines_holding/init_rider move_random)
    (sleep 90)
    (if
        (and
            (not (unit_has_weapon (player0) cmt\weapons\evolved\dmr\dmr))
            (not (unit_has_weapon (player1) cmt\weapons\evolved\dmr\dmr))
            (not (game_is_easy))
        )
        (begin
            (object_destroy ext_drop_pod_w1s)
            (sleep -1 m_ext_drop_secret)
        )
        (object_create_containing dmr_pack)
    )
    (sleep 115)
    (vehicle_hover insertion_pelican_1 0)
    (recording_play_and_delete insertion_pelican_1 hog_pelican_out)
    (sleep 140)
    (unit_close insertion_pelican_1)
    (ai_migrate lz_marines_holding lz_marines_holding/lz)
)


(script dormant m_ext_drop_words
    (ai_conversation jeep_delivery)
    (sleep_until m_ext_drop_hog_dropped)
    (if
        (and
            (not (game_is_cooperative))
            (<
                (list_count (vehicle_riders ext_drop_hog))
                2
            )
        )
        (ai_conversation jeep_load)
    )
    (sleep_until
        (< 1 (ai_conversation_line jeep_load))
        1
    )
    (sleep 90)
    (if
        (game_is_easy)
        (ai_conversation jeep_go_special)
        (ai_conversation jeep_go)
    )
    (if
        (game_is_easy)
        (objective_set dia_find_ez obj_find_ez)
        (objective_set dia_find obj_find)
    )
)


(script dormant m_ext_drop_skip
    (sleep_until (= bsp_index_ext_lz (structure_bsp_index)))
    (m_ext_drop_pods_assemble)
    (object_teleport ext_drop_pod_1 ext_skip_drop1)
    (object_teleport ext_drop_pod_2 ext_skip_drop2)
    (object_teleport ext_drop_pod_3 ext_skip_drop3)
    (object_teleport ext_drop_pod_4 ext_skip_drop4)
    (skip_second)
    (m_ext_drop_pods_detach)
)


(script dormant m_ext_drop
    (sleep_until mission_lz_cleared)
    (if
        (!= bsp_index_ext_lz (structure_bsp_index))
        (begin
            (wake m_ext_drop_skip)
            (wake m_ext_drop_words)
            (if
                (game_is_easy)
                (object_create_anew ext_drop_rhog)
                (object_create_anew ext_drop_hog)
            )
            (object_teleport ext_drop_rhog ext_skip_drop_hog)
            (object_teleport ext_drop_hog ext_skip_drop_hog)
            (ai_place lz_marines/left_marines)
            (ai_migrate lz_marines lz_marines_holding)
            (sleep_forever)
        )
    )
    (sleep_until (volume_test_players_all lz_beach_final) 5 150)
    (ai_migrate lz_marines lz_marines_holding/lz)
    (ai_migrate lz_marines_holding lz_marines_holding/lz)
    (ai_renew lz_marines_holding)
    (ai_command_list lz_marines_holding/lz move_forwards)
    (skip_second)
    (wake m_ext_drop_pod)
    (sleep 70)
    (wake m_ext_drop_words)
    (sleep 250)
    (wake m_ext_drop_hog)
    (sleep_until m_ext_drop_hog_dropped)
    (if
        (not (game_is_cooperative))
        (begin
            (skip_second)
            (sleep_until
                (< 1 (ai_conversation_line jeep_load))
                1
            )
            (ai_go_to_vehicle lz_marines_holding/init_rider ext_drop_hog passenger)
            (ai_go_to_vehicle lz_marines_holding/lz ext_drop_hog gunner)
        )
    )
    (sleep 90)
    (ai_migrate lz_marines_holding/init_rider lz_marines_holding/lz)
    (if
        (not (game_is_cooperative))
        (ai_go_to_vehicle lz_marines_holding ext_drop_hog passenger)
    )
    (sleep_until
        (or
            (volume_test_players_any ext_beach_1_approach)
            (volume_test_players_any lz_beach_side)
            (vehicle_test_seat_list ext_drop_hog w-driver (players))
            (!= bsp_index_ext_lz (structure_bsp_index))
        )
        5
        1800
    )
    (deactivate_team_nav_point_object player ext_drop_hog)
    (deactivate_team_nav_point_object player ext_drop_rhog)
    (deactivate_team_nav_point_flag player drop_pod_lz)
    (skip_second)
    (if
        (vehicle_test_seat_list ext_drop_hog w-driver (players))
        (m_ext_hog_adventure_start_music)
    )
    (game_save_no_timeout)
)


(script dormant m_ext_hog_adventure_music
    (sleep_until (= 1 m_ext_hog_adventure_state))
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_01_insertion)
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_01a_insertion_end)
    (sleep_until mission_lz_cleared 1)
    (music_start cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_02_warthog_adventure)
    (sleep_until (= 2 m_ext_hog_adventure_state) 30 5400)
    (set m_ext_hog_adventure_state 2)
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_02_warthog_adventure)
)


(script static void m_ext_hog_adventure_start_music
    (set m_ext_hog_adventure_state 1)
)


(script static void m_ext_hog_adventure_end_music
    (set m_ext_hog_adventure_state 2)
)


(script static void m_ext_launch
    (checkpoint_launch bsp_index_ext_lz m_ext_spawn_0 m_ext_spawn_1)
)


(script static void m_ext_start
    (if
        (= b30r_launch_ext mission_launch_index)
        (m_ext_launch)
    )
    (m_ext_beach_1_startup)
    (m_ext_canyon_startup)
    (m_ext_cart_startup)
    (m_ext_cave_startup)
    (wake m_ext_hog_adventure_music)
    (wake m_ext_drop)
)


(script static void m_ext_clean
    (m_ext_beach_1_cleanup)
    (m_ext_canyon_cleanup)
    (m_ext_cart_cleanup)
    (m_ext_cave_cleanup)
)


(script static void m_ext_return
    (sleep -1 m_ext_drop)
    (m_ext_hog_adventure_end_music)
    (m_ext_cave_mark_return)
)


(script static void m_ext_skip
    (ai_place lz_marines/left_marines)
    (ai_migrate lz_marines lz_marines_holding)
    (wake m_ext_drop_skip)
    (set mission_state mission_cartographer_found)
    (m_ext_hog_adventure_end_music)
    (m_ext_cave_startup)
)


(script dormant m_ext_control
    (if
        (!= m_ext_ctrl_state 1)
        (m_ext_skip)
        (m_ext_start)
    )
    (sleep_until (>= m_ext_ctrl_state 3))
    (m_ext_return)
    (sleep_until (>= m_ext_ctrl_state 4))
    (m_ext_clean)
)


(script static void m_ext_startup
    (if
        (= 0 m_ext_ctrl_state)
        (begin
            (set m_ext_ctrl_state 1)
            (wake m_ext_control)
        )
    )
)


(script static void m_ext_mark_return
    (set m_ext_ctrl_state 3)
)


(script static void m_ext_cleanup
    (set m_ext_ctrl_state 4)
)


(script static void m_ext_mark_skip
    (m_ext_startup)
    (set m_ext_ctrl_state 2)
)


(script static boolean m_o_shaft_encounter_alert
    (= (bit_test m_o_shaft_elev_statebits encounter_alert) 1)
)


(script static void m_o_shaft_encounter_set_alert
    (set m_o_shaft_elev_statebits (bit_toggle m_o_shaft_elev_statebits encounter_alert 1))
)


(script static void m_o_shaft_player_set_hall
    (set m_o_shaft_elev_statebits (bit_toggle m_o_shaft_elev_statebits player_hall_prev 1))
)


(script static void m_o_shaft_player_set_nonhall
    (set m_o_shaft_elev_statebits (bit_toggle m_o_shaft_elev_statebits player_hall_prev 0))
)


(script static boolean m_o_shaft_player_hall_prev
    (= (bit_test m_o_shaft_elev_statebits player_hall_prev) 1)
)


(script static boolean m_o_shaft_hunters_active
    (= (bit_test m_o_shaft_elev_statebits hunters_active) 1)
)


(script static void m_o_shaft_hunters_set_active
    (set m_o_shaft_elev_statebits (bit_toggle m_o_shaft_elev_statebits hunters_active 1))
)


(script static boolean m_o_shaft_hunters_initialized
    (= (bit_test m_o_shaft_elev_statebits hunters_initialized) 1)
)


(script static void m_o_shaft_hunters_set_init
    (set m_o_shaft_elev_statebits (bit_toggle m_o_shaft_elev_statebits hunters_initialized 1))
)


(script static boolean m_o_shaft_hunters_1dead
    (= (bit_test m_o_shaft_elev_statebits hunters_1dead) 1)
)


(script static void m_o_shaft_hunters_set_1dead
    (set m_o_shaft_elev_statebits (bit_toggle m_o_shaft_elev_statebits hunters_1dead 1))
)


(script static boolean m_o_shaft_hunters_2dead
    (= (bit_test m_o_shaft_elev_statebits hunters_2dead) 1)
)


(script static void m_o_shaft_hunters_set_2dead
    (set m_o_shaft_elev_statebits (bit_toggle m_o_shaft_elev_statebits hunters_2dead 1))
)


(script static void m_o_shaft_hunters_set_curr_l2
    (set m_o_shaft_elev_statebits (bit_toggle m_o_shaft_elev_statebits hunter_level_curr 1))
)


(script static void m_o_shaft_hunters_set_curr_l1
    (set m_o_shaft_elev_statebits (bit_toggle m_o_shaft_elev_statebits hunter_level_curr 0))
)


(script static short m_o_shaft_hunter_level_curr
    (+ (bit_test m_o_shaft_elev_statebits hunter_level_curr) 1.000000)
)


(script static void m_o_shaft_hunters_set_dest_l2
    (set m_o_shaft_elev_statebits (bit_toggle m_o_shaft_elev_statebits hunter_level_dest 1))
)


(script static void m_o_shaft_hunters_set_dest_l1
    (set m_o_shaft_elev_statebits (bit_toggle m_o_shaft_elev_statebits hunter_level_dest 0))
)


(script static short m_o_shaft_hunter_level_dest
    (+ (bit_test m_o_shaft_elev_statebits hunter_level_dest) 1.000000)
)


(script static boolean m_o_shaft_hunters_at_l1_elev
    (volume_test_objects_all override_shaft_elev_bot (ai_actors override_shaft_elev/hunters))
)


(script static boolean m_o_shaft_hunters_at_l2_elev
    (volume_test_objects_all override_shaft_elev_top (ai_actors override_shaft_elev/hunters))
)


(script static boolean m_o_shaft_hunter_a_at_l1
    (volume_test_objects override_shaft_elev_fullbot (ai_actors m_o_shaft_hunter_a))
)


(script static boolean m_o_shaft_hunter_b_at_l1
    (volume_test_objects override_shaft_elev_fullbot (ai_actors m_o_shaft_hunter_b))
)


(script static boolean m_o_shaft_hunter_a_at_l2
    (or
        (volume_test_objects override_shaft_elev_fulltop (ai_actors m_o_shaft_hunter_a))
        (volume_test_objects override_shaft_elev_hall_top (ai_actors m_o_shaft_hunter_a))
    )
)


(script static boolean m_o_shaft_hunter_b_at_l2
    (or
        (volume_test_objects override_shaft_elev_fulltop (ai_actors m_o_shaft_hunter_b))
        (volume_test_objects override_shaft_elev_hall_top (ai_actors m_o_shaft_hunter_b))
    )
)


(script dormant m_o_shaft_elev_rumble_move
    (sleep 30)
    (player_effect_start 1.000000 0.300000)
    (player_effect_stop 0.500000)
)


(script dormant m_o_shaft_elev_rumble_stop
    (sleep 30)
    (player_effect_start 0.500000 0.300000)
    (player_effect_stop 0.500000)
)


(script static void m_o_shaft_elev_hunters_up
    (if
        (or
            (not (game_is_cooperative))
            (not (volume_test_players_any override_shaft_elev_fulltop))
        )
        (begin
            (object_teleport
                (list_get (ai_actors m_o_shaft_hunter_a) 0)
                m_o_shaft_hunter_a_l1
            )
            (object_teleport
                (list_get (ai_actors m_o_shaft_hunter_b) 0)
                m_o_shaft_hunter_b_l1
            )
        )
    )
    (print_debug "m_o_shaft_elev_hunters_up: activating lift")
    (device_set_position ext_cave_hunter_lift 1.000000)
    (wake m_o_shaft_elev_rumble_move)
    (sleep_until
        (< 0.125000 (device_get_position ext_cave_hunter_lift))
        1
    )
    (object_teleport
        (list_get (ai_actors m_o_shaft_hunter_a) 0)
        m_o_shaft_hunter_a_l1
    )
    (object_teleport
        (list_get (ai_actors m_o_shaft_hunter_b) 0)
        m_o_shaft_hunter_b_l1
    )
    (print_debug "m_o_shaft_elev_hunters_up: waiting for lift")
    (sleep_until
        (< 0.885000 (device_get_position ext_cave_hunter_lift))
        1
    )
    (print_debug "m_o_shaft_elev_hunters_up: lift arrived, un-freezing and migrating hunters")
    (ai_command_list_advance m_o_shaft_hunter_a)
    (ai_command_list_advance m_o_shaft_hunter_b)
    (ai_migrate m_o_shaft_hunter_a override_shaft_elev/hunter_guard_top)
    (ai_migrate m_o_shaft_hunter_b override_shaft_elev/hunter_chase_top)
    (set m_o_shaft_hunter_a override_shaft_elev/hunter_guard_top)
    (set m_o_shaft_hunter_b override_shaft_elev/hunter_chase_top)
    (wake m_o_shaft_elev_rumble_stop)
    (m_o_shaft_hunters_set_curr_l2)
)


(script static void m_o_shaft_elev_hunters_down
    (if
        (or
            (not (game_is_cooperative))
            (not (volume_test_players_any override_shaft_elev_fullbot))
        )
        (begin
            (if
                (m_o_shaft_hunter_a_at_l2)
                (object_teleport
                    (list_get (ai_actors m_o_shaft_hunter_a) 0)
                    m_o_shaft_hunter_a_l2_u
                )
            )
            (if
                (m_o_shaft_hunter_b_at_l2)
                (object_teleport
                    (list_get (ai_actors m_o_shaft_hunter_b) 0)
                    m_o_shaft_hunter_b_l2_u
                )
            )
        )
    )
    (print_debug "m_o_shaft_elev_hunters_down: activating lift")
    (device_set_position ext_cave_hunter_lift 0.000000)
    (wake m_o_shaft_elev_rumble_move)
    (sleep_until
        (> 0.750000 (device_get_position ext_cave_hunter_lift))
        1
    )
    (if
        (m_o_shaft_hunter_a_at_l2)
        (object_teleport
            (list_get (ai_actors m_o_shaft_hunter_a) 0)
            m_o_shaft_hunter_a_l2
        )
    )
    (if
        (m_o_shaft_hunter_b_at_l2)
        (object_teleport
            (list_get (ai_actors m_o_shaft_hunter_b) 0)
            m_o_shaft_hunter_b_l2
        )
    )
    (print_debug "m_o_shaft_elev_hunters_down: waiting for lift")
    (sleep_until
        (> 0.125000 (device_get_position ext_cave_hunter_lift))
        1
    )
    (print_debug "m_o_shaft_elev_hunters_down: lift arrived, un-freezing and migrating hunters")
    (ai_command_list_advance m_o_shaft_hunter_a)
    (ai_command_list_advance m_o_shaft_hunter_b)
    (ai_migrate m_o_shaft_hunter_a override_shaft_elev/hunter_guard)
    (ai_migrate m_o_shaft_hunter_b override_shaft_elev/hunter_chase)
    (set m_o_shaft_hunter_a override_shaft_elev/hunter_guard)
    (set m_o_shaft_hunter_b override_shaft_elev/hunter_chase)
    (wake m_o_shaft_elev_rumble_stop)
    (m_o_shaft_hunters_set_curr_l1)
)


(script continuous m_o_shaft_elev_l1_to_l2
    (print_debug "m_o_shaft_elev_l1_to_l2: waiting for move command")
    (sleep_until
        (and
            (= 1 (m_o_shaft_hunter_level_curr))
            (= 2 (m_o_shaft_hunter_level_dest))
        )
        1
    )
    (print_debug "m_o_shaft_elev_l1_to_l2: move command received, moving hunters to elevator")
    (ai_command_list_advance override_shaft_elev/hunters)
    (ai_command_list m_o_shaft_hunter_a ov_shaft_elev_hunter_1_b)
    (ai_command_list m_o_shaft_hunter_b ov_shaft_elev_hunter_2_b)
    (ai_allow_charge override_shaft_elev/hunters 0)
    (if
        (not (m_o_shaft_hunters_at_l1_elev))
        (sleep 90)
    )
    (sleep_until
        (if
            (or (m_o_shaft_hunters_at_l1_elev) (volume_test_players_all override_shaft_elev_fulltop))
            (begin
                (print_debug "m_o_shaft_elev_l1_to_l2: hunters at elevator or players at level 2, sending up")
                (m_o_shaft_elev_hunters_up)
                (ai_allow_charge override_shaft_elev/hunters 1)
                1
            )
            (if
                (or
                    (volume_test_players_any override_shaft_elev_fullbot)
                    (= 1 (m_o_shaft_hunter_level_dest))
                )
                (begin
                    (print_debug "m_o_shaft_elev_l1_to_l2: hunters no longer need to move up, cancelling")
                    (m_o_shaft_hunters_set_dest_l1)
                    (ai_command_list_advance override_shaft_elev/hunters)
                    (ai_allow_charge override_shaft_elev/hunters 1)
                    1
                )
                (if 1 0 0)
            )
        )
        1
    )
    (print_debug "m_o_shaft_elev_l1_to_l2: finished moving hunters")
)


(script continuous m_o_shaft_elev_l2_to_l1
    (print_debug "m_o_shaft_elev_l2_to_l1: waiting for move command")
    (sleep_until
        (and
            (= 2 (m_o_shaft_hunter_level_curr))
            (= 1 (m_o_shaft_hunter_level_dest))
        )
        1
    )
    (print_debug "m_o_shaft_elev_l2_to_l1: move command received, moving hunters to elevator")
    (ai_command_list_advance override_shaft_elev/hunters)
    (if
        (m_o_shaft_hunter_a_at_l2)
        (if
            (m_o_shaft_hunters_initialized)
            (ai_command_list m_o_shaft_hunter_a ov_shaft_elev_hunter_1_t)
            (ai_command_list m_o_shaft_hunter_a ov_shaft_elev_hunter_1_t_i)
        )
    )
    (if
        (m_o_shaft_hunter_b_at_l2)
        (if
            (m_o_shaft_hunters_initialized)
            (ai_command_list m_o_shaft_hunter_b ov_shaft_elev_hunter_2_t)
            (ai_command_list m_o_shaft_hunter_b ov_shaft_elev_hunter_2_t_i)
        )
    )
    (ai_allow_charge override_shaft_elev/hunters 0)
    (if
        (not (m_o_shaft_hunters_at_l2_elev))
        (sleep 90)
    )
    (sleep_until
        (if
            (or (m_o_shaft_hunters_at_l2_elev) (volume_test_players_all override_shaft_elev_fullbot))
            (begin
                (print_debug "m_o_shaft_elev_l2_to_l1: hunters at elevator or player at level 1, sending down")
                (m_o_shaft_elev_hunters_down)
                (ai_allow_charge override_shaft_elev/hunters 1)
                1
            )
            (if
                (or
                    (volume_test_players_any override_shaft_elev_fulltop)
                    (= 2 (m_o_shaft_hunter_level_dest))
                )
                (begin
                    (print_debug "m_o_shaft_elev_l2_to_l1: hunters no longer need to move down, cancelling")
                    (m_o_shaft_hunters_set_dest_l2)
                    (ai_command_list_advance override_shaft_elev/hunters)
                    (ai_allow_charge override_shaft_elev/hunters 1)
                    1
                )
                (if 1 0 0)
            )
        )
        1
    )
    (print_debug "m_o_shaft_elev_l2_to_l1: finished moving hunters")
)


(script dormant m_o_shaft_elev_hunters
    (print_debug "m_o_shaft_elev_hunters: awake")
    (if
        (game_is_easy)
        (begin
            (ai_place override_shaft_elev/hunter_guard_easy)
            (ai_place override_shaft_elev/hunter_chase_easy)
            (ai_migrate override_shaft_elev/hunter_guard_easy override_shaft_elev/hunter_guard)
            (ai_migrate override_shaft_elev/hunter_chase_easy override_shaft_elev/hunter_chase)
        )
        (begin
            (ai_place override_shaft_elev/hunter_guard)
            (ai_place override_shaft_elev/hunter_chase)
        )
    )
    (set m_o_shaft_hunter_a override_shaft_elev/hunter_guard)
    (set m_o_shaft_hunter_b override_shaft_elev/hunter_chase)
    (m_o_shaft_hunters_set_curr_l2)
    (m_o_shaft_hunters_set_dest_l2)
    (ai_braindead override_shaft_elev/hunters 1)
    (print_debug "m_o_shaft_elev_hunters: waiting for hunters to be activated")
    (sleep_until (m_o_shaft_hunters_active) 1)
    (print_debug "m_o_shaft_elev_hunters: hunters activated")
    (m_o_shaft_hunters_set_dest_l1)
    (print_debug "m_o_shaft_elev_hunters: awaiting hunter descent")
    (sleep_until
        (<= (device_get_position ext_cave_hunter_lift) 0.100000)
        1
    )
    (print_debug "m_o_shaft_elev_hunters: hunters descended, enable brains")
    (ai_braindead override_shaft_elev/hunters 0)
    (m_o_shaft_hunters_set_init)
    (print_debug "m_o_shaft_elev_hunters: awaiting hunter death")
    (sleep_until
        (< (ai_living_count override_shaft_elev/hunters) 2)
        1
    )
    (print_debug "m_o_shaft_elev_hunters: first hunter dead")
    (m_o_shaft_hunters_set_1dead)
    (print_debug "m_o_shaft_elev_hunters: waiting for elevator to be stable")
    (sleep_until
        (= (m_o_shaft_hunter_level_curr) (m_o_shaft_hunter_level_dest))
        1
    )
    (print_debug "m_o_shaft_elev_hunters: elevator stable, migrating survivor")
    (sleep -1 m_o_shaft_elev_l2_to_l1)
    (sleep -1 m_o_shaft_elev_l1_to_l2)
    (ai_command_list_advance override_shaft_elev/hunters)
    (ai_migrate override_shaft_elev/hunters override_shaft_elev/hunter_remnant)
    (set m_o_shaft_hunter_a override_shaft_elev/hunter_remnant)
    (set m_o_shaft_hunter_b override_shaft_elev/hunter_remnant)
    (if
        (= 2 (m_o_shaft_hunter_level_curr))
        (ai_defend override_shaft_elev/hunter_remnant)
    )
    (print_debug "m_o_shaft_elev_hunters: awaiting total hunter death")
    (sleep_until
        (= (ai_living_count override_shaft_elev/hunters) 0)
    )
    (print_debug "m_o_shaft_elev_hunters: both hunters dead")
    (m_o_shaft_hunters_set_2dead)
)


(script static void m_o_shaft_elev_jackals_h_dead
    (print_debug "m_o_shaft_elev_jackals_h_dead: jackals responding to hunter death")
    (print_debug "m_o_shaft_elev_jackals_h_dead: moving jackals to bottom position")
    (ai_command_list_advance override_shaft_elev/jackals)
    (skip_frame)
    (ai_migrate override_shaft_elev/jackals_guard_top override_shaft_elev/jackals_guard_bottom)
    (ai_migrate override_shaft_elev/jackals_forward_top override_shaft_elev/jackals_forward_bottom)
    (ai_command_list override_shaft_elev/jackals ov_shaft_elev_jackals_mig_d)
    (print_debug "m_o_shaft_elev_jackals_h_dead: waiting for jackals / player to arrive")
    (sleep_until
        (or
            (volume_test_objects override_shaft_elev_hall_top (ai_actors override_shaft_elev/jackals))
            (volume_test_players_any override_shaft_elev_hall)
        )
        15
    )
    (print_debug "m_o_shaft_elev_jackals_h_dead: combat engaged")
    (ai_command_list_advance override_shaft_elev/jackals)
    (ai_braindead override_shaft_elev/jackals_forward_top 0)
    (ai_braindead override_shaft_elev/jackals_forward_bottom 0)
)


(script static void m_o_shaft_elev_jackals_p_hall
    (print_debug "m_o_shaft_elev_jackals_p_hall: jackals responding to player in hall")
    (print_debug "m_o_shaft_elev_jackals_h_dead: combat engaged")
    (ai_command_list_advance override_shaft_elev/jackals)
    (ai_braindead override_shaft_elev/jackals_forward_top 0)
    (ai_braindead override_shaft_elev/jackals_forward_bottom 0)
    (skip_frame)
    (ai_magically_see_players override_shaft_elev/jackals_guard_top)
    (ai_magically_see_players override_shaft_elev/jackals_forward_top)
    (skip_frame)
    (print_debug "m_o_shaft_elev_jackals_h_dead: playing ambush command lists")
    (ai_command_list override_shaft_elev/jackals_forward_top ov_shaft_elev_jackals_mig_t_l)
)


(script dormant m_o_shaft_elev_jackals
    (print_debug "m_o_shaft_elev_jackals: awake")
    (if
        (game_is_impossible)
        (begin
            (ai_place override_shaft_elev/brute_guard_imposs)
            (ai_place override_shaft_elev/brutes_forward_imposs)
            (ai_migrate override_shaft_elev/brute_guard_imposs override_shaft_elev/jackals_guard_top)
            (ai_migrate override_shaft_elev/brutes_forward_imposs override_shaft_elev/jackals_forward_top)
        )
        (if
            (game_is_easy)
            (ai_place override_shaft_elev/brutes_easy)
            (if
                1
                (begin
                    (ai_place override_shaft_elev/jackals_guard_top)
                    (ai_place override_shaft_elev/jackals_forward_top)
                )
            )
        )
    )
    (ai_braindead override_shaft_elev/jackals_forward_top 1)
    (print_debug "m_o_shaft_elev_jackals: waiting for encounter to be alerted")
    (sleep_until (m_o_shaft_encounter_alert))
    (print_debug "m_o_shaft_elev_jackals: encounter alerted, sending jackals to top")
    (ai_command_list_by_unit (ai_actor override_shaft_elev/jackals_guard_top 0) ov_shaft_elev_jackals_up_0)
    (ai_command_list_by_unit (ai_actor override_shaft_elev/jackals_guard_top 1) ov_shaft_elev_jackals_up_1)
    (print_debug "m_o_shaft_elev_jackals: waiting for signal to advance")
    (sleep_until
        (if
            (m_o_shaft_hunters_1dead)
            (begin (m_o_shaft_elev_jackals_h_dead) 1)
            (if
                (volume_test_players_any override_shaft_elev_hall)
                (begin (m_o_shaft_elev_jackals_p_hall) 1)
                (if 1 0 0)
            )
        )
    )
)


(script continuous m_o_shaft_elev_rescue_witch
    (sleep_until m_o_shaft_elev_rescue_start 1)
    (if
        (= 0 (ai_living_count override_shaft_elev))
        (sleep -1)
        (if
            (>= m_o_shaft_elev_rescue_idx (ai_living_count override_shaft_elev))
            (set m_o_shaft_elev_rescue_idx 0)
        )
    )
    (set m_o_shaft_elev_rescue_unit (ai_actor override_shaft_elev m_o_shaft_elev_rescue_idx))
    (if
        (volume_test_object override_shaft_elev_danger1 m_o_shaft_elev_rescue_unit)
        (begin
            (print_debug "m_o_shaft_elev_rescue_witch: rescuing unit from danger zone 1")
            (if x_dbg_enabled (inspect m_o_shaft_elev_rescue_idx))
            (ai_command_list_by_unit m_o_shaft_elev_rescue_unit ov_shaft_elev_rescue_1)
            (print_debug "m_o_shaft_elev_rescue_witch: pausing to let unit move")
            (skip_second)
        )
        (if
            (volume_test_object override_shaft_elev_danger2 m_o_shaft_elev_rescue_unit)
            (begin
                (print_debug "m_o_shaft_elev_rescue_witch: may need to rescue unit from danger zone 2...")
                (if x_dbg_enabled (inspect m_o_shaft_elev_rescue_idx))
                (skip_second)
                (if
                    (volume_test_object override_shaft_elev_danger2 m_o_shaft_elev_rescue_unit)
                    (begin
                        (print_debug "m_o_shaft_elev_rescue_witch: rescuing unit from danger zone 2")
                        (ai_command_list_by_unit m_o_shaft_elev_rescue_unit ov_shaft_elev_rescue_2)
                        (print_debug "m_o_shaft_elev_rescue_witch: pausing to let unit move")
                        (skip_second)
                    )
                )
            )
            (if
                (volume_test_objects override_shaft_elev_danger3 (ai_actors override_shaft_elev/hunters))
                (begin
                    (print_debug "m_o_shaft_elev_rescue_witch: secretly disabling hunter-blocking pathfinding")
                    (object_destroy ov_shaft_enter_crateblocker1)
                    (if
                        (volume_test_players_all override_shaft_elev_fulltop)
                        (begin
                            (if
                                (volume_test_objects override_shaft_elev_danger3 (ai_actors m_o_shaft_hunter_a))
                                (ai_command_list m_o_shaft_hunter_a ov_shaft_elev_rescue_3)
                            )
                            (if
                                (volume_test_objects override_shaft_elev_danger3 (ai_actors m_o_shaft_hunter_b))
                                (ai_command_list m_o_shaft_hunter_b ov_shaft_elev_rescue_3)
                            )
                        )
                    )
                    (print_debug "m_o_shaft_elev_rescue_witch: waiting for danger to pass")
                    (sleep_until
                        (not
                            (volume_test_objects override_shaft_elev_danger3 (ai_actors override_shaft_elev/hunters))
                        )
                        30
                        300
                    )
                    (print_debug "m_o_shaft_elev_rescue_witch: danger passed; secretly restoring real nutblocker")
                    (object_create ov_shaft_enter_crateblocker1)
                )
                (if
                    (and
                        (volume_test_objects override_shaft_elev_fullbot (ai_actors override_shaft_elev/hunters))
                        (volume_test_players_all override_shaft_elev_fulltop)
                    )
                    (begin
                        (print_debug "m_o_shaft_elev_rescue_witch: hunter fell below players, granting magic sight")
                        (ai_magically_see_players override_shaft_elev/hunters)
                    )
                )
            )
        )
    )
    (if
        (and
            (>= 0.400000 (device_get_position ext_cave_hunter_lift))
            (<= 0.250000 (device_get_position ext_cave_hunter_lift))
            (= 1 (m_o_shaft_hunter_level_dest))
        )
        (begin
            (if
                (volume_test_object override_shaft_elev_bot (player0))
                (damage_object cmt\globals\evolved\damage_effects\guaranteed_death (player0))
            )
            (if
                (volume_test_object override_shaft_elev_bot (player1))
                (damage_object cmt\globals\evolved\damage_effects\guaranteed_death (player1))
            )
        )
    )
    (set m_o_shaft_elev_rescue_idx (+ 1.000000 m_o_shaft_elev_rescue_idx))
    (sleep 10)
)


(script continuous m_o_shaft_elev_automig
    (sleep_until m_o_shaft_elev_automig_start 1)
    (if
        (and
            (not (m_o_shaft_hunters_1dead))
            (= 1 (m_o_shaft_hunter_level_dest))
            (or
                (volume_test_players_all override_shaft_elev_hall_top)
                (volume_test_players_all override_shaft_elev_fulltop)
                (and
                    (volume_test_players_any override_shaft_elev_hall_top)
                    (volume_test_players_any override_shaft_elev_fulltop)
                )
            )
        )
        (begin (print_debug "m_o_shaft_elev_automig: hunters at l1 / players at l2, sending hunters up") (m_o_shaft_hunters_set_dest_l2))
    )
    (if
        (and
            (not (m_o_shaft_hunters_1dead))
            (= 2 (m_o_shaft_hunter_level_dest))
            (or
                (volume_test_players_all override_shaft_elev_hall_bot)
                (volume_test_players_all override_shaft_elev_fullbot)
                (and
                    (volume_test_players_any override_shaft_elev_hall_bot)
                    (volume_test_players_any override_shaft_elev_fullbot)
                )
            )
        )
        (begin (print_debug "m_o_shaft_elev_automig: hunters at l2 / players at l1, sending hunters down") (m_o_shaft_hunters_set_dest_l1))
    )
    (sleep_until
        (= (m_o_shaft_hunter_level_curr) (m_o_shaft_hunter_level_dest))
        1
    )
    (if
        (and
            (not (m_o_shaft_player_hall_prev))
            (volume_test_players_all override_shaft_elev_hall)
        )
        (begin
            (print_debug "m_o_shaft_elev_automig: player newly in hall")
            (m_o_shaft_player_set_hall)
            (if
                (not (m_o_shaft_hunters_1dead))
                (begin
                    (print_debug "m_o_shaft_elev_automig: hunters backing off")
                    (ai_defend override_shaft_elev/hunters)
                    (ai_allow_charge override_shaft_elev/hunters 0)
                    (print_debug "m_o_shaft_elev_automig: l1 hunters moving away")
                    (ai_command_list override_shaft_elev/hunter_guard ov_shaft_elev_hunter_backoff)
                    (ai_command_list override_shaft_elev/hunter_chase ov_shaft_elev_hunter_backoff)
                    (ai_command_list override_shaft_elev/hunter_guard_top ov_shaft_elev_hunter_backoff_t)
                    (ai_command_list override_shaft_elev/hunter_chase_top ov_shaft_elev_hunter_backoff_t)
                )
            )
        )
    )
    (if
        (and
            (m_o_shaft_player_hall_prev)
            (not (volume_test_players_all override_shaft_elev_hall))
        )
        (begin
            (print_debug "m_o_shaft_elev_automig: player newly outside hall")
            (m_o_shaft_player_set_nonhall)
            (if
                (not (m_o_shaft_hunters_1dead))
                (begin
                    (print_debug "m_o_shaft_elev_automig: hunters attacking")
                    (ai_attack override_shaft_elev/hunters)
                    (ai_allow_charge override_shaft_elev/hunters 1)
                )
            )
        )
    )
    (if
        (volume_test_players_any override_shaft_elev_fullbot)
        (begin
            (print_debug "m_o_shaft_elev_automig: grunts taking bottom floor positions")
            (ai_migrate override_shaft_elev/grunts_main_top override_shaft_elev/grunts_guard_main)
            (ai_migrate override_shaft_elev/grunts_back_top override_shaft_elev/grunts_guard_back)
        )
        (if
            (volume_test_players_any override_shaft_elev_fulltop)
            (begin
                (print_debug "m_o_shaft_elev_automig: jackalsquad taking top floor positions")
                (ai_migrate override_shaft_elev/jackals_guard_bottom override_shaft_elev/jackals_guard_top)
                (ai_migrate override_shaft_elev/jackals_forward_bottom override_shaft_elev/jackals_forward_top)
            )
        )
    )
    (if
        (volume_test_players_all override_shaft_elev_fullbot)
        (begin
            (print_debug "m_o_shaft_elev_automig: jackalsquad taking bottom floor positions")
            (ai_migrate override_shaft_elev/jackals_guard_top override_shaft_elev/jackals_guard_bottom)
            (ai_migrate override_shaft_elev/jackals_forward_top override_shaft_elev/jackals_forward_bottom)
        )
        (if
            (volume_test_players_all override_shaft_elev_fulltop)
            (begin
                (print_debug "m_o_shaft_elev_automig: grunts taking top floor positions")
                (ai_migrate override_shaft_elev/grunts_guard_main override_shaft_elev/grunts_main_top)
                (ai_migrate override_shaft_elev/grunts_guard_back override_shaft_elev/grunts_back_top)
                (ai_migrate override_shaft_elev/grunts_guard_right override_shaft_elev/grunts_back_top)
                (print_debug "m_o_shaft_elev_automig: hunter survivor defending")
                (if (m_o_shaft_hunters_1dead) (ai_defend override_shaft_elev/hunters))
            )
        )
    )
    (sleep 10)
)


(script static void m_o_shaft_elev_sleep_all
    (sleep -1 m_o_shaft_elev_l1_to_l2)
    (sleep -1 m_o_shaft_elev_l2_to_l1)
    (sleep -1 m_o_shaft_elev_hunters)
    (sleep -1 m_o_shaft_elev_jackals)
    (sleep -1 m_o_shaft_elev_rescue_witch)
    (sleep -1 m_o_shaft_elev_automig)
)


(script dormant m_o_shaft_elev
    (print_debug "m_override_shaft: waiting for player at cave entrance")
    (sleep_until (volume_test_players_any override_shaft_door))
    (print_debug "m_o_shaft_elev: player at cave entrance, activated")
    (set m_o_shaft_elev_state s_e_active)
    (player_effect_set_max_translation 0.000000 0.000000 0.000000)
    (player_effect_set_max_rotation 0.000000 0.000000 0.000000)
    (player_effect_set_max_vibrate 0.400000 0.200000)
    (game_save_no_timeout)
    (ai_place override_shaft_elev/grunts_guard_main)
    (ai_place override_shaft_elev/grunts_guard_back)
    (ai_place override_shaft_elev/grunts_guard_right)
    (wake m_o_shaft_elev_hunters)
    (wake m_o_shaft_elev_jackals)
    (ai_set_current_state override_shaft_elev/grunts_guard_back move_random)
    (ai_set_current_state override_shaft_elev/grunts_guard_right move_random)
    (ai_set_current_state override_shaft_elev/jackals_guard_top move_random)
    (print_debug "m_o_shaft_elev: waiting for player to alert encounter")
    (sleep_until
        (or
            (volume_test_players_any override_shaft_elev_near_r)
            (volume_test_players_any override_shaft_elev_near_b)
            (volume_test_players_any override_shaft_elev_hall)
            (> (ai_status override_shaft_elev) 3)
        )
        10
    )
    (print_debug "m_o_shaft_elev: player moving or guards alerted")
    (set m_o_shaft_elev_state s_e_guards_alert)
    (m_o_shaft_encounter_set_alert)
    (print_debug "m_o_shaft_elev: waiting to activate hunters")
    (sleep_until
        (or
            (volume_test_players_any override_shaft_elev_near_r)
            (volume_test_players_any override_shaft_elev_near_b)
            (volume_test_players_any override_shaft_elev_hall)
            (and
                (< (ai_living_count override_shaft_elev/grunts_guard_main) 2)
                (< (ai_living_count override_shaft_elev/grunts_guard_back) 2)
                (< (ai_living_count override_shaft_elev/grunts_guard_right) 2)
            )
        )
        10
    )
    (print_debug "m_o_shaft_elev: player moving or guards mostly dead; hunters going into action")
    (set m_o_shaft_elev_state s_e_hunters_active)
    (set m_o_shaft_elev_rescue_start 1)
    (set m_o_shaft_elev_automig_start 1)
    (game_save_no_timeout)
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_06_security)
    (music_start cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_07_hunters)
    (m_o_shaft_hunters_set_active)
    (print_debug "m_o_shaft_elev: guards going on defensive")
    (ai_defend override_shaft_elev/grunts_guard_main)
    (ai_defend override_shaft_elev/grunts_guard_back)
    (ai_defend override_shaft_elev/grunts_guard_right)
    (print_debug "m_o_shaft_elev: waiting for major progress")
    (sleep_until
        (or (m_o_shaft_hunters_1dead) (volume_test_players_any override_shaft_elev_hall_bot))
    )
    (print_debug "m_o_shaft_elev: major progress achieved")
    (set m_o_shaft_elev_state s_e_major_progress)
    (game_save_no_timeout)
    (print_debug "m_o_shaft_elev: awaiting hunter death")
    (sleep_until (m_o_shaft_hunters_1dead))
    (print_debug "m_o_shaft_elev: a hunter was killed")
    (set m_o_shaft_elev_state s_e_one_hunter_dead)
    (game_save_no_timeout)
    (music_alt cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_07_hunters)
    (print_debug "m_o_shaft_elev: awaiting total hunter death")
    (sleep_until (m_o_shaft_hunters_2dead))
    (print_debug "m_o_shaft_elev: both hunters dead")
    (set m_o_shaft_elev_state s_e_both_hunters_dead)
    (game_save_no_timeout)
    (print_debug "m_o_shaft_elev: deactivating management scripts and making remaining guards attack")
    (m_o_shaft_elev_sleep_all)
    (ai_command_list_advance override_shaft_elev/jackals)
    (ai_braindead override_shaft_elev/jackals_forward_top 0)
    (ai_braindead override_shaft_elev/jackals_forward_bottom 0)
    (ai_attack override_shaft_elev/grunts_guard_main)
    (ai_attack override_shaft_elev/grunts_guard_back)
    (ai_attack override_shaft_elev/grunts_guard_right)
    (sleep (random_range 30 90))
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_07_hunters)
    (if
        (not mission_security_unlocked)
        (music_start cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_07a_hunters_end)
    )
    (print_debug "m_o_shaft_elev: awaiting total death")
    (sleep_until
        (= (ai_living_count override_shaft_elev) 0)
    )
    (print_debug "m_o_shaft_elev: all units dead")
    (set m_o_shaft_elev_state s_e_finished)
    (game_save_no_timeout)
)


(script continuous m_o_shaft_server_updater
    (sleep_until m_o_shaft_server_updater_start 1)
    (if
        (volume_test_players_all override_shaft_server_a)
        (begin
            (ai_migrate override_shaft_server/elites override_shaft_server/elites_b)
            (ai_migrate override_shaft_server/jackals override_shaft_server/jackals_f)
            (ai_migrate override_shaft_server/pester_grunts override_shaft_server/pester_a)
            (ai_migrate override_shaft_server/guard_grunts override_shaft_server/guard_front)
        )
        (if
            (volume_test_players_all override_shaft_server_b)
            (begin
                (ai_migrate override_shaft_server/elites override_shaft_server/elites_g)
                (ai_migrate override_shaft_server/jackals override_shaft_server/jackals_b)
                (ai_migrate override_shaft_server/pester_grunts override_shaft_server/pester_b)
                (ai_migrate override_shaft_server/guard_grunts override_shaft_server/guard_back)
            )
            (if
                (volume_test_players_all override_shaft_server_c)
                (begin
                    (ai_migrate override_shaft_server/elites override_shaft_server/elites_f)
                    (ai_migrate override_shaft_server/jackals override_shaft_server/jackals_c)
                    (ai_migrate override_shaft_server/pester_grunts override_shaft_server/pester_c)
                    (ai_migrate override_shaft_server/guard_grunts override_shaft_server/guard_back)
                )
                (if
                    (volume_test_players_all override_shaft_server_d)
                    (begin
                        (ai_migrate override_shaft_server/elites override_shaft_server/elites_c)
                        (ai_migrate override_shaft_server/jackals override_shaft_server/jackals_g)
                        (ai_migrate override_shaft_server/pester_grunts override_shaft_server/pester_d)
                        (ai_migrate override_shaft_server/guard_grunts override_shaft_server/guard_front)
                    )
                    (if
                        (game_is_cooperative)
                        (begin
                            (ai_migrate override_shaft_server/elites override_shaft_server/elites_all)
                            (ai_migrate override_shaft_server/jackals override_shaft_server/jackals_all)
                            (ai_migrate override_shaft_server/pester_grunts override_shaft_server/pester_all)
                            (ai_migrate override_shaft_server/guard_grunts override_shaft_server/guard_all)
                        )
                    )
                )
            )
        )
    )
    (sleep 15)
)


(script dormant m_o_shaft_server
    (print_debug "m_o_shaft_server: awake")
    (print_debug "m_o_shaft_server: spawning ai")
    (if
        (game_is_easy)
        (ai_place override_shaft_server_easy)
        (ai_place override_shaft_server)
    )
    (print_debug "m_o_shaft_server: waiting for player to approach servers")
    (sleep_until (volume_test_players_any override_shaft_server_a) 1)
    (print_debug "m_o_shaft_server: player approached servers")
    (game_save_no_timeout)
    (print_debug "m_o_shaft_server: waiting for player to alert guards or slip away")
    (sleep_until
        (or
            (< 4 (ai_status override_shaft_server))
            (volume_test_players_any override_shaft_transition)
        )
    )
    (print_debug "m_o_shaft_server: player alerted guards")
    (set m_o_shaft_server_updater_start 1)
    (print_debug "m_o_shaft_server: waiting for completion")
    (sleep_until
        (or
            (= 0 (ai_living_count override_shaft_server))
            (volume_test_players_any override_shaft_transition)
        )
    )
    (print_debug "m_o_shaft_server: server finished")
    (sleep -1 m_o_shaft_server_updater)
    (game_save_no_timeout)
)


(script dormant m_override_shaft
    (print_debug "m_override_shaft: awake")
    (print_debug "m_override_shaft: wait for the player to enter building")
    (sleep_until (volume_test_players_any override_shaft_server_entrance) 10)
    (print_debug "m_override_shaft: player entered the building")
    (set m_override_shaft_state s_active)
    (garbage_collect_now)
    (game_save_no_timeout)
    (wake m_o_shaft_server)
    (music_start cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_06_security)
    (print_debug "m_override_shaft: waiting for server completion")
    (sleep_until
        (or
            (= 0 (ai_living_count override_shaft_server))
            (volume_test_players_any override_shaft_transition)
        )
        10
    )
    (print_debug "m_override_shaft: server room done, setting up corridor")
    (set m_override_shaft_state s_sv_done)
    (ai_place override_shaft_corridor)
    (music_alt cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_06_security)
    (print_debug "m_override_shaft: waiting for player to enter corridor")
    (sleep_until (volume_test_players_any override_shaft_entrance) 10)
    (print_debug "m_override_shaft: players at corridor")
    (set m_override_shaft_state s_corridor)
    (object_create_anew_containing elev_dude)
    (wake m_o_shaft_elev)
    (print_debug "m_override_shaft: awaiting player at control elevator")
    (sleep_until (volume_test_players_any override_ufo_elev_bot))
    (print_debug "m_override_shaft: player at control elevator")
    (set m_override_shaft_state s_control_approached)
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_06_security)
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_07_hunters)
    (music_start cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_07a_hunters_end)
    (print_debug "m_override_shaft: awaiting security deactivation")
    (sleep_until
        (= 1.000000 (device_group_get position_ext_sec_security_holo))
        1
    )
    (print_debug "m_override_shaft: security deactivated")
    (set m_override_shaft_state s_control_deactivated)
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_07a_hunters_end)
    (print_debug "m_override_shaft: finished")
    (set m_override_shaft_state s_finished)
)


(script dormant m_override_shaft_clean
    (print_debug "m_override_shaft_clean: awake")
    (sleep -1 m_o_shaft_server_updater)
    (sleep -1 m_o_shaft_server)
    (m_o_shaft_elev_sleep_all)
    (sleep -1 m_o_shaft_elev)
    (sleep -1 m_override_shaft)
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_06_security)
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_07_hunters)
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_07a_hunters_end)
    (ai_erase override_shaft_server)
    (ai_erase override_shaft_corridor)
    (ai_erase override_shaft_elev)
)


(script dormant m_override_shaft_return
    (print_debug "m_override_shaft_return: awake")
    (print_debug "m_override_shaft_return: checking for living hunters")
    (if
        (!= 0 (ai_living_count override_shaft_elev/hunters))
        (begin
            (print_debug "m_override_shaft_return: hunters still alive, they will wait for the player after the bsp switch")
            (sleep_until (= bsp_index_ext_cave (structure_bsp_index)))
            (print_debug "m_override_shaft_return: waiting for bsp switch")
            (ai_command_list_advance override_shaft_elev)
            (ai_migrate override_shaft_elev/hunter_guard override_shaft_elev/hunter_guard_top)
            (ai_migrate override_shaft_elev/hunter_chase override_shaft_elev/hunter_chase_top)
            (ai_command_list override_shaft_elev/hunter_guard_top return_shaft_elev_hunter_1)
            (ai_command_list override_shaft_elev/hunter_chase_top return_shaft_elev_hunter_2)
            (ai_command_list override_shaft_elev/hunter_remnant return_shaft_elev_hunter_2)
            (m_o_shaft_hunters_set_curr_l2)
            (m_o_shaft_hunters_set_dest_l2)
            (device_set_position_immediate ext_cave_hunter_lift 1.000000)
            (sleep_until
                (>
                    2.000000
                    (objects_distance_to_flag (players) i_should_be_a_trigger_volume)
                )
            )
            (ai_magically_see_players override_shaft_elev)
        )
    )
)


(script static void m_override_shaft_startup
    (print_debug m_override_shaft_startup)
    (wake m_override_shaft)
)


(script static void m_override_shaft_cleanup
    (print_debug m_override_shaft_cleanup)
    (wake m_override_shaft_clean)
)


(script static void m_override_shaft_mark_return
    (print_debug m_override_shaft_mark_return)
    (wake m_override_shaft_return)
)


(script dormant m_override_cliffs_phantom
    (sleep_until (volume_test_players_any override_cliffs_entrance) 1)
    (vehicle_unload override_cliffs_cship_grav phantom)
    (skip_second)
    (ai_command_list override_cliffs_fodder_jump override_cliffs_phantom_drop)
    (sleep 150)
    (ai_command_list_advance override_cliffs_fodder_jump)
    (unit_close override_cliffs_cship_grav)
    (unit_set_desired_flashlight_state override_cliffs_cship_grav 0)
    (vehicle_hover override_cliffs_cship 0)
    (recording_play_and_delete override_cliffs_cship override_cliffs_cship_out)
)


(script static boolean (active_vehicle_in_volume (vehicle my_vehicle) (trigger_volume volume))
    (and
        (volume_test_object volume my_vehicle)
        (or
            (= my_vehicle x_car_vehicle_player0)
            (= my_vehicle x_car_vehicle_player1)
        )
    )
)


(script continuous m_override_cliffs_updater
    (sleep_until m_override_cliffs_updater_start 1)
    (if
        (not m_override_cliffs_bowl_broken)
        (begin
            (sleep_until
                (or
                    (and
                        (volume_test_players_any override_cliffs_path_jump)
                        (> 1.000000 (ai_living_fraction override_cliffs_bowl/bowl))
                    )
                    m_override_cliffs_bowl_broken
                )
            )
            (skip_second)
            (if
                (and
                    (volume_test_players_any override_cliffs_path_jump)
                    (<= 3 (ai_status override_cliffs_bowl/bowl))
                )
                (begin
                    (ai_migrate override_cliffs_bowl/bowl_brutes override_cliffs_bowl/brute_pursuit)
                    (ai_migrate override_cliffs_bowl/bowl_brutes_n override_cliffs_bowl/brute_pursuit)
                    (ai_migrate override_cliffs_bowl/bowl_brutes_a override_cliffs_bowl/brute_pursuit)
                    (if
                        (game_is_impossible)
                        (ai_command_list override_cliffs_bowl/high bowl_g_emp)
                    )
                    (sleep_until (not (volume_test_players_any override_cliffs_path_jump)))
                    (ai_migrate override_cliffs_bowl/brute_pursuit override_cliffs_bowl/bowl_brutes)
                )
            )
        )
        (begin
            (if
                (volume_test_players_any override_cliffs_path_bowl)
                (begin
                    (ai_magically_see_players override_cliffs_canyon)
                    (ai_migrate override_cliffs_canyon/low_grunts_spawn override_cliffs_canyon/bowl_grunts)
                    (ai_migrate override_cliffs_canyon/low_fallback override_cliffs_canyon/bowl_grunts)
                    (if
                        (< normal (game_difficulty_get_real))
                        (begin
                            (ai_migrate override_cliffs_canyon/mid_jackal_spawn override_cliffs_canyon/bowl_jackals)
                            (ai_migrate override_cliffs_canyon/mid_advance override_cliffs_canyon/bowl_jackals)
                        )
                    )
                    (if
                        (< hard (game_difficulty_get_real))
                        (ai_migrate override_cliffs_canyon/low_brutes_spawn override_cliffs_canyon/bowl_brutes)
                    )
                    (sleep_until
                        (and
                            (volume_test_players_any override_cliffs_path_canyon)
                            (not (volume_test_players_any override_cliffs_path_bowl))
                        )
                    )
                    (ai_migrate override_cliffs_canyon/bowl_grunts override_cliffs_canyon/low_fallback)
                    (ai_migrate override_cliffs_canyon/bowl_jackals override_cliffs_canyon/mid_advance)
                    (ai_migrate override_cliffs_canyon/bowl_brutes override_cliffs_canyon/low_brutes_spawn)
                )
            )
            (if
                (or
                    (active_vehicle_in_volume ext_drop_hog canyon_grenade_left)
                    (active_vehicle_in_volume override_cliffs_dump_hog canyon_grenade_left)
                )
                (begin
                    (ai_magically_see_players override_cliffs_canyon)
                    (skip_second)
                    (ai_command_list override_cliffs_canyon/low_brutes_spawn canyon_g_emp_left)
                    (ai_command_list override_cliffs_canyon/low_grunts_spawn canyon_g_plasma_left)
                )
            )
            (if
                (or
                    (active_vehicle_in_volume ext_drop_hog canyon_grenade_right)
                    (active_vehicle_in_volume override_cliffs_dump_hog canyon_grenade_right)
                )
                (begin
                    (ai_magically_see_players override_cliffs_canyon)
                    (skip_second)
                    (ai_command_list override_cliffs_canyon/low_brutes_spawn canyon_g_emp_right)
                    (ai_command_list override_cliffs_canyon/low_fallback canyon_g_plasma_right)
                    (ai_command_list override_cliffs_canyon/low_grunts_spawn canyon_g_plasma_right)
                )
            )
        )
    )
    (sleep 30)
)


(script dormant m_override_cliffs_return_friend
    (sleep_until (volume_test_players_any override_cliffs_path_bowl))
    (game_save_no_timeout)
    (sleep_until (volume_test_players_any override_cliffs_path_end))
    (game_save_no_timeout)
)


(script dormant m_override_cliffs
    (create_override_cliffs_cship)
    (unit_set_desired_flashlight_state override_cliffs_cship_grav 1)
    (unit_open override_cliffs_cship_grav)
    (unit_open override_cliffs_cship_gun_l)
    (unit_open override_cliffs_cship_gun_r)
    (if
        (game_is_easy)
        (object_teleport override_cliffs_cship override_cliffs_cship_easy)
        (object_teleport override_cliffs_cship override_cliffs_cship_flag)
    )
    (vehicle_hover override_cliffs_cship 1)
    (sleep_until
        (or
            (volume_test_players_any override_cliffs_entrance)
            (volume_test_players_any override_cliffs_cliff_mid)
        )
    )
    (garbage_collect_now)
    (ai_place override_cliffs_fodder_jump)
    (vehicle_load_magic override_cliffs_cship_grav phantom (ai_actors override_cliffs_fodder_jump))
    (if (game_is_impossible) (ai_place override_cliffs_fodder_cave))
    (wake m_override_cliffs_phantom)
    (game_save_no_timeout)
    (sleep_until (volume_test_players_any override_cliffs_cliff_mid))
    (ai_place override_cliffs_bowl)
    (if
        (game_is_easy)
        (begin
            (ai_erase override_cliffs_bowl/bowl_brutes)
            (ai_erase override_cliffs_bowl/high_brutes)
            (ai_migrate override_cliffs_bowl/bowl_grunts_easy override_cliffs_bowl/bowl_brutes)
            (ai_migrate override_cliffs_bowl/bowl_grunts_easy_high override_cliffs_bowl/high_brutes)
            (ai_migrate override_cliffs_bowl/bowl_jackals_easy override_cliffs_bowl/bowl_jackals)
        )
        (ai_erase override_cliffs_bowl/easy)
    )
    (if
        (game_is_impossible)
        (begin
            (ai_erase override_cliffs_bowl/high_brutes)
            (ai_migrate override_cliffs_bowl/high_brutes_imposs override_cliffs_bowl/high_brutes)
            (ai_migrate override_cliffs_bowl/bowl_jackals_imposs override_cliffs_bowl/bowl_jackals)
        )
        (ai_erase override_cliffs_bowl/bowl_jackals_imposs)
    )
    (sleep_until
        (or
            (volume_test_players_any override_cliffs_path_jump)
            (volume_test_players_any override_cliffs_path_nook)
            (volume_test_players_any override_cliffs_path_bowl)
        )
        5
        300
    )
    (if
        (not
            (or
                (volume_test_players_any override_cliffs_path_jump)
                (volume_test_players_any override_cliffs_path_nook)
                (volume_test_players_any override_cliffs_path_bowl)
            )
        )
        (begin
            (ai_migrate override_cliffs_bowl/nook_grunts_awake override_cliffs_bowl/nook_attacking)
            (ai_migrate override_cliffs_bowl/bowl_brutes override_cliffs_bowl/bowl_brutes_a)
            (ai_magically_see_players override_cliffs_bowl/nook)
        )
    )
    (game_save_no_timeout)
    (sleep_until
        (or
            (volume_test_players_any override_cliffs_path_jump)
            (volume_test_players_any override_cliffs_path_nook)
            (volume_test_players_any override_cliffs_path_bowl)
        )
    )
    (set m_override_cliffs_updater_start 1)
    (if
        (volume_test_players_any override_cliffs_path_jump)
        (begin
            (ai_migrate override_cliffs_bowl/bowl_jackals override_cliffs_bowl/bowl_jackals_c)
            (ai_magically_see_players override_cliffs_bowl)
        )
        (if
            (volume_test_players_any override_cliffs_path_nook)
            (begin
                (ai_migrate override_cliffs_bowl/bowl_brutes override_cliffs_bowl/bowl_brutes_n)
                (ai_migrate override_cliffs_bowl/bowl_brutes_a override_cliffs_bowl/bowl_brutes_n)
                (ai_migrate override_cliffs_bowl/bowl_jackals override_cliffs_bowl/bowl_jackals_b)
            )
        )
    )
    (sleep_until (volume_test_players_any override_cliffs_path_bowl))
    (ai_conversation override_bowl_arrival)
    (ai_place override_cliffs_canyon)
    (if
        (game_is_easy)
        (begin
            (ai_erase override_cliffs_canyon/low_brutes_spawn)
            (ai_erase override_cliffs_canyon/mid_brute_spawn)
            (ai_erase override_cliffs_canyon/high_brutes_spawn)
        )
    )
    (game_save_no_timeout)
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_03_cart_found)
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_04_lockout)
    (ai_migrate override_cliffs_bowl/nook override_cliffs_bowl/bowl_grunts_d)
    (ai_migrate override_cliffs_bowl/bowl_jackals override_cliffs_bowl/bowl_jackals_c)
    (ai_migrate override_cliffs_bowl/bowl_brutes_n override_cliffs_bowl/bowl_brutes)
    (ai_migrate override_cliffs_bowl/bowl_brutes_a override_cliffs_bowl/bowl_brutes)
    (sleep_until
        (or
            (volume_test_players_any override_cliffs_path_bowl_side)
            (volume_test_players_any override_cliffs_path_canyon)
        )
    )
    (if
        (game_is_easy)
        (begin
            (create_override_cliffs_cship)
            (ai_place override_cliffs_brutes_easy)
            (skip_half_second)
            (object_teleport override_cliffs_cship cliffa_easy_cship_flag)
            (vehicle_hover override_cliffs_cship 1)
            (vehicle_load_magic override_cliffs_cship_grav phantom (ai_actors override_cliffs_brutes_easy))
        )
    )
    (game_save_no_timeout)
    (ai_migrate override_cliffs_bowl/bowl_brutes override_cliffs_bowl/high_brutes)
    (ai_migrate override_cliffs_bowl/bowl_jackals_b override_cliffs_bowl/bowl_jackals_c)
    (ai_migrate override_cliffs_bowl/nook_grunts_sleeping override_cliffs_bowl/bowl_jackals_c)
    (ai_migrate override_cliffs_bowl/nook_grunts_awake override_cliffs_bowl/bowl_jackals_c)
    (sleep_until (volume_test_players_any override_cliffs_path_canyon))
    (set m_override_cliffs_bowl_broken 1)
    (wake m_override_cliffs_return_friend)
    (if
        (game_is_easy)
        (begin
            (vehicle_unload override_cliffs_cship_grav phantom)
            (skip_second)
            (ai_migrate override_cliffs_brutes_easy override_cliffs_canyon/mid_advance)
            (unit_close override_cliffs_cship_grav)
            (skip_second)
            (vehicle_hover override_cliffs_cship 0)
            (recording_play_and_delete override_cliffs_cship override_cliffs_cship_out)
        )
    )
    (game_save_no_timeout)
    (ai_migrate override_cliffs_bowl/bowl_brutes override_cliffs_canyon/low_brutes_spawn)
    (sleep_until
        (or
            (volume_test_players_any override_cliffs_side_path)
            (volume_test_players_any override_cliffs_arch_path)
        )
    )
    (if
        (volume_test_players_any override_cliffs_side_path)
        (ai_migrate override_cliffs_canyon/mid override_cliffs_canyon/mid_advance)
        (ai_migrate override_cliffs_canyon/mid override_cliffs_canyon/mid_fallback)
    )
    (ai_migrate override_cliffs_canyon/low override_cliffs_canyon/mid_fallback)
    (ai_migrate override_cliffs_canyon/mid_jackal_snipers override_cliffs_canyon/high_jackal_snipers)
    (sleep_until (volume_test_players_any override_cliffs_path_end))
    (sleep -1 m_override_cliffs_updater)
    (ai_migrate override_cliffs_canyon/high_brutes_spawn override_cliffs_canyon/high_advance)
    (ai_migrate override_cliffs_canyon/mid override_cliffs_canyon/mid_fallback)
    (ai_erase override_cliffs_fodder_cave)
    (ai_erase override_cliffs_fodder_jump)
    (game_save_no_timeout)
    (sleep_until
        (= bsp_index_ext_pool (structure_bsp_index))
        1
    )
    (ai_migrate override_cliffs_canyon override_pool/anchor_right)
)


(script static void m_override_cliffs_startup (wake m_override_cliffs))


(script static void m_override_cliffs_cleanup
    (sleep -1 m_override_cliffs)
    (sleep -1 m_override_cliffs_updater)
)


(script dormant m_override_pool_music
    (music_start cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_05_pool)
    (music_start cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_05a_pool_bass)
    (sleep_until
        (or
            (volume_test_players_any override_pool_past)
            (volume_test_players_any override_cliffs_path_bowl)
            (= 0 (ai_living_count override_pool))
        )
        10
        4500
    )
    (if
        (not (volume_test_players_any override_pool_past))
        (sleep (random_range 30 90))
    )
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_05_pool)
    (sleep_until
        (or
            (volume_test_players_any override_pit_approach_left)
            (volume_test_players_any override_bridge_approach_left)
            (volume_test_players_any override_bridge_approach_right)
        )
        30
        300
    )
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_05a_pool_bass)
)


(script dormant m_override_pool
    (sleep_until
        (or
            (volume_test_players_any override_cliffs_path_end)
            (volume_test_players_any override_cliffs_smartass)
        )
    )
    (sleep_until
        (= bsp_index_ext_pool (structure_bsp_index))
        1
    )
    (sleep 1)
    (game_save_no_timeout)
    (if
        (game_is_easy)
        (begin
            (ai_place override_pool/grunts_easy)
            (ai_migrate override_pool/grunts_easy override_pool/anchor_right_brutes)
        )
        (begin
            (ai_place override_pool/fodder_left_grunts)
            (ai_place override_pool/fodder_right_grunts)
            (ai_place override_pool/anchor_right_grunts)
            (ai_place override_pool/anchor_left_brutes_imposs)
            (ai_place override_pool/anchor_right_brutes_imposs)
            (ai_place override_pool/anchor_left_brutes)
            (ai_place override_pool/anchor_right_brutes)
        )
    )
    (if
        (game_is_impossible)
        (begin
            (ai_erase override_pool/anchor_left_brutes)
            (ai_erase override_pool/anchor_right_brutes)
            (ai_migrate override_pool/anchor_left_brutes_imposs override_pool/anchor_left_brutes)
            (ai_migrate override_pool/anchor_right_brutes_imposs override_pool/anchor_right_brutes)
        )
    )
    (sleep_until (volume_test_players_any override_pool_approach))
    (game_save_no_timeout)
    (ai_magically_see_players override_pool)
    (if
        (game_is_easy)
        (begin
            (ai_place override_pool/hunters_easy)
            (ai_migrate override_pool/hunters_easy override_pool/anchor_left_brutes)
        )
        (begin
            (ai_place override_pool/boss_spawn)
            (ai_place override_pool/boss_support_long)
            (ai_place override_pool/boss_support_grunts)
        )
    )
    (ai_braindead override_pool/boss_spawn 1)
    (wake m_override_pool_music)
    (sleep_until
        (or
            (volume_test_players_any override_pool_enter_back)
            (volume_test_players_any override_pool_enter_side)
            (>
                1.000000
                (unit_get_shield
                    (unit
                        (list_get (ai_actors override_pool/boss_spawn) 0)
                    )
                )
            )
            (> 0.750000 (ai_living_fraction override_pool))
        )
    )
    (game_save_no_timeout)
    (ai_braindead override_pool/boss_spawn 0)
    (ai_migrate override_pool/boss_spawn override_pool/boss)
    (ai_attack override_pool/anchor_right)
    (ai_attack override_pool/anchor_left)
    (ai_berserk override_pool/anchor_right 1)
    (ai_berserk override_pool/anchor_left 1)
    (sleep_until
        (or
            (volume_test_players_any override_pool_past)
            (volume_test_players_any override_cliffs_path_bowl)
            (and
                (= 0 (ai_living_count override_pool/boss))
                (= 0 (ai_living_count override_pool/boss_spawn))
            )
        )
    )
    (game_save_no_timeout)
    (ai_berserk override_pool/fodder_left 1)
    (ai_retreat override_pool/fodder_left)
    (ai_retreat override_pool/fodder_right)
    (ai_migrate override_pool/fodder_center override_pool/fodder_broken)
    (sleep_until
        (or
            (volume_test_players_any override_pool_past)
            (volume_test_players_any override_cliffs_path_bowl)
            (> 3 (ai_living_count override_pool))
        )
    )
    (game_save_no_timeout)
    (sleep_until
        (or
            (volume_test_players_any override_pool_past)
            (= 0 (ai_living_count override_pool))
        )
    )
    (if
        (!= 0 (ai_living_count override_pool))
        (begin
            (ai_migrate override_pool override_vista/pool_cleanup)
            (ai_magically_see_players override_vista)
        )
    )
    (game_save_no_timeout)
)


(script static void m_override_pool_startup (wake m_override_pool))


(script static void m_override_pool_cleanup
    (sleep -1 m_override_pool)
    (sleep -1 m_override_pool_music)
    (ai_erase override_pool)
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_05_pool)
)


(script dormant m_override_vista
    (sleep_until (volume_test_players_any override_pool_rear))
    (ai_place override_vista)
    (if
        (not (game_is_easy))
        (ai_erase override_vista/ridge_snipers)
    )
    (sleep_until (volume_test_players_any override_pool_past))
    (ai_braindead override_vista 0)
    (ai_set_deaf override_vista 0)
    (ai_set_blind override_vista 0)
    (sleep_until
        (or
            (volume_test_players_any override_pit_approach_right)
            (< (ai_status override_vista) 4)
            (volume_test_players_any override_pit_approach_left)
        )
    )
    (ai_migrate override_vista/right_guard_main override_vista/right_guard_main_a)
    (ai_migrate override_vista/right_guard_support override_vista/right_guard_support_e)
    (sleep_until
        (or
            (volume_test_players_any override_bridge_approach_left)
            (volume_test_players_any override_pit_approach_left)
        )
    )
    (game_save_no_timeout)
)


(script static void m_override_vista_startup (wake m_override_vista))


(script static void m_override_vista_cleanup
    (sleep -1 m_override_vista)
    (ai_erase override_vista)
)


(script continuous m_override_pit_updater
    (sleep_until m_override_pit_updater_start 1)
    (if
        (volume_test_players_all override_pit_left)
        (begin
            (ai_migrate override_pit/top_dudes override_pit/top_left)
            (ai_migrate override_pit/snipers override_pit/snipers_structure_left)
            (ai_migrate override_pit/ground_jackals override_pit/ground_jackals_left)
        )
        (if
            (or
                (not (game_is_cooperative))
                (volume_test_players_all override_pit_right)
            )
            (begin
                (ai_migrate override_pit/top_dudes override_pit/top_right)
                (ai_migrate override_pit/snipers override_pit/snipers_structure_right)
                (ai_migrate override_pit/ground_jackals override_pit/ground_jackals_right)
            )
            (if
                (game_is_cooperative)
                (begin
                    (ai_migrate override_pit/top_dudes override_pit/top_all)
                    (ai_migrate override_pit/snipers override_pit/snipers_structure_all)
                    (ai_migrate override_pit/ground_jackals override_pit/ground_jackals_all)
                )
            )
        )
    )
    (if
        (and
            (not (game_is_cooperative))
            (< 4 (ai_status override_pit/top_dudes))
        )
        (begin
            (ai_magically_see_players override_pit/top_dudes)
            (ai_magically_see_players override_pit/bridge_dudes)
        )
    )
    (sleep 30)
)


(script dormant m_override_pit
    (sleep_until (volume_test_players_any override_pool_past))
    (object_create sec_turret_low)
    (if
        (!= normal (game_difficulty_get_real))
        (object_create sec_turret_high)
    )
    (ai_erase override_cliffs_bowl)
    (ai_erase override_cliffs_canyon)
    (ai_place override_pit)
    (if
        (or (game_is_easy) (game_is_impossible))
        (ai_erase override_pit/bridge_left_grunts_lead)
    )
    (if
        x_dbg_enabled
        (inspect (ai_living_count override_pit))
    )
    (game_save_no_timeout)
    (sleep_until
        (or
            (volume_test_players_any override_pit_approach_left)
            (volume_test_players_any override_pit_approach_right)
            (volume_test_players_any override_pit_left)
            (volume_test_players_any override_pit_right)
            (>= (ai_status override_pit) 4)
        )
    )
    (game_save_no_timeout)
    (ai_go_to_vehicle override_pit/top_grunts sec_turret_high gunner)
    (ai_go_to_vehicle override_pit/ground_grunts sec_turret_low gunner)
    (set m_override_pit_updater_start 1)
    (sleep_until
        (or
            (> 0.900000 (ai_living_fraction override_pit))
            (and
                (volume_test_players_any override_pit_ground_level)
                (<= (ai_status override_pit) 4)
            )
        )
    )
    (game_save_no_timeout)
    (ai_go_to_vehicle override_pit/top_dudes sec_turret_high gunner)
    (ai_go_to_vehicle override_pit/top_retreat sec_turret_high gunner)
    (ai_go_to_vehicle override_pit/ground_guards sec_turret_low gunner)
    (sleep_until
        (or
            (volume_test_players_any override_pit_mid_level)
            (volume_test_players_any override_pit_ground_level)
        )
    )
    (garbage_collect_now)
    (game_save_no_timeout)
    (ai_migrate override_pit/ground_jackals_init override_pit/ground_jackals_left)
    (sleep_until
        (and
            (> 0.750000 (ai_living_fraction override_pit))
            (volume_test_players_any override_pit_ground_level)
        )
    )
    (game_save_no_timeout)
    (ai_migrate override_pit/ground_elites override_pit/ground_grunts)
    (if
        (and
            (> 2 (ai_living_count override_pit/ground_jackals))
            (> 2 (ai_living_count override_pit/ground_jackals_init))
        )
        (begin
            (ai_place override_pit/ground_jackals_init)
            (ai_migrate override_pit/ground_jackals_init override_pit/ground_jackals_left)
        )
    )
    (sleep_until
        (or
            (> 3 (ai_living_count override_pit/ground_guards))
            (volume_test_players_any override_shaft_server_entrance)
        )
    )
    (ai_migrate override_pit/ground_guards override_pit/ground_cleanup)
    (sleep -1 m_override_pit_updater)
    (game_save_no_timeout)
)


(script static void m_override_pit_startup (wake m_override_pit))


(script static void m_override_pit_cleanup
    (sleep -1 m_override_pit)
    (ai_erase override_pit)
)


(script static void m_override_pit_mark_return
    (ai_erase override_pit/top_dudes)
    (ai_erase override_pit/snipers)
    (ai_erase override_pit/top_retreat)
    (ai_erase override_pit/left_cliffs)
)


(script continuous m_override_bridge_updater
    (ai_command_list_advance override_bridge/core_elites)
    (if
        (volume_test_players_all override_bridge_left_side)
        (begin
            (ai_migrate override_bridge/right_side_elites override_bridge/left_side_elites)
            (ai_migrate override_bridge/right_side_grunts override_bridge/left_side_grunts)
            (ai_migrate override_bridge/right_front_elites override_bridge/left_side_elites)
            (ai_migrate override_bridge/right_front_grunts override_bridge/left_side_grunts)
            (ai_migrate override_bridge/perimeter_elites override_bridge/left_side_elites)
            (ai_migrate override_bridge/perimeter_grunts override_bridge/left_side_grunts)
        )
        (if
            (volume_test_players_all override_bridge_right_side)
            (begin
                (ai_migrate override_bridge/left_side_elites override_bridge/right_side_elites)
                (ai_migrate override_bridge/left_side_grunts override_bridge/right_side_grunts)
                (ai_migrate override_bridge/right_front_elites override_bridge/right_side_elites)
                (ai_migrate override_bridge/right_front_grunts override_bridge/right_side_grunts)
                (ai_migrate override_bridge/perimeter_elites override_bridge/right_side_elites)
                (ai_migrate override_bridge/perimeter_grunts override_bridge/right_side_grunts)
            )
            (if
                (volume_test_players_all override_bridge_right_front)
                (begin
                    (ai_migrate override_bridge/right_side_elites override_bridge/right_front_elites)
                    (ai_migrate override_bridge/right_side_grunts override_bridge/right_front_grunts)
                    (ai_migrate override_bridge/left_side_elites override_bridge/right_front_elites)
                    (ai_migrate override_bridge/left_side_grunts override_bridge/right_front_grunts)
                    (ai_migrate override_bridge/perimeter_elites override_bridge/right_front_elites)
                    (ai_migrate override_bridge/perimeter_grunts override_bridge/right_front_grunts)
                )
                (if
                    (game_is_cooperative)
                    (begin
                        (ai_migrate override_bridge/left_side_elites override_bridge/perimeter_elites)
                        (ai_migrate override_bridge/left_side_grunts override_bridge/perimeter_grunts)
                        (ai_migrate override_bridge/right_side_elites override_bridge/perimeter_elites)
                        (ai_migrate override_bridge/right_side_grunts override_bridge/perimeter_grunts)
                        (ai_migrate override_bridge/right_front_elites override_bridge/perimeter_elites)
                        (ai_migrate override_bridge/right_front_grunts override_bridge/perimeter_grunts)
                    )
                )
            )
        )
    )
    (sleep 60)
)


(script dormant m_override_bridge
    (sleep_until
        (or
            (volume_test_players_any override_pool_rear)
            (volume_test_players_any override_bridge_approach_left)
            (volume_test_players_any override_bridge_approach_right)
            (volume_test_players_any override_cliffs_smartass)
        )
    )
    (object_create_containing dump_bridge)
    (ai_place override_bridge)
    (if
        (game_is_easy)
        (ai_erase override_bridge/core_elites)
        (ai_erase override_bridge/hunters_easy)
    )
    (object_create bridge_turret_1)
    (sleep_until
        (or
            (volume_test_players_any override_bridge_approach_left)
            (volume_test_players_any override_bridge_approach_right)
        )
    )
    (ai_go_to_vehicle override_bridge/core_turret_grunts bridge_turret_1 gunner)
    (sleep_until
        (or
            (> 1.000000 (ai_living_fraction override_bridge))
            (<= 4 (ai_status override_bridge))
            (volume_test_players_any return_downed_main)
        )
    )
    (game_save_no_timeout)
    (ai_go_to_vehicle override_bridge/core_grunts bridge_turret_1 gunner)
    (set m_override_bridge_updater_start 1)
    (sleep_until
        (or
            (> 0.660000 (ai_living_fraction override_bridge))
            (volume_test_players_any end_bridge)
        )
    )
    (ai_migrate override_bridge/patrol override_bridge/left_side_grunts)
    (ai_go_to_vehicle override_bridge/core_elites bridge_turret_1 gunner)
    (sleep_until
        (or
            (> 0.330000 (ai_living_fraction override_bridge))
            (volume_test_players_any end_bridge)
        )
    )
    (game_save_no_timeout)
    (ai_migrate override_bridge override_bridge/core_turret_grunts)
    (sleep_until
        (or
            (= 0 (ai_living_count override_bridge))
            (volume_test_players_any end_bridge)
        )
    )
    (game_save_no_timeout)
    (sleep -1 m_override_bridge_updater)
)


(script dormant m_override_bridge_returning
    (ai_set_current_state override_bridge search)
    (ai_renew override_bridge)
    (sleep_until (volume_test_players_any override_bridge_left_side))
    (ai_magically_see_players override_bridge)
    (game_save_no_timeout)
)


(script static void m_override_bridge_startup (wake m_override_bridge))


(script static void m_override_bridge_cleanup
    (sleep -1 m_override_bridge)
    (sleep -1 m_override_bridge_updater)
    (sleep -1 m_override_bridge_returning)
    (ai_erase override_bridge)
    (object_destroy bridge_turret_1)
)


(script static void m_override_bridge_mark_return (wake m_override_bridge_returning))


(script dormant m_override_chapter_cart_lock
    (game_save_no_timeout)
    (if
        (game_is_easy)
        (ai_conversation override_known_locked_special)
        (ai_conversation override_known_locked)
    )
    (sleep_until
        (or
            (volume_test_players_any ext_cart_entrance_hall)
            (<= (ai_living_count override_locked) 1)
        )
        1
    )
    (sleep 120)
    (cinematic_show_letterbox 1)
    (show_hud 0)
    (music_start cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_04_lockout)
    (sleep 60)
    (cinematic_set_title locked)
    (sleep 300)
    (cinematic_show_letterbox 0)
    (show_hud 1)
    (objective_set dia_override obj_override)
    (sleep 5400)
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_04_lockout)
)


(script dormant m_override_cart_lock
    (if
        (= m_override_cart_lock_state cl_finshed)
        (sleep_forever)
    )
    (sleep_until (= (structure_bsp_index) bsp_index_int_shaft_a))
    (set m_override_cart_lock_state cl_in_bsp)
    (if
        (or
            mission_security_unlocked
            (= 1.000000 (device_group_get power_security))
        )
        (sleep_forever)
    )
    (ai_place override_locked)
    (ai_braindead override_locked/locker_elite 1)
    (object_cannot_take_damage
        (list_get (ai_actors override_locked/locker_elite) 0)
    )
    (sleep_until (volume_test_players_any override_lock_window) 1)
    (set m_override_cart_lock_state cl_at_window)
    (game_save_no_timeout)
    (if
        mission_security_unlocked
        (begin (ai_erase override_locked/locker_elite) (sleep_forever))
    )
    (ai_conversation_stop ext_cart_entered)
    (ai_conversation_stop ext_cart_deep)
    (ai_conversation override_lock_alert)
    (ai_command_list override_locked/locker_elite override_lock)
    (sleep_until
        (or
            (> 4 (ai_living_count override_locked))
            (volume_test_players_any override_lock_slam)
            (volume_test_players_any ext_cart_main)
        )
        1
        30
    )
    (set m_override_cart_lock_state cl_locking)
    (ai_command_list_advance override_locked/locker_elite)
    (skip_half_second)
    (set m_override_cart_lock_state cl_locked)
    (device_set_position int_shaft_a_override_door 0.000000)
    (set m_override_known_locked 1)
    (sleep 90)
    (set m_override_cart_lock_state cl_postlock)
    (wake m_override_chapter_cart_lock)
    (set m_override_cart_lock_state cl_finshed)
)


(script dormant m_override_cart_lock_sbrk
    (sleep_until
        (and
            (= mission_state mission_cartographer_entered)
            (not mission_security_unlocked)
        )
        1
    )
    (game_save_cancel)
    (sleep -1 m_override_cart_lock)
    (sleep -1 m_override_chapter_cart_lock)
    (cinematic_show_letterbox 0)
    (show_hud 1)
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_04_lockout)
    (ai_erase override_locked/locker_elite)
    (device_set_position int_shaft_a_override_door 1.000000)
    (ai_conversation_stop override_lock_alert)
    (ai_conversation_stop override_known_locked)
    (ai_conversation wtf)
    (set m_override_known_locked 1)
    (if
        (game_is_easy)
        (objective_set dia_found_ez obj_found_ez)
        (objective_set dia_found obj_found)
    )
    (sleep_until (volume_test_players_any ext_beach_2_dumb) 1)
    (ai_conversation wtf2)
)


(script static void m_override_setup_return
    (ai_place return_downed_waterfall_fake)
    (ai_vehicle_enterable_distance return_downed_wraith 20.000000)
    (ai_vehicle_enterable_team return_downed_wraith covenant)
    (ai_vehicle_encounter return_downed_wraith r_downed_wrth_ext_sec-cave/b)
    (vehicle_load_magic return_downed_wraith driver (ai_actors return_downed_waterfall_fake/wraith_pilot))
)


(script dormant m_override_cutscene_unlock_effe
    (player_effect_set_max_translation 0.000000 0.000000 0.000000)
    (player_effect_set_max_rotation 0.000000 0.000000 0.000000)
    (player_effect_set_max_vibrate 0.150000 0.150000)
    (sleep 75)
    (player_effect_start 1.000000 0.100000)
    (player_effect_stop 0.400000)
    (sleep 70)
    (player_effect_start 1.000000 0.100000)
    (player_effect_stop 0.400000)
    (sleep 70)
    (player_effect_start 0.800000 0.100000)
    (player_effect_stop 0.400000)
    (sleep 70)
    (player_effect_start 0.250000 0.100000)
    (player_effect_stop 0.400000)
)


(script static void m_override_cutscene_unlock
    (player_enable_input 0)
    (fade_to_white)
    (skip_second)
    (show_hud 0)
    (cinematic_start)
    (camera_control 1)
    (device_set_position_immediate int_shaft_a_override_door 0.000000)
    (switch_bsp bsp_index_int_shaft_a)
    (object_pvs_activate int_shaft_a_override_door)
    (ai_erase override_locked)
    (ai_place unlock_elite)
    (if (game_is_easy) (ai_place unlock_slaughter))
    (camera_set shaft_switch_1 0)
    (sleep 90)
    (camera_set shaft_switch_3 180)
    (fade_from_white)
    (skip_second)
    (device_set_position int_shaft_a_override_door 1.000000)
    (skip_second)
    (if
        (game_is_easy)
        (begin
            (ai_braindead unlock_elite 0)
            (ai_magically_see_encounter unlock_elite unlock_slaughter)
        )
        (ai_command_list unlock_elite override_unlock)
    )
    (sleep 45)
    (if
        (< mission_state mission_cartographer_entered)
        (if
            m_override_known_locked
            (ai_conversation override_switch_known)
            (if
                (game_is_easy)
                (ai_conversation override_switch_unknow_special)
                (ai_conversation override_switch_unknow)
            )
        )
    )
    (sleep 75)
    (if
        (game_is_easy)
        (fade_out 1.000000 0.000000 0.000000 30)
        (fade_to_white)
    )
    (skip_second)
    (ai_erase unlock_elite)
    (ai_erase unlock_slaughter)
    (switch_bsp bsp_index_ext_bridge)
    (teleport_players player_unlock_wait player_unlock_wait)
    (skip_frame)
    (x_cut_setup_player0 unlock_cyborg_0)
    (unit_set_seat unlock_cyborg_0 alert)
    (if
        (game_is_cooperative)
        (begin
            (x_cut_setup_player1 unlock_cyborg_1)
            (unit_set_seat unlock_cyborg_1 alert)
            (if
                (game_is_easy)
                (object_teleport unlock_cyborg_1 unlock_easy_leave)
            )
        )
    )
    (camera_set cutscene_unlock_1a 0)
    (camera_set cutscene_unlock_1b 220)
    (sleep 5)
    (fade_from_white)
    (device_group_set position_ext_sec_big_bridge 0.000000)
    (wake m_override_cutscene_unlock_effe)
    (skip_second)
    (recording_play unlock_cyborg_0 unlock_cyborg_walk)
    (sleep 105)
    (camera_set cutscene_unlock_1c 150)
    (sleep 150)
    (switch_bsp bsp_index_ext_ufo)
    (camera_set cutscene_unlock_2a 0)
    (camera_set cutscene_unlock_2b 210)
    (if
        (and (game_is_cooperative) (game_is_easy))
        (recording_play unlock_cyborg_1 unlock_cyborg_leave)
    )
    (device_group_set position_ext_sec_security_holo 1.000000)
    (sleep 30)
    (if
        (and
            (game_is_cooperative)
            (not (game_is_easy))
        )
        (custom_animation unlock_cyborg_1 cmt\characters\_shared\cyborg\cinematics\animations\level_specific\b30_revamp\b30_revamp look_with_intent 0)
    )
    (sleep 180)
    (if
        (game_is_easy)
        (fade_out 1.000000 0.000000 0.000000 30)
        (fade_to_white)
    )
    (teleport_players player_unlock_end_0 player_unlock_end_1)
    (x_cut_teardown_player0 unlock_cyborg_0)
    (if (game_is_cooperative) (x_cut_teardown_player1 unlock_cyborg_1))
    (create_override_cliffs_cship)
    (if
        (game_is_easy)
        (object_teleport override_cliffs_cship return_cliffs_cship_flag_easy)
        (object_teleport override_cliffs_cship return_cliffs_cship_flag)
    )
    (recording_play_and_delete override_cliffs_cship return_cliffs_cship_out)
    (camera_control 0)
    (cinematic_stop)
    (cinematic_show_letterbox 1)
    (if
        (game_is_easy)
        (fade_in 1.000000 0.000000 0.000000 60)
        (fade_from_white)
    )
    (skip_second)
    (player_enable_input 1)
    (game_save_totally_unsafe)
    (cinematic_set_title unlocked)
    (sleep 150)
    (show_hud 1)
    (cinematic_show_letterbox 0)
)


(script dormant m_override_unlock
    (print_debug "m_override_unlock: waiting for player to enter ufo control center")
    (sleep_until (volume_test_players_any override_ufo_control))
    (print_debug "m_override_shaft: player at ufo control center")
    (game_save_no_timeout)
    (if
        m_override_known_locked
        (ai_conversation override_switchit_known)
        (if
            (game_is_easy)
            (ai_conversation override_switchit_unkno_special)
            (ai_conversation override_switchit_unknow)
        )
    )
    (sleep_until
        (= 0.000000 (device_get_position ext_sec_security_switch))
        1
    )
    (device_group_set_immediate power_security 1.000000)
    (m_override_cutscene_unlock)
    (set mission_security_unlocked 1)
    (if
        (< mission_state mission_cartographer_activated)
        (sleep -1)
    )
    (music_start cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_24_cruel)
    (sleep 5400)
    (ai_conversation cruel)
)


(script dormant m_override_prereturn
    (sleep_until
        (or
            (volume_test_players_any override_ufo_elev_bot)
            (volume_test_players_any override_ufo_control)
            mission_security_unlocked
        )
    )
    (m_override_setup_return)
)


(script static void m_override_launch_common
    (device_set_position_immediate int_shaft_a_override_door 0.000000)
    (ai_place override_locked/locker_elite)
    (ai_braindead override_locked/locker_elite 1)
    (set m_override_cart_lock_state cl_finshed)
    (set m_override_known_locked 1)
)


(script static void m_override_launch
    (m_override_launch_common)
    (object_create ext_drop_hog)
    (unit_enter_vehicle (ai_actor lz_marines_holding 0) ext_drop_hog w-gunner)
    (unit_enter_vehicle (ai_actor lz_marines_holding 1) ext_drop_hog w-passenger)
    (object_teleport ext_drop_hog m_override_hogspawn)
    (ai_migrate_by_unit (vehicle_riders ext_drop_hog) marines_ext_capp-cart)
    (checkpoint_launch bsp_index_int_shaft_a m_override_spawn_0 m_override_spawn_1)
    (cinematic_show_letterbox 1)
    (show_hud 0)
    (wake m_override_chapter_cart_lock)
)


(script static void m_override_launch_pool
    (m_override_launch_common)
    (checkpoint_launch bsp_index_ext_pool m_override_pool_spawn_0 m_override_pool_spawn_1)
)


(script static void m_override_start
    (print_debug "m_override_start: starting")
    (if
        (= b30r_launch_override mission_launch_index)
        (m_override_launch)
    )
    (if
        (= b30r_launch_override_a mission_launch_index)
        (m_override_launch_pool)
    )
    (wake m_override_cart_lock)
    (wake m_override_cart_lock_sbrk)
    (wake m_override_unlock)
    (wake m_override_prereturn)
    (if
        (!= b30r_launch_override_a mission_launch_index)
        (begin (m_override_cliffs_startup) (m_override_pool_startup))
    )
    (m_override_vista_startup)
    (m_override_pit_startup)
    (m_override_bridge_startup)
    (m_override_shaft_startup)
)


(script static void m_override_clean
    (m_override_cliffs_cleanup)
    (m_override_pool_cleanup)
    (m_override_vista_cleanup)
    (m_override_pit_cleanup)
    (m_override_bridge_cleanup)
    (m_override_shaft_cleanup)
    (device_group_set_immediate position_ext_cave_ufo_elevator 0.000000)
    (object_destroy return_downed_wraith)
)


(script static void m_override_return
    (sleep -1 m_override_cart_lock)
    (m_override_pit_mark_return)
    (m_override_bridge_mark_return)
    (m_override_shaft_mark_return)
)


(script static void m_override_skip
    (set m_override_known_locked 1)
    (set mission_security_unlocked 1)
    (device_group_set_immediate position_ext_cave_hunter_bridge 1.000000)
    (device_group_set_immediate position_ext_cave_ufo_elevator 1.000000)
    (device_set_position ext_sec_security_switch 0.000000)
    (device_group_set_immediate power_security 1.000000)
    (device_group_set_immediate position_ext_sec_big_bridge 0.000000)
    (device_group_set_immediate position_ext_sec_security_holo 1.000000)
    (device_set_position_immediate int_shaft_a_override_door 1.000000)
    (m_override_setup_return)
    (set m_override_cart_lock_state cl_finshed)
)


(script dormant m_override_control
    (if
        (!= m_override_ctrl_state 1)
        (m_override_skip)
        (m_override_start)
    )
    (sleep_until (>= m_override_ctrl_state 3))
    (m_override_return)
    (sleep_until (>= m_override_ctrl_state 4))
    (m_override_clean)
)


(script static void m_override_startup
    (if
        (= 0 m_override_ctrl_state)
        (begin
            (set m_override_ctrl_state 1)
            (wake m_override_control)
        )
    )
)


(script static void m_override_mark_return
    (set m_override_ctrl_state 3)
)


(script static void m_override_cleanup
    (set m_override_ctrl_state 4)
)


(script static void m_override_mark_skip
    (m_override_startup)
    (set m_override_ctrl_state 2)
)


(script dormant m_return_downed_music
    (sleep_until (volume_test_players_any override_bridge_halfway) 1)
    (music_start cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_09_crashsite)
    (set return_downed_music_started 1)
    (sleep_until
        (or
            (volume_test_players_any return_downed_funnel_left)
            (volume_test_players_any return_downed_funnel_right)
        )
    )
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_09_crashsite)
    (if
        (game_is_easy)
        (music_start cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_11b_return_easymode)
        (music_start cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_11_return_hogrun)
    )
    (sleep_until
        (and
            (= (structure_bsp_index) bsp_index_ext_cart)
            (or
                (volume_test_players_any ext_cart_return_approaching)
                (volume_test_players_any ext_cart_terrain_front)
            )
        )
        1
    )
    (music_alt cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_11b_return_easymode)
    (music_alt cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_11_return_hogrun)
    (sleep 300)
    (sleep_until
        (or
            (volume_test_players_any ext_cart_entrance)
            (volume_test_players_any ext_cart_secret_inside)
        )
    )
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_11_return_hogrun)
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_11b_return_easymode)
)


(script continuous m_return_downed_music_fucker
    (sleep_until m_return_downed_music_start 1)
    (sleep_until
        (and
            return_downed_music_started
            (or
                (volume_test_players_any override_pool_past)
                (volume_test_players_any ext_cart_smallgorge)
            )
        )
    )
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_09_crashsite)
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_11_return_hogrun)
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_11b_return_easymode)
    (sleep_until
        (and
            (not (volume_test_players_any override_pool_past))
            (not (volume_test_players_any ext_cart_smallgorge))
        )
    )
)


(script continuous return_cship_harass
    (sleep_until return_cship_start 1)
    (if
        return_cship_leave
        (begin
            (vehicle_hover ext_beach_1_cship 0)
            (recording_play_and_delete ext_beach_1_cship return_cship_out)
            (sleep_forever)
        )
    )
    (phantom_hover_and_bank ext_beach_1_cship)
)


(script dormant m_return_downed
    (game_save_no_timeout)
    (create_ext_beach_1_cship)
    (object_teleport ext_beach_1_cship bridge_flavor_cship_flag_2)
    (vehicle_hover ext_beach_1_cship 1)
    (set return_cship_start 1)
    (garbage_collect_now)
    (object_create bridge_turret_1)
    (sleep_until
        (or
            (volume_test_players_any override_bridge_left_side)
            (volume_test_players_any return_downed_main)
        )
    )
    (game_save_no_timeout)
    (sleep_until
        (or
            (volume_test_players_any override_bridge_left_side)
            (volume_test_players_any return_downed_main)
        )
        1
    )
    (print_debug "m_return_downed: player looks like they're taking the bridge path")
    (ai_place return_downed_marines/crashsite_marines)
    (ai_place return_downed/crashsite_grunts)
    (ai_erase return_downed_waterfall_fake)
    (if
        (game_is_easy)
        (begin
            (ai_place return_downed_marines/crashsite_jerks)
            (ai_set_team return_downed_marines/crashsite_jerks sentinel)
            (ai_place johnson)
        )
    )
    (if
        (or
            (= normal (game_difficulty_get_real))
            (game_is_impossible)
        )
        (ai_place return_downed/crashsite_jackal)
    )
    (if
        (or
            (= hard (game_difficulty_get_real))
            (game_is_impossible)
        )
        (ai_place return_downed/crashsite_elite)
    )
    (ai_try_to_fight return_downed_marines return_downed)
    (ai_playfight return_downed_marines 1)
    (ai_playfight return_downed 1)
    (ai_playfight return_downed_waterfall 1)
    (ai_playfight r_downed_wrth_ext_sec-cave 1)
    (object_cannot_take_damage (ai_actors return_downed_marines))
    (ai_magically_see_encounter return_downed_marines return_downed)
    (ai_magically_see_encounter return_downed return_downed_marines)
    (game_save_no_timeout)
    (sleep_until
        (or
            (volume_test_players_any override_bridge_halfway)
            (volume_test_players_any return_downed_main)
        )
        1
    )
    (ai_place return_downed_waterfall)
    (ai_set_deaf return_downed_waterfall 1)
    (ai_braindead return_downed_waterfall/funnel_left 1)
    (if (game_is_easy) (ai_erase return_downed_waterfall/funnel_right))
    (ai_vehicle_enterable_distance return_downed_wraith 20.000000)
    (ai_vehicle_enterable_team return_downed_wraith covenant)
    (vehicle_load_magic return_downed_wraith driver (ai_actors return_downed_waterfall/wraith_pilot))
    (ai_renew return_downed_marines)
    (ai_go_to_vehicle return_downed_waterfall/shade_pilot return_downed_turret gunner)
    (game_save_no_timeout)
    (sleep_until
        (or
            (volume_test_players_any end_bridge)
            (volume_test_players_any return_downed_main)
        )
        1
    )
    (if
        (game_is_easy)
        (ai_conversation johnson)
        (ai_conversation downed_arrival)
    )
    (ai_allegiance_remove human sentinel)
    (set return_cship_leave 1)
    (ai_playfight return_downed_marines 0)
    (ai_playfight return_downed 0)
    (ai_playfight return_downed_waterfall 0)
    (ai_playfight r_downed_wrth_ext_sec-cave 0)
    (object_can_take_damage (ai_actors return_downed_marines))
    (ai_defend return_downed_marines/marines)
    (if
        (game_is_easy)
        (begin
            (sleep_until
                (<= 4 (ai_conversation_status johnson))
            )
            (ai_conversation_advance johnson)
            (effect_new_on_object_marker "cmt\effects\shared effects\teleport" johnson "")
            (sleep 10)
            (object_destroy johnson)
        )
    )
    (sleep_until
        (or
            (vehicle_test_seat_list return_downed_dump_hog w-driver (players))
            (volume_test_players_any return_downed_leaving)
        )
        1
    )
    (ai_renew return_downed_marines)
    (ai_vehicle_enterable_distance return_downed_turret 3.000000)
    (game_save_no_timeout)
    (ai_set_deaf return_downed_waterfall 0)
    (ai_braindead return_downed_waterfall 0)
    (skip_frame)
    (ai_magically_see_players return_downed_waterfall/funnel_left)
    (ai_migrate return_downed return_downed_waterfall/funnel_left_elites)
    (sleep_until
        (or
            (volume_test_players_any return_downed_funnel_left)
            (volume_test_players_any return_downed_funnel_right)
        )
        1
    )
    (ai_go_to_vehicle return_downed_waterfall/shade_pilot return_downed_turret gunner)
    (if
        (volume_test_players_any return_downed_funnel_left)
        (begin
            (ai_migrate return_downed_waterfall/funnel_right_brute_followers return_downed_waterfall/clearing_grunts)
            (ai_migrate return_downed_waterfall/funnel_right_brute_leader return_downed_waterfall/clearing_elite)
        )
    )
    (if
        (volume_test_players_any return_downed_funnel_left)
        (begin
            (ai_migrate return_downed_waterfall/funnel_left_elites return_downed_waterfall/clearing_elite)
            (ai_migrate return_downed_waterfall/funnel_left_grunts return_downed_waterfall/clearing_grunts)
        )
    )
    (sleep_until (volume_test_players_any return_downed_clearing) 1)
    (ai_migrate return_downed_waterfall/funnel_left_elites return_downed_waterfall/clearing_elite)
    (ai_migrate return_downed_waterfall/funnel_left_grunts return_downed_waterfall/clearing_grunts)
    (ai_migrate return_downed_waterfall/funnel_right_brute_followers return_downed_waterfall/clearing_grunts)
    (ai_migrate return_downed_waterfall/funnel_right_brute_leader return_downed_waterfall/clearing_elite)
    (ai_defend return_downed_waterfall/clearing)
    (ai_migrate return_downed_marines/marines return_downed_marines/assault_left)
    (sleep_until (volume_test_players_any return_downed_jump) 1)
    (ai_follow_target_players r_downed_wrth_ext_sec-cave)
    (ai_migrate return_downed_marines/marines return_downed_marines/assault_right)
    (game_save_no_timeout)
    (garbage_collect_now)
    (sleep_until (volume_test_players_any ext_cave_exit) 1)
    (game_save_no_timeout)
)


(script static void m_return_downed_startup
    (print_debug m_return_downed_startup)
    (wake m_return_downed)
    (wake m_return_downed_music)
    (set m_return_downed_music_start 1)
)


(script static void m_return_downed_cleanup
    (print_debug m_return_downed_cleanup)
    (ai_erase return_downed_waterfall)
    (ai_erase return_downed)
    (sleep -1 m_return_downed)
    (sleep -1 m_return_downed_music)
    (sleep -1 m_return_downed_music_fucker)
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_09_crashsite)
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_11_return_hogrun)
)


(script dormant m_return_cliffs_music
    (sleep_until (volume_test_players_any override_cliffs_entrance) 1)
    (music_start cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_10_return_sneaky)
    (set return_cliffs_music_started 1)
    (sleep_until
        (or
            (<= 4 (ai_status return_cart_field))
            (<= 4 (ai_status return_cart_entrance))
        )
    )
    (music_alt cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_10_return_sneaky)
    (sleep 300)
    (sleep_until (volume_test_players_any ext_cart_entrance_past))
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_10_return_sneaky)
)


(script continuous m_return_cliffs_music_fucker
    (sleep_until m_return_cliffs_music_started)
    (sleep_until
        (and
            return_cliffs_music_started
            (or
                (volume_test_players_any override_bridge_crossing)
                (volume_test_players_any ext_cart_entrance_past)
            )
        )
    )
    (music_stop cmt\sounds\music\scenarios\b30_revamp\main\b30_revamp_10_return_sneaky)
    (sleep_until
        (not
            (or
                (volume_test_players_any override_bridge_crossing)
                (volume_test_players_any ext_cart_entrance_past)
            )
        )
    )
)


(script continuous m_return_cliffs_canyon_automig
    (sleep_until m_return_cliffs_canyon_start 1)
    (sleep_until
        (= bsp_index_ext_sapp (structure_bsp_index))
        1
    )
    (ai_migrate return_cliffs_canyon/high return_cliffs_canyon_c/canyon_elite_ground_high)
    (ai_migrate return_cliffs_canyon/hole return_cliffs_canyon_c/canyon_jackals)
    (ai_migrate return_cliffs_canyon/mid return_cliffs_canyon_c/canyon_grunts_mid)
    (ai_migrate return_cliffs_canyon/low return_cliffs_canyon_c/canyon_grunts_low)
    (sleep_until
        (!= bsp_index_ext_sapp (structure_bsp_index))
        1
    )
    (ai_migrate return_cliffs_canyon_c/high return_cliffs_canyon/canyon_elite_ground_high)
    (ai_migrate return_cliffs_canyon_c/hole return_cliffs_canyon/canyon_jackals)
    (ai_migrate return_cliffs_canyon_c/mid return_cliffs_canyon/canyon_grunts_mid)
    (ai_migrate return_cliffs_canyon_c/low return_cliffs_canyon/canyon_grunts_low)
)


(script dormant m_return_cliffs_pool
    (sleep_until
        (or
            (volume_test_players_any override_pool_past)
            (volume_test_players_any override_pool_approach)
            (volume_test_players_any override_cliffs_smartass)
        )
        1
    )
    (print_debug "player looks like they're taking the cliff path")
    (game_save_no_timeout)
    (ai_place return_pool)
    (sleep_until
        (or
            (> (ai_status return_pool) 3)
            (< (ai_living_count return_pool/pool_jackal_bait) 1)
        )
        1
    )
    (ai_magically_see_players return_pool)
    (ai_migrate return_pool/pool_jackal_bait return_pool/pool_jackals)
    (sleep_until
        (or
            (volume_test_players_any override_pool_enter_side)
            (volume_test_players_any override_pool_enter_back)
            (volume_test_players_any ext_canyon_main)
        )
        1
    )
    (ai_defend return_pool)
    (if
        (or
            (< (ai_living_count return_pool/pool_elite_left) 1)
            (< (ai_living_count return_pool/pool_elite_right) 1)
        )
        (if
            (= bsp_index_ext_sapp (structure_bsp_index))
            (ai_migrate return_pool/back return_cliffs_canyon_c/pool_elites_retreat)
            (ai_migrate return_pool/back return_cliffs_canyon/pool_elites_retreat)
        )
    )
    (if
        (volume_test_players_any override_pool_enter_side)
        (ai_migrate return_pool/pool_jackals return_pool/pool_jackals_leftwall)
        (ai_migrate return_pool/pool_jackals return_pool/pool_jackals_rightwall)
    )
    (print_debug_if (volume_test_players_any override_pool_enter_side) "players heading up into canyon from left")
    (print_debug_if (volume_test_players_any override_pool_enter_back) "players heading up into canyon from right")
)

